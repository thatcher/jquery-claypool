var Claypool={Logging:{},extend:function(d,b,a){b.apply(d,a||[])}};(function(b,a){a.Logging.NullLogger=function(){var d=function(){return this};b.extend(this,{debug:d,info:d,warn:d,error:d,exception:d});return this};b.extend(a.Logging.NullLogger.prototype,{getLogger:function(){return new a.Logging.NullLogger()}})})(jQuery,Claypool);(function(b,a){a.Configuration={ioc:[],aop:[],logging:[],mvc:{"hijax:a":[],"hijax:form":[],"hijax:button":[],"hijax:event":[]},env:{dev:{},prod:{},test:{}}}})(jQuery,Claypool);(function(b,a){a.CachingStrategy$Interface={cache:null,size:null,clear:function(){throw new a.MethodNotImplementedError()},add:function(e,d){throw new a.MethodNotImplementedError()},remove:function(d){throw new a.MethodNotImplementedError()},find:function(d){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool);(function(b,a){a.SimpleCachingStrategy=function(d){b.extend(true,this,d);this.logger=new a.Logging.NullLogger();this.clear();return this};b.extend(a.SimpleCachingStrategy.prototype,a.CachingStrategy$Interface,{clear:function(){this.logger.debug("Clearing Cache.");this.cache=null;this.cache={};this.size=0},add:function(e,d){this.logger.debug("Adding To Cache: %s",e);if(!this.cache[e]){this.cache[e]=d;this.size++;return e}return null},remove:function(d){this.logger.debug("Removing From Cache id: %s",d);if(this.find(d)){return(delete this.cache[d])?--this.size:-1}return null},find:function(d){this.logger.debug("Searching Cache for id: %s",d);return this.cache[d]||null}})})(jQuery,Claypool);(function(b,a){a.Context=function(d){a.extend(this,a.SimpleCachingStrategy);b.extend(true,this,d);this.logger=new a.Logging.NullLogger()};b.extend(a.Context.prototype,a.SimpleCachingStrategy.prototype,{get:function(d){throw new a.MethodNotImplementedError()},put:function(e,d){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool);(function(b,a){a.ContextContributor=function(d){a.extend(this,a.Context);b.extend(true,this,d);this.logger=b.logger("Claypool.ContextContributor")};b.extend(a.ContextContributor.prototype,a.Context.prototype,{registerContext:function(d){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool);(function(b,a){a.Router=function(d){a.extend(this,a.SimpleCachingStrategy);b.extend(true,this,d);this.logger=a.Logging.getLogger("Claypool.Router")};b.extend(a.Router.prototype,a.SimpleCachingStrategy.prototype,{compile:function(h,e){this.logger.debug("compiling patterns for match strategies");var g,l,k;var f,d;e=e.split("|");for(f=0;f<h.length;f++){for(d=0;d<e.length;d++){g=h[f][e[d]];k=[];if(g){this.logger.debug("Compiling \n\tpattern: %s for \n\ttarget.",g);g=g.replace(/\<\:(.+?)\:\>/g,function(){var j,n=arguments[0].indexOf("(");j=arguments[0].substring(2,n);k.push(j);return arguments[0].substring(n,arguments[0].length-2)});g=g.replace(/\|\:\w+\|/g,function(){var j;j=arguments[0].substring(2,arguments[0].length-1);k.push(j);return"([\\w\\-\\.]+)"});this.add(String(b.uuid()),{pattern:new RegExp(g),payload:h[f],params:k})}}}return this},first:function(e){this.logger.debug("Using strategy 'first'");var d,g,f={};for(g in this.cache){d=this.find(g);this.logger.debug("checking pattern %s for string %s",d.pattern,e);if(d&&d.pattern&&d.pattern.test&&d.pattern.test(e)){this.logger.debug("found match for \n\tpattern: %s \n\ttarget : %s ",d.pattern,d.payload.controller||d.payload.rewrite);if(d.params&&d.params.length>0){e.replace(d.pattern,function(){var h;for(h=1;h<arguments.length-2;h++){f[d.params[h-1]]=arguments[h]}})}return[b.extend({map:f},d)]}}this.logger.debug("found no match for \n\tpattern: %s",e);return[]},all:function(e){this.logger.debug("Using strategy 'all'");var f=[];var d,h,g={};for(h in this.cache){d=this.find(h);this.logger.debug("checking pattern: %s for string %s",d.pattern,e);if(d&&d.pattern&&d.pattern.test&&d.pattern.test(e)){this.logger.debug("found match for \n\tpattern: %s \n\ttarget : %s ",d.pattern,d.payload.controller);if(d.params&&d.params.length>0){e.replace(d.pattern,function(){var j;for(j=1;j<arguments.length-2;j++){g[d.params[j-1]]=arguments[j]}})}f.push(b.extend({map:g},d))}}if(f.length===0){this.logger.debug("found no match for \n\tpattern: %s",e)}return f}})})(jQuery,Claypool);(function(b,a){a.Factory$Interface={create:function(){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool);(function(b,a){a.Configurable$Interface={configurationId:null,configuration:null,configurationUrl:null,configurationType:null,getConfig:function(){throw new a.MethodNotImplementedError()},loadConfig:function(){throw new a.MethodNotImplementedError()},setConfig:function(){throw new a.MethodNotImplementedError()},updateConfig:function(){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool);(function(b,a){a.Scanner$Interface={scan:function(){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool);(function(b,a){a.BaseFactory=function(d){a.extend(this,a.SimpleCachingStrategy);b.extend(true,this,{configurationUrl:"./app/configs/config.js",configurationType:"json"},d);this.logger=new a.Logging.NullLogger();return this};b.extend(a.BaseFactory.prototype,a.SimpleCachingStrategy.prototype,a.Factory$Interface,a.Configurable$Interface,a.Scanner$Interface,{getConfig:function(){if(!this.configuration){this.logger.debug("Configuration for <%s> has not been set explicitly or has been updated implicitly.",this.configurationId);try{this.logger.debug("$$.Configuration: \n %o",a.Configuration);if(a.Configuration[this.configurationId]){this.logger.debug("Found Claypool.Configuration");this.configuration=a.Configuration[this.configurationId]}else{if(!a.Configuration){this.loadConfig()}}}catch(d){this.logger.exception(d);throw new a.ConfigurationError(d)}}return this.configuration},loadConfig:function(d){d=d||{};this.configurationUrl=d.url||this.configurationUrl;this.logger.debug("Attempting to load configuration from: %s",this.configurationUrl);var g=this;try{jQuery.ajax({type:"Get",url:this.configurationUrl,async:false,data:{},dataType:"json",success:function(e){if(g.configurationUrl=="./app/configs/config.js"){a.Configuration=a.Configuration||{};b.extend(true,a.Configuration,e)}else{g.setConfig(g.configurationId,e?e:null)}if(d.callback){d.callback(a.Configuration)}}})}catch(f){this.logger.exception(f);throw new a.ConfigurationError(f)}},setConfig:function(e,d){this.logger.debug("Setting configuration");this.configuration=d;a.Configuration[e]=d},updateConfig:function(d){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool);(function(b,a){a.Error=function(f,d){b.extend(true,this,f||new Error());this.name=(d&&d.name?d.name:"Claypool.UnknownError")+" > Claypool.Error"+(this.name?(" > "+this.name):"");this.message=(d&&d.name?d.name:"No Message Provided \n Nested exception is:\n\t")+(this.message||"UnknownError")}})(jQuery,Claypool);(function(b,a){a.ConfigurationError=function(g,d){var f={name:"Claypool.ConfigurationError",message:"An error occured trying to locate or load the system configuration."};b.extend(this,new a.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool);(function(b,a){a.MethodNotImplementedError=function(g,d){var f={name:"Claypool.MethodNotImplementedError",message:"Method not implemented."};b.extend(this,new a.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool);(function(b,a){a.NameResolutionError=function(g,d){var f={name:"Claypool.NameResolutionError",message:"Unexpected error resolving name."};b.extend(this,new a.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool);(function(g,b){var f=[],d=0,a={},e;g.extend(a,{$:function(l,k){var h,j;if(k===undefined){h=null;for(j=0;j<f.length;j++){h=f[j]().get(l);if(h){return h}}return null}else{f[0]().put(l,k)}},register:function(j,h){if(Math.abs(h)>(f.length-1)/2){if(h===0&&g.isFunction(j.getContext)){f[0]=j.getContext}else{if(h!==0){if(g.isFunction(j.getContext)){f.push(j.getContext)
}if(g.isFunction(j.getCachedContext)){f.unshift(j.getCachedContext)}}}}},uuid:function(){return new Date().getTime()+"_"+(++d)+"_"+Math.round(Math.random()*100000000)},resolve:function(h){var o;var k;var n;var j;try{o=function(p){return this[p]};k=h.split(".");n=null;for(j=0;j<k.length;j++){n=o.call(n,k[j]);if(n===undefined){return n}}return n}catch(l){throw new b.NameResolutionError(l)}},config:function(){var h,j;if(arguments.length===0){return b.Configuration}else{if(arguments.length===1&&typeof(arguments[0])=="string"){return g.resolve("Claypool.Configuration."+arguments[0])}else{h=g.resolve("Claypool.Configuration."+arguments[0]);if(h){j=arguments[1];if(j instanceof Array){h=g.merge(h,j)}else{if(j instanceof Object){h=g.extend(true,h,j)}}}}}return this},env:function(){var j,h;if(arguments.length==2){e=g.extend(true,e||{},g.config("env."+arguments[0]),g.config("env."+arguments[1]));return e}else{if(arguments.length===0){h=g.config("env.automap");for(j in h){if(new RegExp(j).exec(window.location)){return g.env("defaults",h[j])}}}else{if(arguments.length===1&&!(typeof(arguments[0])=="string")){return g.config("env",arguments[0])}return e[arguments[0]]||null}}return null}});g.extend(b,a);g.extend(g,a)})(jQuery,Claypool);Claypool.Logging={NullLogger:null,getLogger:null};(function(b,a,d){b.extend(d,{loggerFactory:null,getLogger:function(e){if(!d.loggerFactory){d.loggerFactory=new d.Factory()}if(d.updated){d.loggerFactory.updateConfig();d.updated=false}return d.loggerFactory.create(e)}})})(jQuery,Claypool,Claypool.Logging);(function(b,a,d){d.Level={DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4}})(jQuery,Claypool,Claypool.Logging);(function(b,a,d){d.Logger$Interface={debug:function(){throw new a.MethodNotImplementedError()},info:function(){throw new a.MethodNotImplementedError()},warn:function(){throw new a.MethodNotImplementedError()},error:function(){throw new a.MethodNotImplementedError()},exception:function(){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool,Claypool.Logging);(function(b,a,d){d.NullLogger=function(){var e=function(){return this};b.extend(this,{debug:e,info:e,warn:e,error:e,exception:e})}})(jQuery,Claypool,Claypool.Logging);(function(b,a,d){d.Logger=function(f){this.category="root";this.level=null;try{b.extend(true,this,f);this.level=d.Level[this.level?this.level:"NONE"];try{this.appender=new (b.resolve(this.appender||"Claypool.Logging.ConsoleAppender"))(f)}catch(g){try{this.appender=new d.ConsoleAppender(f)}catch(g){this.appender=new d.SysOutAppender(f)}}return this}catch(g){return new d.NullLogger()}};b.extend(d.Logger.prototype,d.Logger$Interface,{debug:function(){if(this.level<=d.Level.DEBUG){this.appender.append("DEBUG",this.category,arguments);return this}else{this.debug=function(){return this}}return this},info:function(){if(this.level<=d.Level.INFO){this.appender.append("INFO",this.category,arguments);return this}else{this.debug=function(){return this}}return this},warn:function(){if(this.level<=d.Level.WARN){this.appender.append("WARN",this.category,arguments);return this}else{this.debug=function(){return this}}return this},error:function(){if(this.level<=d.Level.ERROR){this.appender.append("ERROR",this.category,arguments);return this}else{this.debug=function(){return this}}return this},exception:function(f){if(this.level<d.Level.NONE){if(f){this.appender.append("EXCEPTION",this.category,f);return this}}else{this.debug=function(){return this}}return this}})})(jQuery,Claypool,Claypool.Logging);(function(b,a,d){d.Appender$Interface={formatter:null,append:function(g,f,e){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool,Claypool.Logging);(function(b,a,d){d.SysOutAppender=function(f){var g=function(){var h=null;h.toString()};if(b.isFunction(print)&&(window.load!==undefined)&&b.isFunction(window.load)){try{g()}catch(e){if(e.rhinoException){b.extend(true,this,f);this.formatter=new d.DefaultFormatter(f);return this}}}throw new d.NoAppendersAvailableError()};b.extend(d.SysOutAppender.prototype,d.Appender$Interface,{append:function(h,f,e){switch(h){case"DEBUG":print(this.formatter.format(h,f,e));break;case"INFO":print(this.formatter.format(h,f,e));break;case"WARN":print(this.formatter.format(h,f,e));break;case"ERROR":print(this.formatter.format(h,f,e));break;case ("EXCEPTION"):var g=e&&e.rhinoException?"\n\t"+e.rhinoException.message+"\tcolumn: "+e.rhinoException.columnNumber()+"\tline: "+e.rhinoException.lineNumber():"UNKNOWN RUNTIME ERROR";print(this.formatter.format(h,f,g));break}}})})(jQuery,Claypool,Claypool.Logging);(function(b,a,d){d.ConsoleAppender=function(f){var h;try{if(window&&window.console&&window.console.log){try{if("Envjs" in window){return new d.SysOutAppender(f)}}catch(g){}b.extend(true,this,f);this.formatter=new d.FireBugFormatter(f);return this}else{return new d.SysOutAppender(f)}}catch(g){throw g}return this};b.extend(d.ConsoleAppender.prototype,d.Appender$Interface,{append:function(g,f,e){switch(g){case ("DEBUG"):console.log.apply(console,this.formatter.format(g,f,e));break;case ("INFO"):console.info.apply(console,this.formatter.format(g,f,e));break;case ("WARN"):console.warn.apply(console,this.formatter.format(g,f,e));break;case ("ERROR"):console.error.apply(console,this.formatter.format(g,f,e));break;case ("EXCEPTION"):console.error.apply(console,this.formatter.format(g,f,e.message?[e.message]:[]));console.trace();break}}})})(jQuery,Claypool,Claypool.Logging);(function(b,a,d){d.Formatter$Interface={format:function(g,e,f){throw new b.MethodNotImplementedError()}}})(jQuery,Claypool,Claypool.Logging);(function(b,a,d){d.FireBugFormatter=function(e){b.extend(true,this,e)};b.extend(d.FireBugFormatter.prototype,d.Formatter$Interface,{getDateString:function(){return" ["+new Date().toUTCString()+"] "},format:function(j,g,h){var e=g+" "+j+": "+this.getDateString();h=(h&&h.length&&(h.length>0))?h:[];var f=(h.length>0)?h[0]:null;if(typeof(f)!="string"){h.unshift(e)}else{h[0]=e+f}return h}})})(jQuery,Claypool,Claypool.Logging);(function(e,b,g){var f=/((^%|[^\\]%)(\d+)?(\.)([a-zA-Z]))|((^%|[^\\]%)([a-zA-Z]))/,a=/function ?(.*?)\(/,d=/\[object (.*?)\]/;g.DefaultFormatter=function(h){e.extend(true,this,h)};e.extend(g.DefaultFormatter.prototype,g.Formatter$Interface,{getDateString:function(){return" ["+new Date().toUTCString()+"] "},format:function(h,j,r){var k=" "+h+":  "+this.getDateString()+"{"+j+"} ";var l=[k?k:""];var q=r[0];var n=0;if(typeof(q)!="string"){q="";n=-1}var o=this.parseFormat(q);var p;for(p=0;p<o.length;++p){if(o[p]&&typeof(o[p])=="object"){o[p].appender.call(this,r[++n],l)}else{this.appendText(o[p],l)}}for(p=n+1;p<r.length;++p){this.appendText(" ",l);if(typeof(r[p])=="string"){this.appendText(r[p],l)}else{this.appendObject(r[p],l)}}return l.join("")},parseFormat:function(p){var o=[];var j={s:this.appendText,d:this.appendInteger,i:this.appendInteger,f:this.appendFloat};var n;var l;var k;var h;for(h=f.exec(p);h;h=f.exec(p)){n=h[8]?h[8]:h[5];l=n in j?j[n]:this.appendObject;k=h[3]?parseInt(h[3],10):(h[4]=="."?-1:0);o.push(p.substr(0,h[0][0]=="%"?h.index:h.index+1));o.push({appender:l,precision:k});p=p.substr(h.index+h[0].length)}o.push(p);return o},objectToString:function(h){try{return h+""}catch(j){return null}},appendText:function(h,j){j.push(this.objectToString(h))},appendNull:function(h,j){j.push(this.objectToString(h))},appendString:function(h,j){j.push(this.objectToString(h))},appendInteger:function(h,j){j.push(this.objectToString(h))},appendFloat:function(h,j){j.push(this.objectToString(h))},appendFunction:function(k,l){var h=a.exec(this.objectToString(k));var j=h?h[1]:"function";l.push(this.objectToString(j))},appendObject:function(h,k){try{if(h===undefined){this.appendNull("undefined",k)}else{if(h===null){this.appendNull("null",k)}else{if(typeof h=="string"){this.appendString(h,k)}else{if(typeof h=="number"){this.appendInteger(h,k)}else{if(typeof h=="function"){this.appendFunction(h,k)}else{if(h.nodeType==1){this.appendSelector(h,k)}else{if(typeof h=="object"){this.appendObjectFormatted(h,k)}else{this.appendText(h,k)
}}}}}}}}catch(j){}},appendObjectFormatted:function(j,l){var k=this.objectToString(j);var h=d.exec(k);l.push(h?h[1]:k)},appendSelector:function(h,j){j.push(h.nodeName.toLowerCase());if(h.id){j.push(h.id)}if(h.className){j.push(h.className)}j.push("</span>")},appendNode:function(k,l){var h;var j;var n;if(k.nodeType==1){l.push("<",k.nodeName.toLowerCase(),">");for(j=0;j<k.attributes.length;++j){h=k.attributes[j];if(!h.specified){continue}l.push(h.nodeName.toLowerCase(),'="',h.nodeValue,'"')}if(k.firstChild){for(n=k.firstChild;n;n=n.nextSibling){this.appendNode(n,html)}l.push("</",k.nodeName.toLowerCase(),">")}else{l.push("/>")}}else{if(k.nodeType==3){l.push(k.nodeValue)}}}})})(jQuery,Claypool,Claypool.Logging);(function(b,a,d){d.Factory=function(e){a.extend(this,a.BaseFactory);this.configurationId="logging";b.extend(true,this,e);this.logger=new d.Logger({category:"Claypool.Logging.Factory",level:"INFO",appender:"Claypool.Logging.ConsoleAppender"});this.attemptedConfigure=false};b.extend(d.Factory.prototype,a.BaseFactory.prototype,{create:function(h){var e,j,f,g;if(!this.configuration){if(!this.attemptedConfigure){this.logger.warn("Claypool Logging was not initalized correctly. Logging will not occur unless initialized.")}this.attemptedConfigure=true;return new d.NullLogger()}else{e=h.split(".");for(i=0;i<e.length;i++){j=e.slice(0,e.length-i).join(".");f=this.find(j);if(f!==null){f.category=h;return new d.Logger(f)}}g=this.find("root");this.logger.debug("root logging category is set to %s",g);if(g!==null){g.category=h;return new d.Logger(g)}}this.logger.warn("No Matching category: %s Please configure a root logger.",h);return new d.NullLogger()},updateConfig:function(){var k;var h;var g;try{this.logger.debug("Configuring Claypool Logging");this.clear();k=this.getConfig()||[];for(g=0;g<k.length;g++){try{h=k[g];this.add(h.category,h)}catch(f){this.logger.exception(f);return false}}}catch(j){this.logger.exception(j);throw new d.ConfigurationError(j)}return true}})})(jQuery,Claypool,Claypool.Logging);(function(b,a,d){d.ConfigurationError=function(g,f){b.extend(this,new a.ConfigurationError(g,f||{name:"Claypool.Logging.ConfigurationError",message:"An error occured trying to configure the logging system."}))}})(jQuery,Claypool,Claypool.Logging);(function(b,a,d){d.NoAppendersAvailableError=function(g,f){b.extend(this,new a.Error(g,f||{name:"Claypool.Logging.NoAppendersAvailableError",message:"An error occured trying to configure the logging system."}))}})(jQuery,Claypool,Claypool.Logging);(function(d,a,e){d.extend(d,{logger:function(f){return e.getLogger(f)},logging:function(){if(arguments.length===0){return d.config("logging")}else{e.updated=true;return d.config("logging",arguments[0])}}});var b;d.extend(d,{debug:function(){b=b||d.logger("jQuery");b.debug.apply(b,arguments);return this},info:function(){b=b||d.logger("jQuery");b.info.apply(b,arguments);return this},warn:function(){b=b||d.logger("jQuery");b.warn.apply(b,arguments);return this},error:function(){b=b||d.logger("jQuery");b.error.apply(b,arguments);return this},exception:function(){b=b||d.logger("jQuery");b.exception.apply(b,arguments);return this}})})(jQuery,Claypool,Claypool.Logging);Claypool.Application={};(function(e,b,d){var a=0;d.context=null;e.extend(d,{getContext:function(){if(!d.context){d.context=new d.Context()}return d.context},Initialize:function(f){e(document).trigger("claypool:initialize",[d]);if(f){f()}e(document).trigger("ApplicationLoaded");return d.getContext()},Reinitialize:function(f){e(document).trigger("claypool:reinitialize",[d]);if(f){f()}e(document).trigger("ApplicationReloaded");return d.getContext()}});e.register(d,a);b.Commands={}})(jQuery,Claypool,Claypool.Application);(function(d,a,b){b.Context=function(e){a.extend(this,a.Context);this.contextContributors={};d.extend(true,this,e);this.logger=d.logger("Claypool.Application.Context")};d.extend(b.Context.prototype,a.Context.prototype,{get:function(k){var h,g,f;try{f=typeof(k)=="string"&&k.indexOf("#")>-1?[k.split("#")[0],"#"+k.split("#")[1]]:["",k];if(!this.find(f[0])){this.add(f[0],new a.SimpleCachingStrategy())}this.logger.debug("Searching application context for object: %s",k);h=null;h=this.find(f[0]).find(f[1]);if(h!==null){this.logger.debug("Found object in global application context. Object id: %s",k);return h}else{this.logger.debug("Searching for object in contributed application context. Object id: %s",k);for(g in this.contextContributors){this.logger.debug("Checking Application Context Contributor %s.",g);h=this.contextContributors[g].get(k);if(h!==null){this.logger.debug("Found object in contributed application context. Object id: %s",k);return h}}}this.logger.debug("Cannot find object in any application context. Object id: %s",k);return null}catch(j){throw new b.ContextError(j)}},put:function(h,f){var g,e;g=typeof(h)=="string"&&h.indexOf("#")>-1?[h.split("#")[0],"#"+h.split("#")[1]]:["",h];e=this.find(g[0]);if(!e){e=new a.SimpleCachingStrategy();this.add(g[0],e)}if(e.find(g[0])){e.remove(g[1])}this.logger.debug("Adding object to global application context %s",h);e.add(g[1],f)}})})(jQuery,Claypool,Claypool.Application);(function(d,a,b){b.ContextContributor=function(e){a.extend(this,a.ContextContributor);d.extend(true,this,e);this.logger=d.logger("Claypool.Application.ContextContributor");return this};d.extend(b.ContextContributor.prototype,a.ContextContributor.prototype,{registerContext:function(e){this.logger.info("Registering Context id: %s",e);b.getContext().contextContributors[e]=this}})})(jQuery,Claypool,Claypool.Application);(function(d,a,b){b.Aware=function(e){d.extend(this,e);this.logger=d.logger("Claypool.Application.Aware")};d.extend(b.Aware.prototype,{$:function(){return b.getContext()}})})(jQuery,Claypool,Claypool.Application);(function(d,a,b){b.ContextError=function(h,f){var g={name:"Claypool.Application.ContextError",message:"An unexpected error occured while searching the application context."};d.extend(this,new a.Error(h,f?{name:(f.name?(f.name+" > "):"")+g.name,message:(f.message?(f.message+" \n "):"")+g.message}:g))}})(jQuery,Claypool,Claypool.Application);(function(d,a,b){d.extend(d,{app:function(){return b.getContext()},boot:function(e){b.Initialize(e);return this},reboot:function(e){b.Reinitialize(e);return this},manage:function(e,f,g){d(document).bind("claypool:initialize",function(j,h){if(!h[f]){h[f]=new (d.resolve(e))();if(h.ContextContributor&&d.isFunction(h.ContextContributor)){h[f].registerContext(e)}}else{h[f].factory.updateConfig()}if(g&&d.isFunction(g)){g(h[f])}}).bind("claypool:reinitialize",function(j,h){h[f]=new (d.resolve(e))();if(h.ContextContributor&&d.isFunction(h.ContextContributor)){h[f].registerContext(e)}if(g&&d.isFunction(g)){g(h[f])}});return this}})})(jQuery,Claypool,Claypool.Application);Claypool.AOP={};(function(d,b,a){d.manage("Claypool.AOP.Container","claypool:AOP")})(jQuery,Claypool,Claypool.AOP);(function(d,b,a){a.Aspect=function(e){this.id=null;this.type=null;b.extend(this,b.SimpleCachingStrategy);d.extend(true,this,e);this.logger=d.logger("Claypool.AOP.Aspect");this.strategy=this.strategy||"all"};d.extend(a.Aspect.prototype,b.SimpleCachingStrategy.prototype,{weave:function(){var k=this;var h;var e;if(!this.target){k.logger.warn("No pointcut was specified.  Cant weave aspect.");return}var j=function(f){var o,n,l;try{k.logger.debug("Weaving Advice %s for Aspect %s",f,k.id);k.hasPrototype=typeof(k.target.prototype)!="undefined";n=k.hasPrototype?k.target.prototype[f]:k.target[f];o=k.advise(n,k._target,f);if(!k.hasPrototype){k.target[f]=o}else{k.target.prototype[f]=o}l={pointcut:o,cutline:n,method:f,target:k._target};return l}catch(p){throw new a.WeaveError(p,"Weave")}};if(this.size===0){h=new RegExp(this[this.type?this.type:"method"]);e=this.target.prototype?this.target.prototype:this.target;for(var g in e){if(d.isFunction(e[g])&&h.test(g)){this.logger.debug("Adding aspect to method %s",g);this.add(d.uuid(),j(g));if(this.strategy==="first"){break}}}}return this},unweave:function(){var f;
try{for(var h in this.cache){f=this.find(h);if(!this.hasPrototype){this.target[this.method]=f.cutline}else{this.target.prototype[this.method]=f.cutline}this.hasPrototype=null}this.clear()}catch(g){throw new a.WeaveError(g,"Unweave")}return true},advise:function(e){throw new b.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.AOP);(function(d,b,a){a.After=function(e){b.extend(this,a.Aspect);d.extend(true,this,e);this.logger=d.logger("Claypool.AOP.After");this.type="after"};d.extend(a.After.prototype,a.Aspect.prototype,{advise:function(f,h,k){var j=this;try{return function(){var e=f.apply(this,arguments);return j.advice.apply(j,[e,h,k])}}catch(g){throw new a.AspectError(g,"After")}}})})(jQuery,Claypool,Claypool.AOP);(function(d,b,a){a.Before=function(e){b.extend(this,a.Aspect);d.extend(true,this,e);this.logger=d.logger("Claypool.AOP.Before");this.type="before"};d.extend(a.Before.prototype,a.Aspect.prototype,{advise:function(f,h,k){var j=this;try{return function(){var e=[];j.logger.debug("cutline arguments length %s",arguments.length);for(var l=0;l<arguments.length;l++){e.push(arguments[l])}e.push({target:h,method:k});j.logger.debug("applying advice to %s.%s",h,k);j.advice.apply(j,e);return f.apply(this,arguments)}}catch(g){throw new a.AspectError(g,"Before")}}})})(jQuery,Claypool,Claypool.AOP);(function(d,b,a){a.Around=function(e){b.extend(this,a.Aspect);d.extend(true,this,e);this.logger=d.logger("Claypool.AOP.Around");this.type="around"};d.extend(a.Around.prototype,a.Aspect.prototype,{advise:function(f,h,k){var j=this;try{return function(){var e={object:this,args:arguments};return j.advice.apply(j,[{object:e.object,arguments:e.args,target:h,method:k,proceed:function(){var l=f.apply(e.object,e.args);return l}}])}}catch(g){throw new a.AspectError(g,"Around")}}})})(jQuery,Claypool,Claypool.AOP);(function(d,b,a){a.Factory=function(e){b.extend(this,b.BaseFactory);d.extend(true,this,e);this.configurationId="aop";this.aspectCache=null;this.logger=d.logger("Claypool.AOP.Factory");this.aspectCache=new b.SimpleCachingStrategy()};d.extend(a.Factory.prototype,b.BaseFactory.prototype,{updateConfig:function(g){var o=this;var h;var n;var l;var k,j,f,q;try{this.logger.debug("Configuring Claypool AOP AspectFactory");h=this.getConfig()||[];this.logger.debug("AOP Configurations: %d",h.length);for(l=0;l<h.length;l++){n=h[l];if(typeof(n.target)=="string"){try{if(!d.isFunction(n.advice)){n.advice=d.resolve(n.advice)}if(n.target.match("^ref://")){k=n.target.substr(6,n.target.length);d(document).bind("claypool:ioc:"+k,function(u,w,t){o.logger.debug("Creating aspect id %s for instance %s",n.id);var e,s;s=typeof(w)=="string"&&w.indexOf("#")>-1?[w.split("#")[0],"#"+w.split("#")[1]]:["",w];if(!t.find(s[0])){t.add(s[0],new b.SimpleCachingStrategy())}e=t.find(s[0]).find(s[1]);n.literal={scope:"global",object:w};n._target=n.target;n.target=e._this;o.add(n.id,n);var r=o.create(n.id);e._this=r.target;t.find(s[0]).remove(s[1]);t.find(s[0]).add(s[1],e);o.logger.debug("Created aspect \n%s, \n%s")}).bind("claypool:predestroy:"+k,function(s,e){o.logger.debug("Destroying aspect id %s for instance %s",n.id);var r=o.aspectCache.find(n.id);if(r&&r.unweave){r.unweave()}})}else{if(n.target.match(/\.\*$/)){this.logger.debug("Broad aspect target %s",n.target);if(!g||(g.clazz.match(n.target))){j=d.resolve(n.target.substring(0,n.target.length-2));for(f in j){if(d.isFunction(j[f])){q=d.extend({},n,{id:n.id+d.uuid(),target:j[f],_target:n.target.substring(0,n.target.length-1)+f});this.logger.debug("Creating aspect id %s [%s] (%s)",n.target,f,q.id);this.add(q.id,q);this.create(q.id)}}}}else{if(!g||(g.clazz.match(n.target))){this.logger.debug("Creating aspect id %s",n.id);n._target=n.target;n.target=d.resolve(n.target);this.add(n.id,n);this.create(n.id)}}}}catch(p){this.logger.exception(p)}}}}catch(p){this.logger.exception(p);throw new a.ConfigurationError(p)}return true},create:function(o,j){var n;var f;var g=this.aspectCache.find(o);var l=this;var h=function(p){var e=null;if(p.after){e=new a.After(p)}else{if(p.before){e=new a.Before(p)}else{if(p.around){e=new a.Around(p)}}}return e.weave()};if(g){return g}else{try{this.logger.debug("Looking for configuration for aspect %s",o);n=this.find(o);if(n===undefined||n===null){this.logger.debug("%s is not an Aspect.",o);return null}else{this.logger.debug("Found configuration for instance %s",o);if(n.selector){this.logger.debug("Attaching contructor to an active selector");l=this;f=function(){g=h(n);l.aspectCache.add(n.id+"#"+this.toString(),g);return g};if(n.active){d(n.selector).livequery(f)}else{d(n.selector).each(f)}}else{g=h(n);this.aspectCache.add(o,g)}return g}}catch(k){this.logger.exception(k);throw new a.FactoryError(k)}}}})})(jQuery,Claypool,Claypool.AOP);(function(d,b,a){a.Container=function(e){b.extend(this,b.Application.ContextContributor);d.extend(true,this,e);this.factory=null;this.logger=d.logger("Claypool.AOP.Container");this.logger.debug("Configuring Claypool AOP Container");this.factory=new a.Factory(e);this.factory.updateConfig()};d.extend(a.Container.prototype,b.Application.ContextContributor.prototype,{get:function(j){var f,g;try{g=typeof(j)=="string"&&j.indexOf("#")>-1?[j.split("#")[0],"#"+j.split("#")[1]]:["",j];if(!this.find(g[0])){this.add(g[0],new b.SimpleCachingStrategy())}this.logger.debug("Search for a container managed aspect :%s",j);f=this.find(g[0]).find(g[1]);if(f===undefined||f===null){this.logger.debug("Can't find a container managed aspect :%s",j);f=this.factory.create(g[1],g[0]);if(f!==null){this.find(g[0]).add(g[1],f);return f}}else{this.logger.debug("Found container managed instance :%s",j);return f}}catch(h){this.logger.exception(h);throw new a.ContainerError(h)}return null}})})(jQuery,Claypool,Claypool.AOP);(function(d,b,a){a.ContainerError=function(h,f){var g={name:"Claypool.AOP.ContainerError",message:"An error occured inside the aop container."};d.extend(this,new b.Error(h,f?{name:(f.name?(f.name+" > "):"")+g.name,message:(f.message?(f.message+" \n "):"")+g.message}:g))}})(jQuery,Claypool,Claypool.AOP);(function(d,b,a){a.ConfigurationError=function(h,f){var g={name:"Claypool.AOP.ConfigurationError",message:"An error occured updating the aop container configuration."};d.extend(this,new b.ConfigurationError(h,f?{name:(f.name?(f.name+" > "):"")+g.name,message:(f.message?(f.message+" \n "):"")+g.message}:g))}})(jQuery,Claypool,Claypool.AOP);(function(d,b,a){a.FactoryError=function(h,f){var g={name:"Claypool.AOP.FactoryError",message:"An error occured creating the aspect from the configuration."};d.extend(this,new b.Error(h,f?{name:(f.name?(f.name+" > "):"")+g.name,message:(f.message?(f.message+" \n "):"")+g.message}:g))}})(jQuery,Claypool,Claypool.AOP);(function(d,b,a){a.WeaveError=function(h,f){var g={name:"Claypool.AOP.WeaveError",message:"An error occured weaving or unweaving the aspect."};d.extend(this,new b.Error(h,f?{name:(f.name?(f.name+" > "):"")+g.name,message:(f.message?(f.message+" \n "):"")+g.message}:g))}})(jQuery,Claypool,Claypool.AOP);(function(d,b,a){a.AspectError=function(h,f){var g={name:"Claypool.AOP.AspectError",message:"An error occured while applying an aspect."};d.extend(this,new b.Error(h,f?{name:(f.name?(f.name+" > "):"")+g.name,message:(f.message?(f.message+" \n "):"")+g.message}:g))}})(jQuery,Claypool,Claypool.AOP);(function(d,a,b){d.extend(d,{filters:function(){if(arguments.length===0){return d.config("aop")}else{return d.config("aop",arguments[0])}}})})(jQuery,Claypool,Claypool.AOP);Claypool.IoC={};(function(d,a,b){d.manage("Claypool.IoC.Container","claypool:IoC")})(jQuery,Claypool,Claypool.IoC);(function(d,a,b){b.Instance=function(f,e){d.extend(this,{_this:null,id:null,configuration:null,guid:d.uuid(),type:null,id:f,configuration:e||{},logger:d.logger("Claypool.IoC.Instance")});this.logger.category=this.logger.category+"."+this.id};d.extend(b.Instance.prototype,{precreate:function(){try{this._this={claypoolId:this.id};this.logger.debug("Precreating Instance");d(document).trigger("claypool:precreate",[this._this,this.id]);
d(document).trigger("claypool:precreate:"+this.id,[this._this]);return this}catch(f){this.logger.error("An Error occured in the Pre-Create LifeCycle Phase");this.logger.exception(f);throw new b.LifeCycleError(f)}},create:function(){var k,s,g,h;var o,r,n,q;var f,l;try{this.logger.debug("Applying Selector to Instance");if(this.configuration.selector){this._this=d(this.configuration.selector);this.logger.debug("Result for selector : ",this._this)}else{this.logger.debug("Using default empty object");this._this={}}if(this.configuration.factory){k={};if(this.configuration.factory.substring(6,0)=="ref://"){this.logger.debug("Retreiving Factory from Application Context");k=d.$(this.configuration.factory)}else{this.logger.info("Creating Instance from Factory");s=this.resolveConstructor(this.configuration.factory);retval=s.apply(k,this.configuration.options);k=retval||k}this.logger.debug("Applying factory creation method");g=this.configuration.factoryMethod||"create";o=k[g].apply(k,this.configuration.options);this._this=d.extend(true,o,this._this)}else{this.logger.info("Creating Instance simulating constructor: %s",this.configuration.clazz);n=this.resolveConstructor(this.configuration.clazz);q=this.configuration.options||[];o={};switch(q.length){case 0:o=new n();break;case 1:o=new n(q[0]);break;case 2:o=new n(q[0],q[1]);break;case 3:o=new n(q[0],q[1],q[2]);break;case 4:o=new n(q[0],q[1],q[2],q[3]);break;case 5:o=new n(q[0],q[1],q[2],q[3],q[4]);break;case 6:o=new n(q[0],q[1],q[2],q[3],q[4],q[5]);break;case 7:o=new n(q[0],q[1],q[2],q[3],q[4],q[5],q[6]);break;case 8:o=new n(q[0],q[1],q[2],q[3],q[4],q[5],q[6],q[7]);break;case 9:o=new n(q[0],q[1],q[2],q[3],q[4],q[5],q[6],q[7],q[8]);break;default:r=n.apply(o,q);o=r||o}o.$ns=this.configuration.clazz;o.$log=d.logger(o.$ns);o.$log.debug("Created new instance of %s",o.$ns);this._this=d.extend(true,o,this._this)}f=this.configuration.inject||{};for(var j in f){l=f[j];if(d.isFunction(l.substring)&&(l.substring(0,6)=="ref://")){f[j]=d.$(l.substring(6,l.length))}}d.extend(this._this,f);d(document).trigger("claypool:create",[this._this,this.id]);d(document).trigger("claypool:create:"+this.id,[this._this]);return this._this}catch(p){this.logger.error("An Error occured in the Create LifeCycle Phase");this.logger.exception(p);throw new b.LifeCycleError(p)}},postcreate:function(){try{this.logger.debug("PostCreate invoked");d(document).trigger("claypool:postcreate",[this._this,this.id]);d(document).trigger("claypool:postcreate:"+this.id,[this._this]);return this._this}catch(f){this.logger.error("An Error occured in the Post-Create LifeCycle Phase");this.logger.exception(f);throw new b.LifeCycleError(f)}},predestroy:function(){try{this.logger.debug("Predestory invoked");d(document).trigger("claypool:predestroy",[this._this,this.id]);d(document).trigger("claypool:predestroy:"+this.id,[this._this]);return this._this}catch(f){this.logger.exception(f);throw new b.LifeCycleError(f)}},destroy:function(){try{this.logger.info("Destroy invoked");d(document).trigger("claypool:destroy",[this._this,this.id]);d(document).trigger("claypool:destroy:"+this.id,[this._this]);return delete this._this}catch(f){this.logger.exception(f);throw new b.LifeCycleError(f)}},postdestroy:function(){try{this.logger.debug("Postdestory invoked");d(document).trigger("claypool:postdestroy",[this.id]);d(document).trigger("claypool:postdestroy:"+this.id);return this}catch(f){this.logger.exception(f);throw new b.LifeCycleError(f)}},resolveConstructor:function(f){var g;try{g=d.resolve(f);if(d.isFunction(g)){this.logger.debug(" Resolved "+f+" to a function");return g}else{throw new Error("Constructor is not a function: "+f)}}catch(h){this.logger.exception(h);throw new b.ConstructorResolutionError(h)}}})})(jQuery,Claypool,Claypool.IoC);(function($,$$,$$IoC){$$IoC.Factory=function(options){$$.extend(this,$$.BaseFactory);$.extend(true,this,options);this.configurationId="ioc";this.lazyLoadAttempts={};this.logger=$.logger("Claypool.IoC.Factory")};$.extend($$IoC.Factory.prototype,$$.BaseFactory.prototype,{createLifeCycle:function(instance){try{instance.precreate();instance.create();instance.postcreate()}catch(e){this.logger.error("An Error occured in the Creation Lifecycle.");this.logger.exception(e);throw new $$IoC.LifeCycleError(e)}},destroyLifeCycle:function(instance){try{instance.predestroy();instance.destroy();instance.postdestroy()}catch(e){this.logger.error("An Error occured in the Destory Lifecycle.");this.logger.exception(e);throw new $$IoC.LifeCycleError(e)}},create:function(id,namespace){var configuration,instance,_this=this,remote,folder,file,appbase,literal;try{namespace=namespace||"";if(!this.find(namespace)){this.logger.debug("Adding cache for namespace %s",namespace);this.add(namespace,new $$.SimpleCachingStrategy())}this.logger.debug("Looking for configuration for instance %s%s",namespace,id);configuration=this.find(namespace).find(id);if(configuration===null){this.logger.warn("No known configuration for instance %s%s",namespace,id);remote=id.match(/#([a-z]+([A-Z]?[a-z]+)+)([A-Z][a-z]+)+/);if(remote){_this.logger.debug("resolving lazyload %s",id);literal=[$$.Namespaces[namespace]];folder=namespace||"";literal[1]=remote.pop();literal[1]=literal[1]+"s";appbase=$.env("appbase");appbase=(appbase==null)?"/":typeof(appbase)=="string"?appbase:appbase[namespace];folder=appbase+folder+literal[1].toLowerCase()+"/";literal[2]=remote[1].substring(0,1).toUpperCase()+remote[1].substring(1);file=remote[1].toLowerCase()+".js";_this.logger.debug("attempting to lazyload %s from %s%s",id,folder,file);if(_this.lazyLoadAttempts[folder+file]){_this.logger.debug("already attempted to load %s%s",folder,file);return null}else{_this.lazyLoadAttempts[folder+file]=1;$.ajax({async:false,url:folder+file,dataType:"text",timeout:3000,success:function(text){_this.logger.info("lazyloaded %s ",literal.join("."));if(!$.env("debug")){jQuery.globalEval(text)}else{eval(text)}var config={id:id,namespace:namespace,clazz:literal.join(".")};if(literal[1]=="Views"){config.selector="#"+literal[2].substring(0,1).toLowerCase()+literal[2].substring(1)}_this.find(namespace).add(id,config);try{$$.Application["claypool:AOP"].factory.updateConfig(config)}catch(e){_this.logger.error("Failed in late binding to aop configuration").exception(e)}},error:function(xhr,status,e){_this.logger.error("failed (%s) to load %s%s",xhr.status,folder,file).exception(e)}});_this.logger.info("completed lazyloaded for %s%s ",id,namespace);return _this.create(id,namespace)}}else{_this.logger.warn("id requested did not match those applicable for late loading %s",id)}return null}else{this.logger.debug("Found configuration for instance %s%s",namespace,id);instance=new $$IoC.Instance(configuration.id,configuration);if(configuration.active&&configuration.selector){this.logger.debug("Attaching contructor to an active selector");instance.precreate();instance._this["@claypool:activeobject"]=configuration.selector;instance._this["@claypool:id"]=instance.id;jQuery(configuration.selector).livequery(function(){_this.logger.debug("Processing Creation Lifecycle.");_this.createLifeCycle(instance)},function(){_this.logger.debug("Processing Destruction Lifecycle.");_this.destroyLifeCycle(instance)})}else{this.logger.debug("Processing Creation Lifecycle.");this.createLifeCycle(instance)}return instance}}catch(e){this.logger.exception(e);throw new $$IoC.FactoryError(e)}},updateConfig:function(){var iocConfiguration;var iocconf;var i;try{this.logger.debug("Configuring Claypool IoC Factory");iocConfiguration=this.getConfig()||[];this.logger.debug("IoC Configurations: %d",iocConfiguration.length);for(i=0;i<iocConfiguration.length;i++){try{iocconf=iocConfiguration[i];if(iocconf.scan&&iocconf.factory){this.logger.debug("Scanning %s with %s",iocconf.scan,iocconf.factory);iocConfiguration=iocConfiguration.concat(iocconf.factory.scan(iocconf.scan,iocconf.namespace))}else{this.logger.debug("IoC Configuration for Id: %s%s",iocconf.namespace||"",iocconf.id);if(iocconf.namespace){if(!this.find(iocconf.namespace)){this.add(iocconf.namespace,new $$.SimpleCachingStrategy())
}this.find(iocconf.namespace).add(iocconf.id,iocconf)}else{if(!this.find("")){this.add("",new $$.SimpleCachingStrategy())}this.find("").add(iocconf.id,iocconf)}}}catch(e){this.logger.exception(e);return false}}}catch(e){this.logger.exception(e);throw new $$IoC.ConfigurationError(e)}return true}})})(jQuery,Claypool,Claypool.IoC);(function(d,a,b){b.Container=function(e){a.extend(this,a.Application.ContextContributor);d.extend(true,this,e);this.factory=null;this.logger=d.logger("Claypool.IoC.Container");this.logger.debug("Configuring Claypool IoC Container");this.factory=new b.Factory();this.factory.updateConfig()};d.extend(b.Container.prototype,a.Application.ContextContributor.prototype,{get:function(k){var f,g,j=this;try{g=typeof(k)=="string"&&k.indexOf("#")>-1?[k.split("#")[0],"#"+k.split("#")[1]]:["",k];if(!this.find(g[0])){this.add(g[0],new a.SimpleCachingStrategy())}this.logger.debug("Searching for a container managed instance :%s",k);f=this.find(g[0]).find(g[1]);if(!f){this.logger.debug("Can't find a container managed instance :%s",k);f=this.factory.create(g[1],g[0]);if(f){this.logger.debug("Storing managed instance %s in container",k);this.find(g[0]).add(g[1],f);if(f._this["@claypool:activeobject"]){d(document).bind("claypool:postcreate:"+f.id,function(l,e,n){j.logger.info("Reattached Active Object Inside IoC Container");f._this=e});d(document).bind("claypool:postdestroy:"+f.id,function(){j.logger.info("Removed Active Object Inside IoC Container");j.find(g[0]).remove(g[1])})}else{d(document).trigger("claypool:ioc",[k,this]);d(document).trigger("claypool:ioc:"+k,[k,this])}return this.find(g[0]).find(g[1])._this}}else{this.logger.debug("Found container managed instance :%s",k);return f._this}}catch(h){this.logger.exception(h);throw new b.ContainerError(h)}return null}})})(jQuery,Claypool,Claypool.IoC);(function(d,a,b){b.ContainerError=function(f){d.extend(this,new a.Error(f,{name:"Claypool.IoC.ContainerError",message:"An error occured in the ioc instance factory."}))}})(jQuery,Claypool,Claypool.IoC);(function(d,a,b){b.FactoryError=function(f){d.extend(this,new a.Error(f,{name:"Claypool.IoC.FactoryError",message:"An error occured in the ioc factory."}))}})(jQuery,Claypool,Claypool.IoC);(function(d,a,b){b.ConfigurationError=function(f){d.extend(this,new a.ConfigurationError(f,{name:"Claypool.IoC.ConfigurationError",message:"An error occured updating the ioc container configuration."}))}})(jQuery,Claypool,Claypool.IoC);(function(d,a,b){b.LifeCycleError=function(f){d.extend(this,new a.Error(f,{name:"Claypool.IoC.LifeCycleError",message:"An error occured during the lifecycle process."}))}})(jQuery,Claypool,Claypool.IoC);(function(d,a,b){b.ConstructorResolutionError=function(f){d.extend(this,new a.NameResolutionError(f,{name:"Claypool.IoC.ConstructorResolutionError",message:"An error occured trying to resolve the constructor."}))}})(jQuery,Claypool,Claypool.IoC);(function(d,a,b){a.Namespaces={};d.extend(d,{scan:function(){var f,g;if(arguments.length===0){return d.config("ioc")}else{f=[];if(d.isPlainObject(arguments[0])){for(g in arguments[0]){e(arguments[0][g],g)}}else{if(d.isArray(arguments[0])){e(arguments[0])}else{if(typeof arguments[0]=="string"){e(arguments[0])}}}return d.config("ioc",f)}function e(k,j){var h;j=j||"";if(d.isArray(k)){if(!(j in a.Namespaces)){a.Namespaces[j]=k[0].split(".")[0]}for(h=0;h<k.length;h++){f.push({scan:k[h],factory:a.MVC.Factory.prototype,namespace:j?j:null})}}else{if(!(j in a.Namespaces)){a.Namespaces[j]=k}f.push({scan:k,factory:a.MVC.Factory.prototype,namespace:j?j:null})}}},invert:function(){if(arguments.length===0){return d.config("ioc")}else{return d.config("ioc",arguments[0])}}})})(jQuery,Claypool,Claypool.IoC);Claypool.MVC={};(function(a){a.manage("Claypool.MVC.Container","claypool:MVC",function(b){var f,h,d,e=b.factory.getConfig(),g;for(g in e){b.logger.debug("eagerly loading mvc routers: %s",g);for(f=0;f<e[g].length;f++){h=e[g][f].id;controller=b.get(h);b.logger.debug("attaching mvc core controller: %s",h);if(controller&&!controller.attached){controller.attach();controller.attached=true}}}})})(jQuery);(function(d,a,b){b.View$Interface={update:function(e){throw new a.MethodNotImplementedError()},think:function(){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){b.Controller=function(e){a.extend(this,a.SimpleCachingStrategy);d.extend(true,this,e);this.logger=d.logger("Claypool.MVC.Controller")};d.extend(b.Controller.prototype,a.SimpleCachingStrategy.prototype,{handle:function(e){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){b.HijaxController=function(e){a.extend(this,b.Controller);d.extend(true,this,{forwardingList:[],selector:"",filter:"",active:true,preventDefault:true,stopPropagation:true,hijaxMap:[],resolveQueue:[],strategy:null},e);this.router=new a.Router();this.bindCache=new a.SimpleCachingStrategy();this.logger=d.logger("Claypool.MVC.HijaxController")};d.extend(b.HijaxController.prototype,b.Controller.prototype,{handle:function(j){this.logger.debug("Handling pattern: %s",j.pattern);this.forwardingList=this.router[this.strategy||"all"](j.pattern);this.logger.debug("Resolving matched paterns");var k=this,f=j.args[0],e=[],h={};for(var g=1;g<j.args.length;g++){e[g-1]=j.args[g]}if(this.forwardingList.length>0){this.logger.debug("normalizing event state params %s",f);if(d.isFunction(this.normalize)){h=this.normalize(f)}}return jQuery(this.forwardingList).each(function(){var q,o,n,l;try{k.logger.info("Forwaring to registered controller %s",this.payload.controller);q=d.$(this.payload.controller);l=this.payload.controller;n=this.payload.controller.match("Controller")?this.payload.controller.replace("Controller","View"):null;n=this.payload.controller.match("Service")?this.payload.controller.replace("Service","View"):n;this.map=d.extend(h,this.map);(function(s){var r=d.extend({},f,{m:function(){if(arguments.length===0){return m}else{if(arguments.length===1){if(typeof(arguments[0])=="string"){return m[arguments[0]]}else{if(arguments[0] instanceof Array){m.length+=arguments[0].length;Array.prototype.push.apply(m,arguments[0])}else{if(arguments[0] instanceof Object){d.extend(true,m,arguments[0])}}}}else{if(arguments.length===2){if(arguments[1] instanceof Array){if(typeof(arguments[0])=="string"&&!(arguments[0] in m)){m[arguments[0]]=[]}d.merge(m[arguments[0]],arguments[1])}else{if(arguments[1] instanceof XML||arguments[1] instanceof XMLList){m[arguments[0]]=arguments[1]}else{if(arguments[1] instanceof Object){if(typeof(arguments[0])=="string"&&!(arguments[0] in m)){m[arguments[0]]={}}d.extend(true,m[arguments[0]],arguments[1])}}}}}}return this},v:function(t){if(!t){return v}if(t&&typeof(t)=="string"){t=t.split(".");if(t.length===1){v=t}else{if(t.length===2){if(t[0]!==""){v=t.join(".")}else{v=v.split(".")[0]+"."+t[1]}}}}return this},c:function(){var w,u,t;if(arguments.length===0){return c}else{if(arguments.length>0&&typeof(arguments[0])=="string"){if(arguments.length>1&&d.isPlainObject(arguments[1])){s.map=d.extend(true,s.map||{},arguments[1])}w=arguments[0].split(".");v=w[0].match("Controller")?w[0].replace("Controller","View"):null;v=w[0].match("Service")?w[0].replace("Service","View"):v;u=(w.length>1&&w[1].length>0)?w[1]:"handle";t=k.find(w[0]);if(t===null){t=d.$(w[0]);k.add(w[0],t)}t[u||"handle"].apply(t,[this].concat(e))}}return this},render:k.renderer(),reset:function(){m={flash:[],length:0};v=n;c=l;m.reset=function w(){m={flash:[],length:0};m.reset=w;return r};v.reset=function t(){v=n;v.reset=t;return r};c.reset=function u(){c=l;c.reset=u;return r};return this},params:function(t){if(arguments.length===0){return s.map?s.map:{}}else{return(s.map&&(t in s.map))?s.map[t]:null}}});r.reset();q[s.payload.action||"handle"].apply(q,[r].concat(e))})(this)}catch(p){p=p?p:new Error();if(p.name&&p.name.indexOf("Claypool.Application.ContextError")>-1){k.logger.warn("No controller with id: %s",this.payload.controller)}else{k.logger.exception(p);
throw p}}})},attach:function(){this.router.compile(this.hijaxMap,this.routerKeys);var e=this;if(this.active&&(this.selector!==""||this.filter!=="")){this.logger.debug("Actively Hijaxing %s's %s%s",this.hijaxKey,this.selector,this.filter);d(this.selector+this.filter).livequery(function(){e.hijax(this)})}else{if(this.selector!==""||this.filter!==""){this.logger.debug("Hijaxing Current %s's.",this.hijaxKey);d(this.selector+this.filter).each(function(){e.hijax(this)})}else{if(document!==undefined){this.logger.debug("Hijaxing Document For %s's.",this.hijaxKey);e.hijax(document)}else{this.logger.warn("Unable to attach controller: %s",options.id)}}}},hijax:function(f){this.logger.debug("Hijaxing %s: %s",this.hijaxKey,f);var g=this;var e=function(h){var j=true;g.logger.info("Hijaxing %s: ",g.hijaxKey);if(g.stopPropagation){g.logger.debug("Stopping propogation of event");h.stopPropagation()}if(g.preventDefault){g.logger.debug("Preventing default event behaviour");h.preventDefault();j=false}g.handle({pattern:g.target.apply(g,arguments),args:arguments,normalize:g.normalize?g.normalize:function(){return{}}});return j};if(this.event){d(this.event.split("|")).each(function(){d(f).bind(this+"."+g.eventNamespace,e);g.logger.debug("Binding event %s to hijax controller on target",this,f)})}else{d(this.hijaxMap).each(function(){if(this.event&&!g.bindCache.find(this.event)){g.bindCache.add(this.event,g);g.logger.debug("Binding event %s to controller %s on target %s",this.event,this.controller,f);d(f).bind(this.event+"."+g.eventNamespace,e)}})}return true},renderer:function(){var f=this;var e=[];return function(p){var o,h,l,g,j,k;if(p&&d.isFunction(p)){e.push(p)}f.logger.debug(" - Resolving Control - %s)",this.c());try{g=this.v();j=d.isFunction(this.write)?(d.isFunction(d.render)?"write":"render"):"update";if(g.indexOf(".")>-1){j=g.split(".");g=j[0];j=j[j.length-1]}f.logger.debug("Calling View %s.%s",g,j);g=d.$(g);if(g){if(d.isFunction(g[j])){switch(j){case"write":case"writeln":this[j](g[j](this.m(),this));break;case"render":g.write=this.write;g.writeln=this.writeln;g[j](this.m(),this);break;default:g[j](this.m(),this)}f.logger.debug("Cascading callbacks");while(e.length>0){(e.pop())()}}else{if(g["@claypool:activeobject"]){k="claypool:postcreate:"+g["@claypool:id"]+"."+d.uuid();d(document).bind(k,function(q,r){f.logger.warn("The view is reattached to the dom.");d(document).unbind(k);r.update(this.m());f.logger.debug("Cascading callbacks");while(e.length>0){(e.pop())()}})}else{f.logger.debug("View method cannot be resolve",j)}}}else{f.logger.warn("Cant resolve view %s. ",this.v())}}catch(n){f.logger.error("Error resolving flow %s => %s",this.c(),this.v()).exception(n);throw n}return this}},target:function(e){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){b.Factory=function(e){a.extend(this,a.IoC.Factory);d.extend(true,this,e);this.configurationId="mvc";this.logger=d.logger("Claypool.MVC.Factory");this.add("",new a.SimpleCachingStrategy())};d.extend(b.Factory.prototype,a.IoC.Factory.prototype,{updateConfig:function(){var j,f,h,l,g;try{this.logger.debug("Configuring Claypool MVC Controller Factory");j=this.getConfig()||{};d(document).trigger("claypool:hijax",[this,this.initializeHijaxController,j])}catch(k){this.logger.exception(k);throw new b.ConfigurationError(k)}},scan:function(h,k){var l=this.logger||d.logger("Claypool.MVC.Factory");var g,q,f=[],o,p=function(e,r){return("#"+e.substring(0,1).toLowerCase()+e.substring(1)+r.substring(0,r.length-1))},j=function(e){return("#"+e.substring(0,1).toLowerCase()+e.substring(1))};k=k||"";l.debug("Scanning %s%s",k,h);try{if(h.split(".").length==1){q=d.resolve(h);for(g in q){l.debug("Scan Checking %s.%s",h,g);if(d.isPlainObject(q[g])){l.debug("Scan Following %s.%s",h,g);f.push(this.scan(h+"."+g,k))}}}else{if(h.split(".").length==2){q=d.resolve(h);for(g in q){l.debug("Scan Checking %s.%s",h,g);if(d.isFunction(q[g])){l.debug("Configuring by Convention %s.%s",h,g);config={id:p(g,h.split(".")[1]),clazz:h+"."+g,namespace:k};if(h.match(".Views")){config.selector=j(g)}f.push(config)}}}else{if(h.split(".").length==3){q=d.resolve(h);if(d.isFunction(q)){l.debug("Appending to Configuration by Convention %s",h);config={id:p(g,h.split(".")[2]),clazz:h,namespace:k};if(h.match(".Views")){config.selector=j(g)}f.push(config)}}}}}catch(n){l.error("Error Scanning %s!!",h).exception(n)}return f},initializeHijaxController:function(j,h,f,e){var k,g;if(j[h]){for(g=0;g<j[h].length;g++){k={};k.id=j[h][g].id;k.clazz=f;k.options=[d.extend(true,{},e,j[h][g])];this.logger.debug("Adding MVC Configuration for Controller Id: %s",k.id);this.find("").add(k.id,k)}}}})})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){b.Container=function(e){a.extend(this,a.Application.ContextContributor);d.extend(true,this,e);this.factory=null;this.logger=d.logger("Claypool.MVC.Container").debug("Configuring Claypool MVC Container");this.factory=new b.Factory();this.factory.updateConfig()};d.extend(b.Container.prototype,a.Application.ContextContributor.prototype,{get:function(j){var f,g;try{this.logger.debug("Search for a container managed controller : %s",j);g=typeof(j)=="string"&&j.indexOf("#")>-1?[j.split("#")[0],"#"+j.split("#")[1]]:["",j];if(!this.find(g[0])){this.add(g[0],new a.SimpleCachingStrategy())}f=this.find(g[0]).find(g[1]);if(f===undefined||f===null){this.logger.debug("Can't find a container managed controller : %s",j);f=this.factory.create(g[1],g[0]);if(f!==null){this.find(g[0]).add(g[1],f);return f._this}else{return null}}else{this.logger.debug("Found container managed controller : %s",j);return f._this}}catch(h){this.logger.exception(h);throw new b.ContainerError()}throw new b.FactoryError(j)}})})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){b.ContainerError=function(f){d.extend(this,new a.Error(f,{name:"Claypool.MVC.ContainerError",message:"An error occurred trying to retreive a container managed object."}))}})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){b.FactoryError=function(f){d.extend(this,new a.Error(f,{name:"Claypool.MVC.FactoryError",message:"An error occured trying to create the factory object."}))}})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){b.ConfigurationError=function(f){d.extend(this,new a.ConfigurationError(f,{name:"Claypool.MVC.ConfigurationError",message:"An error occured during the configuration."}))}})(jQuery,Claypool,Claypool.MVC);(function(e,a,b){var d;e.extend(e,{router:function(g,f){e(document).bind("claypool:hijax",function(h,l,j,k){d=d||e.logger("Claypool.MVC.Plugins");d.debug("registering router plugin: %s",g);j.apply(l,[k,g,"Claypool.MVC.HijaxController",f])});return this},mvc:function(){var g,f;if(arguments.length===0){return e.config("mvc")}else{f=e.config("mvc");for(g in arguments[0]){if(g in f){e.merge(f[g],arguments[0][g])}else{f[g]=arguments[0][g]}}return this}}});e.routes=e.mvc;e.router("hijax:a",{selector:"a",event:"click",strategy:"first",routerKeys:"urls",hijaxKey:"link",eventNamespace:"Claypool:MVC:HijaxLinkController",target:function(g){var f=g.target||g.currentTarget;while(f.tagName.toUpperCase()!="A"){f=e(f).parent()[0]}return e(f).attr("href")},normalize:function(h){var g=h.target||h.currentTarget,j={};while(g.tagName.toUpperCase()!="A"){g=e(g).parent()[0]}var f=e(g).attr("href");var k=f.split("?");k=k&&k.length>1?k[1]:"";e(k.split("&")).each(function(o,r){var p=r.split("="),l=p[0],q=p[1],n;if(l in j){if(!e.isArray(j[l])){n=j[l];j[l]=[n]}j[l].push(q)}else{j[l]=q}});return j}}).router("hijax:button",{selector:":button",event:"click",strategy:"all",routerKeys:"ids",hijaxKey:"button",eventNamespace:"Claypool:MVC:HijaxButtonController",target:function(f){return f.target.id},normalize:function(f){return{}}}).router("hijax:input",{selector:"input",event:"blur|focus",strategy:"all",routerKeys:"ids",hijaxKey:"input",eventNamespace:"Claypool:MVC:HijaxInputController",target:function(f){return f.target.id},normalize:function(f){var g={};g[f.target.name]=f.target.value;return g}}).router("hijax:form",{selector:"form",event:"submit",strategy:"first",routerKeys:"urls",hijaxKey:"form",eventNamespace:"Claypool:MVC:HijaxFormController",target:function(f){return f.target.action
},normalize:function(f){var h={},g=e(f.target).serializeArray();e(g).each(function(l,j){var k;if(j.name in h){if(!e.isArray(h[j.name])){k=h[j.name];h[j.name]=[]}h[j.name].push(j.value)}else{h[j.name]=j.value}});return h}}).router("hijax:event",{strategy:"all",routerKeys:"event",hijaxKey:"event",eventNamespace:"Claypool:MVC:HijaxEventController",target:function(f){return f.type},normalize:function(f){return{}}});e.mvc_scanner=b.Factory.prototype})(jQuery,Claypool,Claypool.MVC);Claypool.Models={};Claypool.Configuration.index=[];(function(d,a,b){b.Model=function(g,e,f){d.extend(true,this,b.Factory(f));d.extend(this,{name:g,fields:e})};d.extend(b.Model.prototype,{validate:function(k){var h=[],g=k.data,l,f,e,o;if(k.batch){e=[];for(l=0;l<g.length;l++){o=g[l].$id;this.validate(d.extend({},k,{data:g[l],batch:false,success:function(j){j.$id=o;e.push(j)},error:function(j,p){h.push(p)}}))}if(h.length===0){g=e}}else{for(var n in this.fields){if(g[n]===undefined&&this.fields[n].generate){g[n]=this.fields[n].generate()}if(this.fields[n].not){for(l=0;l<this.fields[n].not.length;l++){if(g[n] instanceof Array){for(f=0;f<g[n].length;f++){if(g[n][f]===this.fields[n].not[l]){h[h.length]={index:f,field:n,value:g[n][f],msg:this.fields[n].msg}}}}else{if(g[n]===this.fields[n].not[l]){h[h.length]={value:g[n],field:n,msg:this.fields[n].msg}}}}}if(this.fields[n].pattern&&(g[n]!==undefined)){if(g[n] instanceof Array){for(f=0;f<g[n].length;f++){if(!this.fields[n].pattern.test(g[n][f])){h[h.length]={index:f,field:n,value:g[n][f],msg:this.fields[n].msg}}}}else{if(!this.fields[n].pattern.test(g[n])){h[h.length]={value:g[n],field:n,msg:this.fields[n].msg}}}}}}if(h.length>0&&k.error&&d.isFunction(k.error)){k.error(g,h)}else{if(k.success&&d.isFunction(k.success)){if(k.serialize){g=this.serialize(g)}k.success(g)}}return this},serialize:function(e){var j={},h,f;for(var g in e){if((this.fields[g]!==undefined||"__anything__" in this.fields||g=="$id")&&!d.isFunction(e[g])){if(this.fields[g]&&this.fields[g].type){if(this.fields[g].type=="json"){j[g]=jsPath.js2json(e[g])}else{if(this.fields[g].type=="html"){j[g]=d("<div/>").append(d(e[g]).clone()).html()}else{if(this.fields[g].type=="xmllist"){j[g]=e[g].toString()}}}}else{j[g]=e[g]}}}return j},deserialize:function(e){var g={};for(var f in this.fields){if((e[f]!==undefined||"__anything__" in this.fields)&&!d.isFunction(e[f])){if(this.fields[f].type){if(this.fields[f].type=="json"){g[f]=d.json2js(e[f])}else{if(this.fields[f].type=="html"){g[f]=d(e[f])}else{if(this.fields[f].type=="xmllist"){g[f]=new XMLList(e[f])}}}}else{serialized[f]=e[f]}}}return g}});d.each(["create","destroy","metadata","save","add","remove","get","find","js2query","next","previous"],function(e,f){b.Model.prototype[f]=function(g){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.Models);(function(h,l,d){var f;d.Query=function(p){if(typeof(p)=="string"){p={context:p}}h.extend(true,this,{context:"",selectors:[],expressions:[],orderby:{direction:"forward"},limit:0,startPage:0,resultsPerPage:20},p);f=h.logger("Claypool.Models.Query")};var n=d.Query;h.extend(n.prototype,{items:function(p){if(p&&(typeof p=="string")){this.selectors.push(p)}else{if(p&&p.length&&(p instanceof Array)){h.merge(this.selectors,p)}else{this.selectors.push("*")}}return this},names:function(){return this.items("itemName()")},count:function(){return this.items("count()")},is:function(p){a(this,"=");o(this,p);return this},isnot:function(p){a(this,"!=");o(this,p);return this},islike:function(p){a(this,"~");o(this,p);return this},isnotlike:function(p){a(this,"!~");o(this,p);return this},isgt:function(p){a(this,">");o(this,p);return this},isgte:function(p){a(this,">=");o(this,p);return this},isbetween:function(p){a(this,"><");o(this,p);return this},islte:function(p){a(this,"<=");o(this,p);return this},islt:function(p){a(this,"<");o(this,p);return this},isin:function(p){a(this,"@");o(this,p);return this},isnotin:function(p){a(this,"!@");o(this,p);return this},orderby:function(p){g(this,p);return this},reverseorderby:function(p){g(this,p,"reverse");return this},limit:function(p){this.limit=p},page:function(q,p){if(p){this.count=p}this.startPage=q;return this},next:function(p){this.startPage++;return this},previous:function(p){this.startPage--;return this}});var e=["","like","gt","gte","between","lte","lt"];for(var j=0;j<e.length;j++){n.prototype["where"+e[j]]=function(p){b(this,p,"where","");return this};n.prototype["wherenot"+e[j]]=function(p){b(this,p,"where","not");return this};n.prototype["whereeither"+e[j]]=function(p){b(this,p,"either","");return this};n.prototype["whereneither"+e[j]]=function(p){b(this,p,"either","not");return this};n.prototype["and"+e[j]]=function(p){b(this,p,"and","");return this};n.prototype["andnot"+e[j]]=function(p){b(this,p,"and","not");return this};n.prototype["or"+e[j]]=function(p){b(this,p,"or","");return this};n.prototype["ornot"+e[j]]=function(p){b(this,p,"or","not");return this}}var b=function(r,u,q,p,s){var t=null;p=p?p:"is";if(r&&u&&q&&h.isFunction(r[q])){if(q=="where"){r.expressions=[];q="and"}else{if(q=="whereeither"||q=="whereneither"){r.expressions=[];q="or"}}if(typeof u=="string"){r.expressions.push({name:u,type:q})}else{if(u&&typeof(u)=="object"&&!(u instanceof Array)){for(t in u){if(typeof(u[t])=="string"){if(s){r[q](t)["isnot"+p](u[t])}else{r[q](t)["isnot"+p](u[t])}}else{if(p===""&&u[t]&&u[t].length&&u[t] instanceof Array){if(s){r[q](t).isnotin(u[t])}else{r[q](t).isin(u[t])}}}}}}}};var a=function(q,p){q.expressions[q.expressions.length-1].operator=p};var o=function(q,p){q.expressions[q.expressions.length-1].value=p};var k=function(q,p){q.expressions[q.expressions.length-1].name=p};var g=function(q,p,r){q.orderby={name:p,direction:(r||"forward")}}})(jQuery,Claypool,Claypool.Models);(function(d,a,b){b.Client=function(e){d.extend(true,this,e)};d.each(["create","destroy","metadata","save","update","remove","get","find","js2query","next","previous"],function(e,f){b.Client.prototype[f]=function(g){this.db[f](d.extend(g,{domain:this.name}));return this}})})(jQuery,Claypool,Claypool.Models);(function(f,a,d){var b;d.RestClient=function(h){this.js2json=f&&f.js2json&&f.isFunction(f.js2json)?f.js2json:h.js2json;this.json2js=f&&f.json2js&&f.isFunction(f.json2js)?f.json2js:h.json2js;f.extend(true,this,h);this.resturl=f.env("resturl")?f.env("resturl"):"/rest/";b=f.logger("Claypool.Models.RestClient")};f.extend(d.RestClient.prototype,{create:function(h){f.ajax(f.extend({},h,{type:"PUT",url:this.resturl+this.name+"/",dataType:"json",success:function(j){e("created data domain (%s)",h.success,j)},error:function(l,j,k){g("failed to create data domain",h.error,l,j,k)}}));return this},destroy:function(h){f.ajax(f.extend({},h,{type:"DELETE",url:this.resturl+this.name+"/",dataType:"json",success:function(j){e("destroyed data domain",h.success,j)},error:function(l,j,k){g("failed to destroy data domain",h.error,l,j,k)}}));return this},save:function(h){var k,j;if(!h.batch&&h.id){if(h.serialize){h.data=this.serialize(h.data)}f.ajax(f.extend({},h,{type:h.update?"POST":"PUT",url:(this.resturl+this.name+"/"+h.id),data:this.js2json(h.data),contentType:"application/json",dataType:"json",processData:false,success:function(l){e("saved data to domain",h.success,l)},error:function(o,l,n){g("failed to save data to domain",h.error,o,l,n)}}))}else{if(h.batch){if(h.serialize){for(j=0;j<h.data.length;j++){h.data[j]=this.serialize(h.data[j])}}f.ajax(f.extend({},h,{type:h.update?"POST":"PUT",url:(this.resturl+this.name+"/"),data:this.js2json(h.data),contentType:"application/json",processData:false,dataType:"json",success:function(l){e("saved batch data to domain",h.success,l)},error:function(o,l,n){g("failed to save batch data to domain",h.error,o,l,n)}}))}}return this},update:function(h){this.save(f.extend({},h,{update:true}));return this},remove:function(h){if(h.id){f.ajax(f.extend({},h,{type:"DELETE",url:this.resturl+this.name+"/"+h.id,data:(h.data instanceof Array)?{data:h.data.join(",")}:(h.data instanceof Object)?h.data:null,dataType:"json",success:function(j){e("removed item or item data from domain",h.success,j)
},error:function(l,j,k){g("failed to delete item or item data from domain",h.error,l,j,k)}}))}return this},get:function(h){var j,k={limit:h.limit?Number(h.limit):1000,start:h.start?Number(h.start):1,offset:h.offset?Number(h.offset):0,from:h.from?h.from:""};if(h.id&&typeof h.id=="string"){f.ajax(f.extend({},h,{type:"GET",url:this.resturl+this.name+"/"+h.id,dataType:"json",data:k,success:function(l){e("retrieved data by id from domain",h.success,l)},error:function(o,l,n){g("failed to retrieved data by id from domain",h.error,o,l,n)}}))}else{if(h.id&&h.id.length){j=h.id.join(",");f.ajax(f.extend({},h,{type:j.length>1024?"POST":"GET",url:this.resturl+this.name+"/",data:f.extend(k,{id:j}),dataType:"json",success:function(l){e("successfully for data by ids from domain",h.success,l)},error:function(o,l,n){g("failed to get data by ids from domain",h.error,o,l,n)}}))}else{f.ajax(f.extend({},h,{type:"GET",url:this.resturl+this.name+"/",dataType:"json",data:k,success:function(l){e("loaded list of ids from domain",h.success,l)},error:function(o,l,n){g("failed to list ids from domain ",h.error,o,l,n)}}))}}return this},find:function(h){if(h.select){if(typeof h.select=="object"){if(!(h.select instanceof d.Query)){h.select=new d.Query(h.select)}h.select.context=this.name}f.ajax(f.extend({},h,{type:"POST",url:this.resturl,data:(typeof h.select=="string")?h.select:this.js2json(f.extend(h.data||{},h.select)),contentType:(typeof h.select=="string")?"text/plain":"application/json",processData:false,dataType:"json",success:function(j){e("saved item to domain",h.success,j)},error:function(l,j,k){g("failed to save item to domain",h.error,l,j,k)}}))}else{b.debug("performing simple parameter search");f.ajax(f.extend({},h,{type:"GET",url:this.resturl,dataType:"json",success:function(j){e("performed search",h.success,j)},error:function(l,j,k){g("error performing search",h.error,l,j,k)}}))}return this},next:function(h){this.find(query.next(),callback);return this},previous:function(h){this.find(query.previous(),callback);return this}});var e=function(k,l,h,j){b.debug("loaded list of items from domain: %s",h);if(l&&f.isFunction(l)){l(h,j)}};var g=function(l,n,k,h,j){b.error(l+" %s-%s",k.status,h).exception(j);if(n&&f.isFunction(n)){n([{msg:l}],true)}}})(jQuery,Claypool,Claypool.Models);(function(e,a,d){var b;d.Factory=function(h){h=h||{};b=b||e.logger("Claypool.Models.Factory");var g,f;var k=h&&h.dbclient?h.dbclient:e.env("dbclient");if(!k){k="rest"}b.debug("loading database client connection %s",k);if(k=="rest"){k=new d.RestClient(h)}else{try{g=h&&h.db?h.db:e.env("db");f=h&&h.dbconnection?h.dbconnection:e.env("dbconnection");b.debug("loading database implementation %s",g);if(typeof(g)=="string"){b.debug("resolving database implementation %s",g);g=e.resolve(g)}k=new d.Client(e.extend({db:new g(f)},h))}catch(j){b.error("direct connection not available",j).exception(j);k=new d.RestClient(h)}}return k}})(jQuery,Claypool,Claypool.Models);(function(d,a,b){d.extend(d,{db:function(e){return new b.Factory(e)},model:function(g,e,f){return new b.Model(g,e,f)},query:function(e){return new b.Query(e)},index:function(){if(arguments.length===0){return d.config("index")}else{return d.config("index",arguments[0])}}})})(jQuery,Claypool,Claypool.Models);Claypool.Server={};(function(e,a,d){var b;e.router("hijax:server",{event:"claypool:serve",strategy:"first",routerKeys:"urls",hijaxKey:"request",eventNamespace:"Claypool:Server:HijaxServerController",target:function(h,g,f){b=b||e.logger("Claypool.Server");b.debug("targeting request event");h.request=g;h.response=f;h.write=function(j){b.debug("writing response.body : %s",j);f.body=j+"";return this};h.writeln=function(j){b.debug("writing line to response.body : %s",j);f.body+=j+"";return this};return g.requestURL+""},normalize:function(f){return e.extend({},f.request.parameters,{parameters:f.request.parameters,method:f.request.method,body:f.request.body,headers:e.extend(f.response.headers,f.request.headers)})}});a.Services={}})(jQuery,Claypool,Claypool.Server);(function(d,a,b){b.Servlet=function(e){a.extend(this,a.MVC.Controller);d.extend(true,this,e);this.logger=d.logger("Claypool.Server.Servlet")};d.extend(b.Servlet.prototype,a.MVC.Controller.prototype,{handle:function(e){var f=e.params("method").toUpperCase();e.params("headers").status=200;this.logger.debug("Handling %s request",f);switch(f){case"GET":this.handleGet(e,e.response);break;case"POST":this.handlePost(e,e.response);break;case"PUT":this.handlePut(e,e.response);break;case"DELETE":this.handleDelete(e,e.response);break;case"HEAD":this.handleHead(e,e.response);break;case"OPTIONS":this.handleOptions(e,e.response);break;default:this.logger.debug("Unknown Method: %s, rendering error response.",f);this.handleError(e,"Unknown Method: "+f,new Error())}},handleGet:function(e){throw new a.MethodNotImplementedError()},handlePost:function(e){throw new a.MethodNotImplementedError()},handlePut:function(e){throw new a.MethodNotImplementedError()},handleDelete:function(e){throw new a.MethodNotImplementedError()},handleHead:function(e){throw new a.MethodNotImplementedError()},handleOptions:function(e){throw new a.MethodNotImplementedError()},handleError:function(f,h,g){this.logger.warn("The default error response should be overriden");f.headers.status=300;f.response.body=h?h:"Unknown internal error\n";f.response.body+=g&&g.msg?g.msg+"":(g?g+"":"\nUnpsecified Error.")}})})(jQuery,Claypool,Claypool.Server);(function(f,b,e,h){var d;h.RestServlet=function(j){b.extend(this,h.Servlet);f.extend(true,this,e.Factory(j));d=f.logger("Claypool.Server.RestServlet");this.js2json=f.js2json&&f.isFunction(f.js2json)?f.js2json:j.js2json;this.json2js=f.json2js&&f.isFunction(f.json2js)?f.json2js:j.json2js};f.extend(h.RestServlet.prototype,h.Servlet.prototype,{handleGet:function(l){var q=this,o=l.params("domain"),p=l.params("id"),n=l.params("q"),k=p?p.split(","):[],j;d.debug("Handling GET for %s %s",o,p);if(n){d.debug("finding results with url constructed query %o",l.params());this.db.find(f.extend({data:l.params("values"),async:false,success:function(r){a(l,r,q)},error:function(t,r,s){g(l,result,q)}},l.params()))}else{if(!o&&!p){this.db.get(f.extend({async:false,success:function(r){a(l,r,q)},error:function(r){g(l,r,q)}},l.params()))}else{if(o&&(k.length>1||!p)){d.debug("Handling GET for %s %s",o,k);if(k.length>1){this.db.get(f.extend(l.params(),{id:k,domain:o,async:false,success:function(r){a(l,r,q)},error:function(r){g(l,r,q)}}))}else{d.debug("getting list of item ids for domain %s",o,p);this.db.get(f.extend({domain:o,async:false,success:function(r){a(l,r,q)},error:function(r){g(l,r,q)}},l.params()))}}else{if(o&&p&&p!="metadata"){this.db.get({domain:o,id:p,async:false,dataType:"text",success:function(r){a(l,r,q)},error:function(r){g(l,r,q)}})}else{if(o&&p&&p=="metadata"){this.db.metadata({domain:o,id:p,async:false,dataType:"text",success:function(r){a(l,r,q)},error:function(r){g(l,r,q)}})}}}}}},handlePost:function(n){var r=this,p=n.params("domain"),q=n.params("id"),k,l,j,o;d.debug("Handling POST for %s %s",p,q).debug("Reading POST body %s",n.body);if(p&&q){if(!n.params("body")){k=q.split(",");this.db.get(f.extend(n.params(),{id:k,domain:p,async:false,success:function(s){a(n,s,r)},error:function(s){g(n,s,r)}}))}else{d.debug("updating single object",n.request.body);l=this.json2js(n.request.body);this.db.update({domain:p,id:q,data:l,async:false,success:function(s){a(n,s,r)},error:function(s){g(n,s,r)}})}}else{if(p&&!q){d.debug("updating array of objects (bulk save)");j=this.json2js(n.request.body);this.db.update({domain:p,data:j,async:false,batch:true,success:function(s){a(n,s,r)},error:function(s){g(n,s,r)}})}else{if(!p&&!q){o=n.request.body;if(n.request.contentType.match("application/json")){o=this.json2js(o)}d.debug("executing query \n%s",o);this.db.find(f.extend({select:o,async:false,success:function(s){a(n,s,r)},error:function(s){g(n,s,r)}},n.params()))}}}},handlePut:function(j){var l=this,k=j.params("id");domain=j.params("domain");
d.debug("Handling PUT for %s %s",domain);if(domain&&k){d.debug("saving single object",j.request.body);item=this.json2js(j.request.body);this.db.save({domain:domain,id:k,data:item,async:false,success:function(n){a(j,n,l)},error:function(n){g(j,n,l)}})}else{if(domain&&j.request.body){d.debug("saving array of objects (bulk save)");items=this.json2js(j.request.body);this.db.save({domain:domain,data:items,async:false,batch:true,success:function(n){a(j,n,l)},error:function(n){g(j,n,l)}})}else{if(domain){this.db.create({domain:domain,async:false,success:function(n){a(j,n,l)},error:function(n){g(j,n,l)}})}}}},handleDelete:function(j){var n=this,k=j.params("domain"),l=j.params("id");d.debug("Handling DELETE for %s %s",k,l);if(k&&l){this.db.remove({domain:k,id:l,async:false,success:function(o){a(j,o,n)},error:function(o){g(j,o,n)}})}else{if(k&&!l){this.db.destroy({domain:k,async:false,success:function(o){a(j,o,n)},error:function(o){g(j,o,n)}})}}}});var a=function(l,k,n){var j=n.js2json(k,null,"   ");d.debug("succeeded. %s",j);l.response.headers={status:200,"Content-Type":"text/javascript; charset=utf-8"};l.response.body=j};var g=function(l,k,n){var j=n.js2json(k,null,"    ");d.error("failed. %s",j);l.response.headers={status:k.code?k.code:500,"Content-Type":"text/javascript; charset=utf-8"};l.response.body=j?j:"{'error':{'code'  : 500,'type'  : 'UnknownClaypoolRestError','msg'   : 'unknown error, check network'}}"}})(jQuery,Claypool,Claypool.Models,Claypool.Server);(function(e,a,d){var b;d.WebProxyServlet=function(g){a.extend(this,d.Servlet);this.rewriteMap=null;e.extend(true,this,g);b=e.logger("Claypool.Server.WebProxyServlet");this.router=new a.Router();this.strategy=this.strategy||"first";b.debug("Compiling url rewrites %s.",this.rewriteMap);this.router.compile(this.rewriteMap,"urls")};e.extend(d.WebProxyServlet.prototype,d.Servlet.prototype,{handleGet:function(k,h){var j=f.route(request,this);var g=j.proxyURL,l=j.params;if(g&&g.length&&g.length>0){b.debug("Proxying get request to: %s",g[0].payload.rewrite);e.ajax({type:"GET",dataType:"text",async:false,data:l,url:g[0].payload.rewrite+"",beforeSend:function(n){f.beforeSend(k.request,h,n)},success:function(n){f.success(h,n)},error:function(p,n,o){f.error(h,p,n,o)},complete:function(o,n){f.complete(h,g,o,n)}})}return h},handlePost:function(k,h){var j=f.route(k.request,this);var g=j.proxyURL,l=j.params;if(g&&g.length&&g.length>0){b.debug("Proxying post request to: %s",g[0].payload.rewrite);e.ajax({type:"POST",dataType:"text",async:false,data:l,url:g[0].payload.rewrite+"",beforeSend:function(n){f.beforeSend(k.request,h,n)},success:function(n){f.success(h,n)},error:function(p,n,o){f.error(h,p,n,o)},complete:function(o,n){f.complete(h,g,o,n)}})}return h}});var f={route:function(k,j){b.debug("Handling proxy: %s",k.requestURI);var h=j.router[j.strategy||"all"](k.requestURI);k.headers["Claypool-Proxy"]=j.proxyHost||"127.0.0.1";var l={};for(var n in k.parameters){b.debug("request.parameters[%s]=%s",n,k.parameters[n]);l[n+""]=k.parameters[n]+""}var g=(k.body&&k.body.length)?k.body:"";return{proxyURL:h,params:l,body:g}},beforeSend:function(h,g,j){b.debug("Copying Request headers for Proxied Request");for(var k in h.headers){b.debug("Setting proxied request header %s: %s",k,h.headers[k]);j.setRequestHeader(k,h.headers[k])}g.headers={}},success:function(g,h){b.debug("Got response for proxy \n %s.",h);g.body=h+""},error:function(h,k,g,j){b.error("Error proxying request. STATUS: %s",g?g:"UNKNOWN");if(j){b.exception(j)}h.body=k.responseText+""},complete:function(j,n,q,k){b.debug("Proxy Request Complete, Copying response headers");var g=q.getAllResponseHeaders();var h;var o;b.debug("Complete Proxy response header: \n %s",g);g=g.split("\r\n");for(var l=0;l<g.length;l++){o=g[l].split(":");try{b.debug("setting response header %s %s",o[0],o.join(":"));j.headers[o.shift()]=o.join(":")}catch(p){b.warn("Unable to set a proxied response header");b.exception(p)}}b.debug("response status (%s)",q.status);j.headers.status=Number(q.status);j.headers["Claypool-Proxy"]=n[0].payload.rewrite+"";j.headers["Content-Encoding"]=n[0].payload.contentEncoding||"";j.headers["Transfer-Encoding"]=n[0].payload.transferEncoding||"";if(n[0].payload.contentType){j.headers["Content-Type"]=n[0].payload.contentType+""}}}})(jQuery,Claypool,Claypool.Server);(function(e,b,f){var d,a;f.Manage=function(g){e.extend(true,this,g);d=e.logger("Claypool.Services.Manage");a=b.Models.Factory()};e.extend(f.Manage.prototype,{handle:function(g){var j=g.params("command"),h=g.params("target");d.debug("handling command %s %s",j,h);b.Commands[j](h,g);if(("reset"==j)||("syncdb"==j)){d.debug("forwarding to rest service");g.response.headers={status:302,Location:"/rest/"}}}});e.extend(true,b.Commands,{reset:function(h){var g;a.get({async:false,success:function(j){g=j.domains;d.debug("loaded domains")},error:function(l,j,k){d.error("failed to get db domains")}});e(g).each(function(j,k){a.destroy({domain:k,async:false,success:function(l){d.info("destroyed domain %s",k)},error:function(o,l,n){d.error("failed to delete domain %s",k)}})})},syncdb:function(g){var k,h=e.env("initialdata")+"dump.json?"+e.uuid(),j;d.info("loading initial data from %s",h);e.ajax({type:"get",async:false,url:h,dataType:"text",success:function(l){k=e.json2js(l);d.info("loaded initial data")},error:function(o,l,n){d.error("failed [%s] to load initial data %s",l,n)}});for(j in k){a.create({domain:j,async:false,success:function(l){d.info("created domain %s",j)}});a.save({async:false,batch:true,domain:j,data:k[j],success:function(){d.info("batch save successful %s ",j)},error:function(){d.error("batch save failed %s",j)}})}},dumpdata:function(h,j){var k={};var g;a.get({async:false,success:function(l){g=l.domains;d.debug("loaded domains")},error:function(o,l,n){d.error("failed to get db domains")}});e(g).each(function(l,n){a.find({select:"new Query('"+n+"')",async:false,success:function(o){d.info("found %s entries in %s",o.data.length,n);k[n]=o.data},error:function(q,o,p){ok(false,"failed load entries from %s",n)}})});j.write(e.js2json(k,null,"    "));j.response.headers={status:200,"Content-Type":"application/json"}}})})(jQuery,Claypool,Claypool.Services);(function(d,a,b){})(jQuery,Claypool,Claypool.Server);(function(f,b,e){var d,a;f.extend(f,{serve:function(h,g){var k;d=d||f.logger("Claypool.Server");d.info("Handling global request routing for request: %s ",h.requestURL).debug("Dispatching request to Server Sevlet Container");g.headers={};f.extend(g.headers,{"Content-Type":"text/html; charset=utf-8",status:-1});g.body="";try{d.debug("serving request event");f(document).trigger("claypool:serve",[h,g]);d.debug("finished serving request event");if(g.headers.status===-1){g.headers.status=200;if(!g.body){g.headers.status=404;g.body="<html><head></head><body><h1>jQuery-Claypool Server Error</h1>";g.body+="<p>Not Found :\n\t"+h.requestURL+"</p></body></html>"}}}catch(j){d.error("Error Handling Request.").exception(j);g.headers["Content-Type"]="text/html; charset=utf-8";g.headers.status=500;g.body="<html><head></head><body><h1>jQuery-Claypool Server Error</h1>";g.body+="<h2>Error Details</h2>";for(k in j){g.body+="<strong>"+k+"</strong><br/><span>"+j[k]+"</span><br/>"}g.body+="<h2>General Request Details</h2>";for(k in h){g.body+="<strong>"+k+"</strong><br/><span>"+h[k]+"</span><br/>"}g.body+="<h2>Request Header Details</h2>";for(k in h.headers){g.body+="<strong>"+k+"</strong><br/><span>"+h.headers[k]+"</span><br/>"}g.body+="</body></html>"}},servlet:function(g){d=d||f.logger("Claypool.Server");d.debug("Applying servlet pattern to %s",g);b.extend(g,e.Servlet)},proxy:function(g){return f.invert([{id:g.id||"proxy_"+f.uuid(),clazz:"Claypool.Server.WebProxyServlet",options:[{rewriteMap:g.rewrites}]}])}});ClaypoolServerHandler=f.serve})(jQuery,Claypool,Claypool.Server);