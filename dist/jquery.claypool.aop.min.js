Claypool.AOP={};(function(c,b,a){c.manage("Claypool.AOP.Container","claypool:AOP")})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Aspect=function(d){this.id=null;this.type=null;b.extend(this,b.SimpleCachingStrategy);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.Aspect");this.strategy=this.strategy||"all"};c.extend(a.Aspect.prototype,b.SimpleCachingStrategy.prototype,{weave:function(){var i=this;var g;var d;if(!this.target){i.logger.warn("No pointcut was specified.  Cant weave aspect.");return}var h=function(f){var l,k,j;i.logger.debug("Weaving Advice %s for Aspect %s",f,i.id);i.hasPrototype=typeof(i.target.prototype)!="undefined";k=i.hasPrototype?i.target.prototype[f]:i.target[f];l=i.advise(k,i._target,f);if(!i.hasPrototype){i.target[f]=l}else{i.target.prototype[f]=l}j={pointcut:l,cutline:k,method:f,target:i._target};return j};if(this.size===0){g=new RegExp(this[this.type?this.type:"method"]);d=this.target.prototype?this.target.prototype:this.target;for(var e in d){if(c.isFunction(d[e])&&g.test(e)){this.logger.debug("Adding aspect to method %s",e);this.add(b.uuid(),h(e));if(this.strategy==="first"){break}}}}return this},unweave:function(){var d;for(var e in this.cache){d=this.find(e);if(!this.hasPrototype){this.target[this.method]=d.cutline}else{this.target.prototype[this.method]=d.cutline}this.hasPrototype=null}this.clear();return true},advise:function(d){throw"MethodNotImplementedError"}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.After=function(d){b.extend(this,a.Aspect);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.After");this.type="after"};c.extend(a.After.prototype,a.Aspect.prototype,{advise:function(d,e,g){var f=this;return function(){var h=d.apply(this,arguments);return f.advice.apply(f,[h,e,g])}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Before=function(d){b.extend(this,a.Aspect);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.Before");this.type="before"};c.extend(a.Before.prototype,a.Aspect.prototype,{advise:function(d,e,g){var f=this;return function(){var h=[];f.logger.debug("cutline arguments length %s",arguments.length);for(var j=0;j<arguments.length;j++){h.push(arguments[j])}h.push({target:e,method:g});f.logger.debug("applying advice to %s.%s",e,g);f.advice.apply(f,h);return d.apply(this,arguments)}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Around=function(d){b.extend(this,a.Aspect);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.Around");this.type="around"};c.extend(a.Around.prototype,a.Aspect.prototype,{advise:function(d,e,g){var f=this;return function(){var h={object:this,args:arguments};return f.advice.apply(f,[{object:h.object,arguments:h.args,target:e,method:g,proceed:function(){var i=d.apply(h.object,h.args);return i}}])}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Factory=function(d){b.extend(this,b.BaseFactory);c.extend(true,this,d);this.configurationId="aop";this.aspectCache=null;this.logger=c.logger("Claypool.AOP.Factory");this.aspectCache=new b.SimpleCachingStrategy()};c.extend(a.Factory.prototype,b.BaseFactory.prototype,{updateConfig:function(e){var l=this;var f;var k;var j;var h,g,d,m;this.logger.debug("Configuring Claypool AOP AspectFactory");f=this.getConfig()||[];this.logger.debug("AOP Configurations: %d",f.length);for(j=0;j<f.length;j++){k=f[j];if(typeof(k.target)=="string"){if(!c.isFunction(k.advice)){k.advice=c.resolve(k.advice)}if(k.target.match("^ref://")){h=k.target.substr(6,k.target.length);c(document).bind("claypool:ioc:"+h,function(q,r,p){l.logger.debug("Creating aspect id %s for instance %s",k.id);var i,o;o=typeof(r)=="string"&&r.indexOf("#")>-1?[r.split("#")[0],"#"+r.split("#")[1]]:["",r];if(!p.find(o[0])){p.add(o[0],new b.SimpleCachingStrategy())}i=p.find(o[0]).find(o[1]);k.literal={scope:"global",object:r};k._target=k.target;k.target=i._this;l.add(k.id,k);var n=l.create(k.id);i._this=n.target;p.find(o[0]).remove(o[1]);p.find(o[0]).add(o[1],i);l.logger.debug("Created aspect \n%s, \n%s")}).bind("claypool:predestroy:"+h,function(o,i){l.logger.debug("Destroying aspect id %s for instance %s",k.id);var n=l.aspectCache.find(k.id);if(n&&n.unweave){n.unweave()}})}else{if(k.target.match(/\.\*$/)){this.logger.debug("Broad aspect target %s",k.target);if(!e||(e.clazz.match(k.target))){g=c.resolve(k.target.substring(0,k.target.length-2));for(d in g){if(c.isFunction(g[d])){m=c.extend({},k,{id:k.id+b.uuid(),target:g[d],_target:k.target.substring(0,k.target.length-1)+d});this.logger.debug("Creating aspect id %s [%s] (%s)",k.target,d,m.id);this.add(m.id,m);this.create(m.id)}}}}else{if(!e||(e.clazz.match(k.target))){this.logger.debug("Creating aspect id %s",k.id);k._target=k.target;k.target=c.resolve(k.target);this.add(k.id,k);this.create(k.id)}}}}}return true},create:function(j,g){var i;var d;var e=this.aspectCache.find(j);var h=this;var f=function(l){var k=null;if(l.after){k=new a.After(l)}else{if(l.before){k=new a.Before(l)}else{if(l.around){k=new a.Around(l)}}}return k.weave()};if(e){return e}else{this.logger.debug("Looking for configuration for aspect %s",j);i=this.find(j);if(i===undefined||i===null){this.logger.debug("%s is not an Aspect.",j);return null}else{this.logger.debug("Found configuration for instance %s",j);if(i.selector){this.logger.debug("Attaching contructor to an active selector");h=this;d=function(){e=f(i);h.aspectCache.add(i.id+"#"+this.toString(),e);return e};if(i.active){c(i.selector).livequery(d)}else{c(i.selector).each(d)}}else{e=f(i);this.aspectCache.add(j,e)}return e}}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Container=function(d){b.extend(this,b.Application.ContextContributor);c.extend(true,this,d);this.factory=null;this.logger=c.logger("Claypool.AOP.Container");this.logger.debug("Configuring Claypool AOP Container");this.factory=new a.Factory(d);this.factory.updateConfig()};c.extend(a.Container.prototype,b.Application.ContextContributor.prototype,{get:function(f){var d,e;e=typeof(f)=="string"&&f.indexOf("#")>-1?[f.split("#")[0],"#"+f.split("#")[1]]:["",f];if(!this.find(e[0])){this.add(e[0],new b.SimpleCachingStrategy())}this.logger.debug("Search for a container managed aspect :%s",f);d=this.find(e[0]).find(e[1]);if(d===undefined||d===null){this.logger.debug("Can't find a container managed aspect :%s",f);d=this.factory.create(e[1],e[0]);if(d!==null){this.find(e[0]).add(e[1],d);return d}}else{this.logger.debug("Found container managed instance :%s",f);return d}return null}})})(jQuery,Claypool,Claypool.AOP);(function(c,a,b){c.extend(c,{filters:function(){if(arguments.length===0){return c.config("aop")}else{return c.config("aop",arguments[0])}}})})(jQuery,Claypool,Claypool.AOP);