Claypool.AOP={};(function(c,b,a){c.manage("Claypool.AOP.Container","claypool:AOP")})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Aspect=function(d){this.id=null;this.type=null;b.extend(this,b.SimpleCachingStrategy);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.Aspect");this.strategy=this.strategy||"all"};c.extend(a.Aspect.prototype,b.SimpleCachingStrategy.prototype,{weave:function(){var i=this;var g;var d;if(!this.target){i.logger.warn("No pointcut was specified.  Cant weave aspect.");return}var h=function(f){var l,k,j;try{i.logger.debug("Weaving Advice %s for Aspect %s",f,i.id);i.hasPrototype=typeof(i.target.prototype)!="undefined";k=i.hasPrototype?i.target.prototype[f]:i.target[f];l=i.advise(k,i._target,f);if(!i.hasPrototype){i.target[f]=l}else{i.target.prototype[f]=l}j={pointcut:l,cutline:k,method:f,target:i._target};return j}catch(m){throw new a.WeaveError(m,"Weave")}};if(this.size===0){g=new RegExp(this[this.type?this.type:"method"]);d=this.target.prototype?this.target.prototype:this.target;for(var e in d){if(c.isFunction(d[e])&&g.test(e)){this.logger.debug("Adding aspect to method %s",e);this.add(b.uuid(),h(e));if(this.strategy==="first"){break}}}}return this},unweave:function(){var d;try{for(var g in this.cache){d=this.find(g);if(!this.hasPrototype){this.target[this.method]=d.cutline}else{this.target.prototype[this.method]=d.cutline}this.hasPrototype=null}this.clear()}catch(f){throw new a.WeaveError(f,"Unweave")}return true},advise:function(d){throw new b.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.After=function(d){b.extend(this,a.Aspect);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.After");this.type="after"};c.extend(a.After.prototype,a.Aspect.prototype,{advise:function(d,g,i){var h=this;try{return function(){var e=d.apply(this,arguments);return h.advice.apply(h,[e,g,i])}}catch(f){throw new a.AspectError(f,"After")}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Before=function(d){b.extend(this,a.Aspect);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.Before");this.type="before"};c.extend(a.Before.prototype,a.Aspect.prototype,{advise:function(d,g,i){var h=this;try{return function(){var e=[];h.logger.debug("cutline arguments length %s",arguments.length);for(var j=0;j<arguments.length;j++){e.push(arguments[j])}e.push({target:g,method:i});h.logger.debug("applying advice to %s.%s",g,i);h.advice.apply(h,e);return d.apply(this,arguments)}}catch(f){throw new a.AspectError(f,"Before")}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Around=function(d){b.extend(this,a.Aspect);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.Around");this.type="around"};c.extend(a.Around.prototype,a.Aspect.prototype,{advise:function(d,g,i){var h=this;try{return function(){var e={object:this,args:arguments};return h.advice.apply(h,[{object:e.object,arguments:e.args,target:g,method:i,proceed:function(){var j=d.apply(e.object,e.args);return j}}])}}catch(f){throw new a.AspectError(f,"Around")}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Factory=function(d){b.extend(this,b.BaseFactory);c.extend(true,this,d);this.configurationId="aop";this.aspectCache=null;this.logger=c.logger("Claypool.AOP.Factory");this.aspectCache=new b.SimpleCachingStrategy()};c.extend(a.Factory.prototype,b.BaseFactory.prototype,{updateConfig:function(f){var m=this;var g;var l;var k;var j,h,d,o;try{this.logger.debug("Configuring Claypool AOP AspectFactory");g=this.getConfig()||[];this.logger.debug("AOP Configurations: %d",g.length);for(k=0;k<g.length;k++){l=g[k];if(typeof(l.target)=="string"){try{if(!c.isFunction(l.advice)){l.advice=c.resolve(l.advice)}if(l.target.match("^ref://")){j=l.target.substr(6,l.target.length);c(document).bind("claypool:ioc:"+j,function(r,s,q){m.logger.debug("Creating aspect id %s for instance %s",l.id);var e,p;p=typeof(s)=="string"&&s.indexOf("#")>-1?[s.split("#")[0],"#"+s.split("#")[1]]:["",s];if(!q.find(p[0])){q.add(p[0],new b.SimpleCachingStrategy())}e=q.find(p[0]).find(p[1]);l.literal={scope:"global",object:s};l._target=l.target;l.target=e._this;m.add(l.id,l);var i=m.create(l.id);e._this=i.target;q.find(p[0]).remove(p[1]);q.find(p[0]).add(p[1],e);m.logger.debug("Created aspect \n%s, \n%s")}).bind("claypool:predestroy:"+j,function(p,e){m.logger.debug("Destroying aspect id %s for instance %s",l.id);var i=m.aspectCache.find(l.id);if(i&&i.unweave){i.unweave()}})}else{if(l.target.match(/\.\*$/)){this.logger.debug("Broad aspect target %s",l.target);if(!f||(f.clazz.match(l.target))){h=c.resolve(l.target.substring(0,l.target.length-2));for(d in h){if(c.isFunction(h[d])){o=c.extend({},l,{id:l.id+b.uuid(),target:h[d],_target:l.target.substring(0,l.target.length-1)+d});this.logger.debug("Creating aspect id %s [%s] (%s)",l.target,d,o.id);this.add(o.id,o);this.create(o.id)}}}}else{if(!f||(f.clazz.match(l.target))){this.logger.debug("Creating aspect id %s",l.id);l._target=l.target;l.target=c.resolve(l.target);this.add(l.id,l);this.create(l.id)}}}}catch(n){this.logger.exception(n)}}}}catch(n){this.logger.exception(n);throw new a.ConfigurationError(n)}return true},create:function(l,h){var k;var d;var f=this.aspectCache.find(l);var j=this;var g=function(m){var e=null;if(m.after){e=new a.After(m)}else{if(m.before){e=new a.Before(m)}else{if(m.around){e=new a.Around(m)}}}return e.weave()};if(f){return f}else{try{this.logger.debug("Looking for configuration for aspect %s",l);k=this.find(l);if(k===undefined||k===null){this.logger.debug("%s is not an Aspect.",l);return null}else{this.logger.debug("Found configuration for instance %s",l);if(k.selector){this.logger.debug("Attaching contructor to an active selector");j=this;d=function(){f=g(k);j.aspectCache.add(k.id+"#"+this.toString(),f);return f};if(k.active){c(k.selector).livequery(d)}else{c(k.selector).each(d)}}else{f=g(k);this.aspectCache.add(l,f)}return f}}catch(i){this.logger.exception(i);throw new a.FactoryError(i)}}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Container=function(d){b.extend(this,b.Application.ContextContributor);c.extend(true,this,d);this.factory=null;this.logger=c.logger("Claypool.AOP.Container");this.logger.debug("Configuring Claypool AOP Container");this.factory=new a.Factory(d);this.factory.updateConfig()};c.extend(a.Container.prototype,b.Application.ContextContributor.prototype,{get:function(h){var d,f;try{f=typeof(h)=="string"&&h.indexOf("#")>-1?[h.split("#")[0],"#"+h.split("#")[1]]:["",h];if(!this.find(f[0])){this.add(f[0],new b.SimpleCachingStrategy())}this.logger.debug("Search for a container managed aspect :%s",h);d=this.find(f[0]).find(f[1]);if(d===undefined||d===null){this.logger.debug("Can't find a container managed aspect :%s",h);d=this.factory.create(f[1],f[0]);if(d!==null){this.find(f[0]).add(f[1],d);return d}}else{this.logger.debug("Found container managed instance :%s",h);return d}}catch(g){this.logger.exception(g);throw new a.ContainerError(g)}return null}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.ContainerError=function(g,d){var f={name:"Claypool.AOP.ContainerError",message:"An error occured inside the aop container."};c.extend(this,new b.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.ConfigurationError=function(g,d){var f={name:"Claypool.AOP.ConfigurationError",message:"An error occured updating the aop container configuration."};c.extend(this,new b.ConfigurationError(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.FactoryError=function(g,d){var f={name:"Claypool.AOP.FactoryError",message:"An error occured creating the aspect from the configuration."};c.extend(this,new b.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.WeaveError=function(g,d){var f={name:"Claypool.AOP.WeaveError",message:"An error occured weaving or unweaving the aspect."};
c.extend(this,new b.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.AspectError=function(g,d){var f={name:"Claypool.AOP.AspectError",message:"An error occured while applying an aspect."};c.extend(this,new b.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,a,b){c.extend(c,{filters:function(){if(arguments.length===0){return c.config("aop")}else{return c.config("aop",arguments[0])}}})})(jQuery,Claypool,Claypool.AOP);