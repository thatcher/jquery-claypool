var Claypool={Logging:{},extend:function(c,b,a){b.apply(c,a||[])}};(function(b,a){a.Logging.NullLogger=function(){var c=function(){return this};b.extend(this,{debug:c,info:c,warn:c,error:c,exception:c});return this};b.extend(a.Logging.NullLogger.prototype,{getLogger:function(){return new a.Logging.NullLogger()}})})(jQuery,Claypool);(function(b,a){a.Configuration={ioc:[],aop:[],logging:[],mvc:{"hijax:a":[],"hijax:form":[],"hijax:button":[],"hijax:event":[]},env:{dev:{},prod:{},test:{}}}})(jQuery,Claypool);(function(b,a){a.CachingStrategy$Interface={cache:null,size:null,clear:function(){throw new a.MethodNotImplementedError()},add:function(d,c){throw new a.MethodNotImplementedError()},remove:function(c){throw new a.MethodNotImplementedError()},find:function(c){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool);(function(b,a){a.SimpleCachingStrategy=function(c){b.extend(true,this,c);this.logger=new a.Logging.NullLogger();this.clear();return this};b.extend(a.SimpleCachingStrategy.prototype,a.CachingStrategy$Interface,{clear:function(){this.logger.debug("Clearing Cache.");this.cache=null;this.cache={};this.size=0},add:function(d,c){this.logger.debug("Adding To Cache: %s",d);if(!this.cache[d]){this.cache[d]=c;this.size++;return d}return null},remove:function(c){this.logger.debug("Removing From Cache id: %s",c);if(this.find(c)){return(delete this.cache[c])?--this.size:-1}return null},find:function(c){this.logger.debug("Searching Cache for id: %s",c);return this.cache[c]||null}})})(jQuery,Claypool);(function(b,a){a.Context=function(c){a.extend(this,a.SimpleCachingStrategy);b.extend(true,this,c);this.logger=new a.Logging.NullLogger()};b.extend(a.Context.prototype,a.SimpleCachingStrategy.prototype,{get:function(c){throw new a.MethodNotImplementedError()},put:function(d,c){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool);(function(b,a){a.ContextContributor=function(c){a.extend(this,a.Context);b.extend(true,this,c);this.logger=b.logger("Claypool.ContextContributor")};b.extend(a.ContextContributor.prototype,a.Context.prototype,{registerContext:function(c){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool);(function(b,a){a.Router=function(c){a.extend(this,a.SimpleCachingStrategy);b.extend(true,this,c);this.logger=a.Logging.getLogger("Claypool.Router")};b.extend(a.Router.prototype,a.SimpleCachingStrategy.prototype,{compile:function(g,d){this.logger.debug("compiling patterns for match strategies");var f,k,h;var e,c;d=d.split("|");for(e=0;e<g.length;e++){for(c=0;c<d.length;c++){f=g[e][d[c]];h=[];if(f){this.logger.debug("Compiling \n\tpattern: %s for \n\ttarget.",f);f=f.replace(/\<\:(.+?)\:\>/g,function(){var j,l=arguments[0].indexOf("(");j=arguments[0].substring(2,l);h.push(j);return arguments[0].substring(l,arguments[0].length-2)});f=f.replace(/\|\:\w+\|/g,function(){var j;j=arguments[0].substring(2,arguments[0].length-1);h.push(j);return"([\\w\\-\\.]+)"});this.add(String(b.uuid()),{pattern:new RegExp(f),payload:g[e],params:h})}}}return this},first:function(d){this.logger.debug("Using strategy 'first'");var c,f,e={};for(f in this.cache){c=this.find(f);this.logger.debug("checking pattern %s for string %s",c.pattern,d);if(c&&c.pattern&&c.pattern.test&&c.pattern.test(d)){this.logger.debug("found match for \n\tpattern: %s \n\ttarget : %s ",c.pattern,c.payload.controller||c.payload.rewrite);if(c.params&&c.params.length>0){d.replace(c.pattern,function(){var g;for(g=1;g<arguments.length-2;g++){e[c.params[g-1]]=arguments[g]}})}return[b.extend({map:e},c)]}}this.logger.debug("found no match for \n\tpattern: %s",d);return[]},all:function(d){this.logger.debug("Using strategy 'all'");var e=[];var c,g,f={};for(g in this.cache){c=this.find(g);this.logger.debug("checking pattern: %s for string %s",c.pattern,d);if(c&&c.pattern&&c.pattern.test&&c.pattern.test(d)){this.logger.debug("found match for \n\tpattern: %s \n\ttarget : %s ",c.pattern,c.payload.controller);if(c.params&&c.params.length>0){d.replace(c.pattern,function(){var h;for(h=1;h<arguments.length-2;h++){f[c.params[h-1]]=arguments[h]}})}e.push(b.extend({map:f},c))}}if(e.length===0){this.logger.debug("found no match for \n\tpattern: %s",d)}return e}})})(jQuery,Claypool);(function(b,a){a.Factory$Interface={create:function(){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool);(function(b,a){a.Configurable$Interface={configurationId:null,configuration:null,configurationUrl:null,configurationType:null,getConfig:function(){throw new a.MethodNotImplementedError()},loadConfig:function(){throw new a.MethodNotImplementedError()},setConfig:function(){throw new a.MethodNotImplementedError()},updateConfig:function(){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool);(function(b,a){a.Scanner$Interface={scan:function(){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool);(function(b,a){a.BaseFactory=function(c){a.extend(this,a.SimpleCachingStrategy);b.extend(true,this,{configurationUrl:"./app/configs/config.js",configurationType:"json"},c);this.logger=new a.Logging.NullLogger();return this};b.extend(a.BaseFactory.prototype,a.SimpleCachingStrategy.prototype,a.Factory$Interface,a.Configurable$Interface,a.Scanner$Interface,{getConfig:function(){if(!this.configuration){this.logger.debug("Configuration for <%s> has not been set explicitly or has been updated implicitly.",this.configurationId);try{this.logger.debug("$$.Configuration: \n %o",a.Configuration);if(a.Configuration[this.configurationId]){this.logger.debug("Found Claypool.Configuration");this.configuration=a.Configuration[this.configurationId]}else{if(!a.Configuration){this.loadConfig()}}}catch(c){this.logger.exception(c);throw new a.ConfigurationError(c)}}return this.configuration},loadConfig:function(c){c=c||{};this.configurationUrl=c.url||this.configurationUrl;this.logger.debug("Attempting to load configuration from: %s",this.configurationUrl);var f=this;try{jQuery.ajax({type:"Get",url:this.configurationUrl,async:false,data:{},dataType:"json",success:function(e){if(f.configurationUrl=="./app/configs/config.js"){a.Configuration=a.Configuration||{};b.extend(true,a.Configuration,e)}else{f.setConfig(f.configurationId,e?e:null)}if(c.callback){c.callback(a.Configuration)}}})}catch(d){this.logger.exception(d);throw new a.ConfigurationError(d)}},setConfig:function(d,c){this.logger.debug("Setting configuration");this.configuration=c;a.Configuration[d]=c},updateConfig:function(c){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool);(function(b,a){a.Error=function(d,c){b.extend(true,this,d||new Error());this.name=(c&&c.name?c.name:"Claypool.UnknownError")+" > Claypool.Error"+(this.name?(" > "+this.name):"");this.message=(c&&c.name?c.name:"No Message Provided \n Nested exception is:\n\t")+(this.message||"UnknownError")}})(jQuery,Claypool);(function(b,a){a.ConfigurationError=function(f,c){var d={name:"Claypool.ConfigurationError",message:"An error occured trying to locate or load the system configuration."};b.extend(this,new a.Error(f,c?{name:(c.name?(c.name+" > "):"")+d.name,message:(c.message?(c.message+" \n "):"")+d.message}:d))}})(jQuery,Claypool);(function(b,a){a.MethodNotImplementedError=function(f,c){var d={name:"Claypool.MethodNotImplementedError",message:"Method not implemented."};b.extend(this,new a.Error(f,c?{name:(c.name?(c.name+" > "):"")+d.name,message:(c.message?(c.message+" \n "):"")+d.message}:d))}})(jQuery,Claypool);(function(b,a){a.NameResolutionError=function(f,c){var d={name:"Claypool.NameResolutionError",message:"Unexpected error resolving name."};b.extend(this,new a.Error(f,c?{name:(c.name?(c.name+" > "):"")+d.name,message:(c.message?(c.message+" \n "):"")+d.message}:d))}})(jQuery,Claypool);(function(f,b){var e=[],c=0,a={},d;f.extend(a,{$:function(k,j){var g,h;if(j===undefined){g=null;for(h=0;h<e.length;h++){g=e[h]().get(k);if(g){return g}}return null}else{e[0]().put(k,j)}},register:function(h,g){if(Math.abs(g)>(e.length-1)/2){if(g===0&&f.isFunction(h.getContext)){e[0]=h.getContext}else{if(g!==0){if(f.isFunction(h.getContext)){e.push(h.getContext)
}if(f.isFunction(h.getCachedContext)){e.unshift(h.getCachedContext)}}}}},uuid:function(){return new Date().getTime()+"_"+(++c)+"_"+Math.round(Math.random()*100000000)},resolve:function(g){var m;var j;var l;var h;try{m=function(n){return this[n]};j=g.split(".");l=null;for(h=0;h<j.length;h++){l=m.call(l,j[h]);if(l===undefined){return l}}return l}catch(k){throw new b.NameResolutionError(k)}},config:function(){var g,h;if(arguments.length===0){return b.Configuration}else{if(arguments.length===1&&typeof(arguments[0])=="string"){return f.resolve("Claypool.Configuration."+arguments[0])}else{g=f.resolve("Claypool.Configuration."+arguments[0]);if(g){h=arguments[1];if(h instanceof Array){g=f.merge(g,h)}else{if(h instanceof Object){g=f.extend(true,g,h)}}}}}return this},env:function(){var h,g;if(arguments.length==2){d=f.extend(true,d||{},f.config("env."+arguments[0]),f.config("env."+arguments[1]));return d}else{if(arguments.length===0){g=f.config("env.automap");for(h in g){if(new RegExp(h).exec(window.location)){return f.env("defaults",g[h])}}}else{if(arguments.length===1&&!(typeof(arguments[0])=="string")){return f.config("env",arguments[0])}return d[arguments[0]]||null}}return null}});f.extend(b,a);f.extend(f,a)})(jQuery,Claypool);Claypool.Logging={NullLogger:null,getLogger:null};(function(b,a,c){b.extend(c,{loggerFactory:null,getLogger:function(d){if(!c.loggerFactory){c.loggerFactory=new c.Factory()}if(c.updated){c.loggerFactory.updateConfig();c.updated=false}return c.loggerFactory.create(d)}})})(jQuery,Claypool,Claypool.Logging);(function(b,a,c){c.Level={DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4}})(jQuery,Claypool,Claypool.Logging);(function(b,a,c){c.Logger$Interface={debug:function(){throw new a.MethodNotImplementedError()},info:function(){throw new a.MethodNotImplementedError()},warn:function(){throw new a.MethodNotImplementedError()},error:function(){throw new a.MethodNotImplementedError()},exception:function(){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool,Claypool.Logging);(function(b,a,c){c.NullLogger=function(){var d=function(){return this};b.extend(this,{debug:d,info:d,warn:d,error:d,exception:d})}})(jQuery,Claypool,Claypool.Logging);(function(b,a,c){c.Logger=function(d){this.category="root";this.level=null;try{b.extend(true,this,d);this.level=c.Level[this.level?this.level:"NONE"];try{this.appender=new (b.resolve(this.appender||"Claypool.Logging.ConsoleAppender"))(d)}catch(f){try{this.appender=new c.ConsoleAppender(d)}catch(f){this.appender=new c.SysOutAppender(d)}}return this}catch(f){return new c.NullLogger()}};b.extend(c.Logger.prototype,c.Logger$Interface,{debug:function(){if(this.level<=c.Level.DEBUG){this.appender.append("DEBUG",this.category,arguments);return this}else{this.debug=function(){return this}}return this},info:function(){if(this.level<=c.Level.INFO){this.appender.append("INFO",this.category,arguments);return this}else{this.debug=function(){return this}}return this},warn:function(){if(this.level<=c.Level.WARN){this.appender.append("WARN",this.category,arguments);return this}else{this.debug=function(){return this}}return this},error:function(){if(this.level<=c.Level.ERROR){this.appender.append("ERROR",this.category,arguments);return this}else{this.debug=function(){return this}}return this},exception:function(d){if(this.level<c.Level.NONE){if(d){this.appender.append("EXCEPTION",this.category,d);return this}}else{this.debug=function(){return this}}return this}})})(jQuery,Claypool,Claypool.Logging);(function(b,a,c){c.Appender$Interface={formatter:null,append:function(f,e,d){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool,Claypool.Logging);(function(b,a,c){c.SysOutAppender=function(e){var f=function(){var g=null;g.toString()};if(b.isFunction(print)&&(window.load!==undefined)&&b.isFunction(window.load)){try{f()}catch(d){if(d.rhinoException){b.extend(true,this,e);this.formatter=new c.DefaultFormatter(e);return this}}}throw new c.NoAppendersAvailableError()};b.extend(c.SysOutAppender.prototype,c.Appender$Interface,{append:function(g,e,d){switch(g){case"DEBUG":print(this.formatter.format(g,e,d));break;case"INFO":print(this.formatter.format(g,e,d));break;case"WARN":print(this.formatter.format(g,e,d));break;case"ERROR":print(this.formatter.format(g,e,d));break;case ("EXCEPTION"):var f=d&&d.rhinoException?"\n\t"+d.rhinoException.message+"\tcolumn: "+d.rhinoException.columnNumber()+"\tline: "+d.rhinoException.lineNumber():"UNKNOWN RUNTIME ERROR";print(this.formatter.format(g,e,f));break}}})})(jQuery,Claypool,Claypool.Logging);(function(b,a,c){c.ConsoleAppender=function(d){var g;try{if(window&&window.console&&window.console.log){try{g=Envjs;return new c.SysOutAppender(d)}catch(f){}b.extend(true,this,d);this.formatter=new c.FireBugFormatter(d);return this}else{return new c.SysOutAppender(d)}}catch(f){throw f}return this};b.extend(c.ConsoleAppender.prototype,c.Appender$Interface,{append:function(f,e,d){switch(f){case ("DEBUG"):console.log.apply(console,this.formatter.format(f,e,d));break;case ("INFO"):console.info.apply(console,this.formatter.format(f,e,d));break;case ("WARN"):console.warn.apply(console,this.formatter.format(f,e,d));break;case ("ERROR"):console.error.apply(console,this.formatter.format(f,e,d));break;case ("EXCEPTION"):console.error.apply(console,this.formatter.format(f,e,d.message?[d.message]:[]));console.trace();break}}})})(jQuery,Claypool,Claypool.Logging);(function(b,a,c){c.Formatter$Interface={format:function(f,d,e){throw new b.MethodNotImplementedError()}}})(jQuery,Claypool,Claypool.Logging);(function(b,a,c){c.FireBugFormatter=function(d){b.extend(true,this,d)};b.extend(c.FireBugFormatter.prototype,c.Formatter$Interface,{getDateString:function(){return" ["+new Date().toUTCString()+"] "},format:function(h,f,g){var d=f+" "+h+": "+this.getDateString();g=(g&&g.length&&(g.length>0))?g:[];var e=(g.length>0)?g[0]:null;if(typeof(e)!="string"){g.unshift(d)}else{g[0]=d+e}return g}})})(jQuery,Claypool,Claypool.Logging);(function(d,b,f){var e=/((^%|[^\\]%)(\d+)?(\.)([a-zA-Z]))|((^%|[^\\]%)([a-zA-Z]))/,a=/function ?(.*?)\(/,c=/\[object (.*?)\]/;f.DefaultFormatter=function(g){d.extend(true,this,g)};d.extend(f.DefaultFormatter.prototype,f.Formatter$Interface,{getDateString:function(){return" ["+new Date().toUTCString()+"] "},format:function(g,h,p){var j=" "+g+":  "+this.getDateString()+"{"+h+"} ";var k=[j?j:""];var o=p[0];var l=0;if(typeof(o)!="string"){o="";l=-1}var m=this.parseFormat(o);var n;for(n=0;n<m.length;++n){if(m[n]&&typeof(m[n])=="object"){m[n].appender.call(this,p[++l],k)}else{this.appendText(m[n],k)}}for(n=l+1;n<p.length;++n){this.appendText(" ",k);if(typeof(p[n])=="string"){this.appendText(p[n],k)}else{this.appendObject(p[n],k)}}return k.join("")},parseFormat:function(o){var n=[];var h={s:this.appendText,d:this.appendInteger,i:this.appendInteger,f:this.appendFloat};var l;var k;var j;var g;for(g=e.exec(o);g;g=e.exec(o)){l=g[8]?g[8]:g[5];k=l in h?h[l]:this.appendObject;j=g[3]?parseInt(g[3],10):(g[4]=="."?-1:0);n.push(o.substr(0,g[0][0]=="%"?g.index:g.index+1));n.push({appender:k,precision:j});o=o.substr(g.index+g[0].length)}n.push(o);return n},objectToString:function(g){try{return g+""}catch(h){return null}},appendText:function(g,h){h.push(this.objectToString(g))},appendNull:function(g,h){h.push(this.objectToString(g))},appendString:function(g,h){h.push(this.objectToString(g))},appendInteger:function(g,h){h.push(this.objectToString(g))},appendFloat:function(g,h){h.push(this.objectToString(g))},appendFunction:function(j,k){var g=a.exec(this.objectToString(j));var h=g?g[1]:"function";k.push(this.objectToString(h))},appendObject:function(g,j){try{if(g===undefined){this.appendNull("undefined",j)}else{if(g===null){this.appendNull("null",j)}else{if(typeof g=="string"){this.appendString(g,j)}else{if(typeof g=="number"){this.appendInteger(g,j)}else{if(typeof g=="function"){this.appendFunction(g,j)}else{if(g.nodeType==1){this.appendSelector(g,j)}else{if(typeof g=="object"){this.appendObjectFormatted(g,j)}else{this.appendText(g,j)
}}}}}}}}catch(h){}},appendObjectFormatted:function(h,k){var j=this.objectToString(h);var g=c.exec(j);k.push(g?g[1]:j)},appendSelector:function(g,h){h.push(g.nodeName.toLowerCase());if(g.id){h.push(g.id)}if(g.className){h.push(g.className)}h.push("</span>")},appendNode:function(j,k){var g;var h;var l;if(j.nodeType==1){k.push("<",j.nodeName.toLowerCase(),">");for(h=0;h<j.attributes.length;++h){g=j.attributes[h];if(!g.specified){continue}k.push(g.nodeName.toLowerCase(),'="',g.nodeValue,'"')}if(j.firstChild){for(l=j.firstChild;l;l=l.nextSibling){this.appendNode(l,html)}k.push("</",j.nodeName.toLowerCase(),">")}else{k.push("/>")}}else{if(j.nodeType==3){k.push(j.nodeValue)}}}})})(jQuery,Claypool,Claypool.Logging);(function(b,a,c){c.Factory=function(d){a.extend(this,a.BaseFactory);this.configurationId="logging";b.extend(true,this,d);this.logger=new c.Logger({category:"Claypool.Logging.Factory",level:"INFO",appender:"Claypool.Logging.ConsoleAppender"});this.attemptedConfigure=false};b.extend(c.Factory.prototype,a.BaseFactory.prototype,{create:function(g){var d,h,e,f;if(!this.configuration){if(!this.attemptedConfigure){this.logger.warn("Claypool Logging was not initalized correctly. Logging will not occur unless initialized.")}this.attemptedConfigure=true;return new c.NullLogger()}else{d=g.split(".");for(i=0;i<d.length;i++){h=d.slice(0,d.length-i).join(".");e=this.find(h);if(e!==null){e.category=g;return new c.Logger(e)}}f=this.find("root");this.logger.debug("root logging category is set to %s",f);if(f!==null){f.category=g;return new c.Logger(f)}}this.logger.warn("No Matching category: %s Please configure a root logger.",g);return new c.NullLogger()},updateConfig:function(){var j;var g;var f;try{this.logger.debug("Configuring Claypool Logging");this.clear();j=this.getConfig()||[];for(f=0;f<j.length;f++){try{g=j[f];this.add(g.category,g)}catch(d){this.logger.exception(d);return false}}}catch(h){this.logger.exception(h);throw new c.ConfigurationError(h)}return true}})})(jQuery,Claypool,Claypool.Logging);(function(b,a,c){c.ConfigurationError=function(f,d){b.extend(this,new a.ConfigurationError(f,d||{name:"Claypool.Logging.ConfigurationError",message:"An error occured trying to configure the logging system."}))}})(jQuery,Claypool,Claypool.Logging);(function(b,a,c){c.NoAppendersAvailableError=function(f,d){b.extend(this,new a.Error(f,d||{name:"Claypool.Logging.NoAppendersAvailableError",message:"An error occured trying to configure the logging system."}))}})(jQuery,Claypool,Claypool.Logging);(function(c,a,d){c.extend(c,{logger:function(e){return d.getLogger(e)},logging:function(){if(arguments.length===0){return c.config("logging")}else{d.updated=true;return c.config("logging",arguments[0])}}});var b;c.extend(c,{debug:function(){b=b||c.logger("jQuery");b.debug.apply(b,arguments);return this},info:function(){b=b||c.logger("jQuery");b.info.apply(b,arguments);return this},warn:function(){b=b||c.logger("jQuery");b.warn.apply(b,arguments);return this},error:function(){b=b||c.logger("jQuery");b.error.apply(b,arguments);return this},exception:function(){b=b||c.logger("jQuery");b.exception.apply(b,arguments);return this}})})(jQuery,Claypool,Claypool.Logging);Claypool.Application={};(function(d,b,c){var a=0;c.context=null;d.extend(c,{getContext:function(){if(!c.context){c.context=new c.Context()}return c.context},Initialize:function(e){d(document).trigger("claypool:initialize",[c]);if(e){e()}d(document).trigger("ApplicationLoaded");return c.getContext()},Reinitialize:function(e){d(document).trigger("claypool:reinitialize",[c]);if(e){e()}d(document).trigger("ApplicationReloaded");return c.getContext()}});d.register(c,a);b.Commands={}})(jQuery,Claypool,Claypool.Application);(function(c,a,b){b.Context=function(d){a.extend(this,a.Context);this.contextContributors={};c.extend(true,this,d);this.logger=c.logger("Claypool.Application.Context")};c.extend(b.Context.prototype,a.Context.prototype,{get:function(j){var g,f,d;try{d=typeof(j)=="string"&&j.indexOf("#")>-1?[j.split("#")[0],"#"+j.split("#")[1]]:["",j];if(!this.find(d[0])){this.add(d[0],new a.SimpleCachingStrategy())}this.logger.debug("Searching application context for object: %s",j);g=null;g=this.find(d[0]).find(d[1]);if(g!==null){this.logger.debug("Found object in global application context. Object id: %s",j);return g}else{this.logger.debug("Searching for object in contributed application context. Object id: %s",j);for(f in this.contextContributors){this.logger.debug("Checking Application Context Contributor %s.",f);g=this.contextContributors[f].get(j);if(g!==null){this.logger.debug("Found object in contributed application context. Object id: %s",j);return g}}}this.logger.debug("Cannot find object in any application context. Object id: %s",j);return null}catch(h){throw new b.ContextError(h)}},put:function(g,e){var f,d;f=typeof(g)=="string"&&g.indexOf("#")>-1?[g.split("#")[0],"#"+g.split("#")[1]]:["",g];d=this.find(f[0]);if(!d){d=new a.SimpleCachingStrategy();this.add(f[0],d)}if(d.find(f[0])){d.remove(f[1])}this.logger.debug("Adding object to global application context %s",g);d.add(f[1],e)}})})(jQuery,Claypool,Claypool.Application);(function(c,a,b){b.ContextContributor=function(d){a.extend(this,a.ContextContributor);c.extend(true,this,d);this.logger=c.logger("Claypool.Application.ContextContributor");return this};c.extend(b.ContextContributor.prototype,a.ContextContributor.prototype,{registerContext:function(d){this.logger.info("Registering Context id: %s",d);b.getContext().contextContributors[d]=this}})})(jQuery,Claypool,Claypool.Application);(function(c,a,b){b.Aware=function(d){c.extend(this,d);this.logger=c.logger("Claypool.Application.Aware")};c.extend(b.Aware.prototype,{$:function(){return b.getContext()}})})(jQuery,Claypool,Claypool.Application);(function(c,a,b){b.ContextError=function(g,d){var f={name:"Claypool.Application.ContextError",message:"An unexpected error occured while searching the application context."};c.extend(this,new a.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.Application);(function(c,a,b){c.extend(c,{app:function(){return b.getContext()},boot:function(d){b.Initialize(d);return this},reboot:function(d){b.Reinitialize(d);return this},manage:function(d,e,f){c(document).bind("claypool:initialize",function(h,g){if(!g[e]){g[e]=new (c.resolve(d))();if(g.ContextContributor&&c.isFunction(g.ContextContributor)){g[e].registerContext(d)}}else{g[e].factory.updateConfig()}if(f&&c.isFunction(f)){f(g[e])}}).bind("claypool:reinitialize",function(h,g){g[e]=new (c.resolve(d))();if(g.ContextContributor&&c.isFunction(g.ContextContributor)){g[e].registerContext(d)}if(f&&c.isFunction(f)){f(g[e])}});return this}})})(jQuery,Claypool,Claypool.Application);Claypool.AOP={};(function(c,b,a){c.manage("Claypool.AOP.Container","claypool:AOP")})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Aspect=function(d){this.id=null;this.type=null;b.extend(this,b.SimpleCachingStrategy);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.Aspect");this.strategy=this.strategy||"all"};c.extend(a.Aspect.prototype,b.SimpleCachingStrategy.prototype,{weave:function(){var j=this;var g;var d;if(!this.target){j.logger.warn("No pointcut was specified.  Cant weave aspect.");return}var h=function(f){var l,k;try{j.logger.info("Weaving Advice %s for Aspect %s",f,j.id);j.hasPrototype=typeof(j.target.prototype)!="undefined";k=j.hasPrototype?j.target.prototype[f]:j.target[f];l=j.advise(k);if(!j.hasPrototype){j.target[f]=l}else{j.target.prototype[f]=l}if(j.literal.method){j.literal.method.push(f)}else{j.literal.method=[f]}return{pointcut:l,cutline:k}}catch(m){throw new a.WeaveError(m,"Weave")}};if(this.size===0){g=new RegExp(this[this.type?this.type:"method"]);d=this.target.prototype?this.target.prototype:this.target;for(var e in d){if(c.isFunction(d[e])&&g.test(e)){this.logger.debug("Adding aspect to method %s",e);this.add(c.uuid(),h(e));if(this.strategy==="first"){break
}}}}return this},unweave:function(){var d;try{for(var g in this.cache){d=this.find(g);if(!this.hasPrototype){this.target[this.method]=d.cutline}else{this.target.prototype[this.method]=d.cutline}this.hasPrototype=null}this.clear()}catch(f){throw new a.WeaveError(f,"Unweave")}return true},advise:function(d){throw new b.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.After=function(d){b.extend(this,a.Aspect);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.After");this.type="after"};c.extend(a.After.prototype,a.Aspect.prototype,{advise:function(d){var g=this;try{return function(){var e=d.apply(this,arguments);return g.advice.apply(g,[e])}}catch(f){throw new a.AspectError(f,"After")}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Before=function(d){b.extend(this,a.Aspect);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.Before");this.type="before"};c.extend(a.Before.prototype,a.Aspect.prototype,{advise:function(d){var g=this;try{return function(){g.advice.apply(g,arguments);return d.apply(this,arguments)}}catch(f){throw new a.AspectError(f,"Before")}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Around=function(d){b.extend(this,a.Aspect);c.extend(true,this,d);this.logger=c.logger("Claypool.AOP.Around");this.type="around"};c.extend(a.Around.prototype,a.Aspect.prototype,{advise:function(d){var g=this;try{return function(){var e={object:this,args:arguments};return g.advice.apply(g,[{object:e.object,arguments:e.args,proceed:function(){var h=d.apply(e.object,e.args);return h}}])}}catch(f){throw new a.AspectError(f,"Around")}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Factory=function(d){b.extend(this,b.BaseFactory);c.extend(true,this,d);this.configurationId="aop";this.aspectCache=null;this.logger=c.logger("Claypool.AOP.Factory");this.aspectCache=new b.SimpleCachingStrategy()};c.extend(a.Factory.prototype,b.BaseFactory.prototype,{updateConfig:function(){var l=this;var f;var k;var j;var h,g,d,n;try{this.logger.debug("Configuring Claypool AOP AspectFactory");f=this.getConfig()||[];this.logger.debug("AOP Configurations: %d",f.length);for(j=0;j<f.length;j++){try{k=f[j];if(!c.isFunction(k.advice)){k.advice=c.resolve(k.advice)}if(k.target.match("^ref://")){h=k.target.substr(6,k.target.length);c(document).bind("claypool:ioc:"+h,function(q,r,p){l.logger.debug("Creating aspect id %s for instance %s",k.id);var e=p.find(r);k.literal={scope:"global",object:"#"+h};k.target=e._this;l.add(k.id,k);var o=l.create(k.id);e._this=o.target;p.remove(r);p.add(r,e);l.logger.debug("Created aspect \n%s, \n%s")}).bind("claypool:predestroy:"+h,function(p,e){l.logger.debug("Destroying aspect id %s for instance %s",k.id);var o=l.aspectCache.find(k.id);if(o&&o.unweave){o.unweave()}})}else{if(k.target.match(/\.\*$/)){this.logger.debug("Broad aspect target %s",k.target);g=c.resolve(k.target.substring(0,k.target.length-2));for(d in g){if(c.isFunction(g[d])){n=c.extend({},k,{id:k.id+c.uuid(),target:g[d],literal:{scope:k.target.substring(0,k.target.length-2),object:d}});this.logger.debug("Creating aspect id %s [%s] (%s)",k.target,d,n.id);this.add(n.id,n);this.create(n.id)}}}else{this.logger.debug("Creating aspect id %s",k.id);k.literal={scope:k.target.split(".").length>1?k.target.substring(0,k.target.lastIndexOf(".")):k.target,object:aop.target.split(".").pop()};k.target=c.resolve(k.target);this.add(k.id,k);this.create(k.id)}}}catch(m){this.logger.exception(m)}}}catch(m){this.logger.exception(m);throw new a.ConfigurationError(m)}return true},create:function(m,h){var l;var d;var f=this.aspectCache.find(m);var k=this;var g=function(n){var e=null;if(n.after){e=new a.After(n)}else{if(n.before){e=new a.Before(n)}else{if(n.around){e=new a.Around(n)}}}return e.weave()};if(f){return f}else{try{this.logger.debug("Looking for configuration for aspect %s",m);l=this.find(m);if(l===undefined||l===null){this.logger.debug("%s is not an Aspect.",m);return null}else{this.logger.debug("Found configuration for instance %s",m);if(l.selector){this.logger.debug("Attaching contructor to an active selector");k=this;d=function(){f=g(l);k.aspectCache.add(l.id+"#"+this.toString(),f);return f};if(l.active){c(l.selector).livequery(d)}else{c(l.selector).each(d)}}else{f=g(l);this.aspectCache.add(m,f)}return f}}catch(j){this.logger.exception(j);throw new a.FactoryError(j)}}}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.Container=function(d){b.extend(this,b.Application.ContextContributor);c.extend(true,this,d);this.factory=null;this.logger=c.logger("Claypool.AOP.Container");this.logger.debug("Configuring Claypool AOP Container");this.factory=new a.Factory(d);this.factory.updateConfig()};c.extend(a.Container.prototype,b.Application.ContextContributor.prototype,{get:function(h){var d,f;try{f=typeof(h)=="string"&&h.indexOf("#")>-1?[h.split("#")[0],"#"+h.split("#")[1]]:["",h];if(!this.find(f[0])){this.add(f[0],new b.SimpleCachingStrategy())}this.logger.debug("Search for a container managed aspect :%s",h);d=this.find(f[0]).find(f[1]);if(d===undefined||d===null){this.logger.debug("Can't find a container managed aspect :%s",h);d=this.factory.create(f[1],f[0]);if(d!==null){this.find(f[0]).add(f[1],d);return d}}else{this.logger.debug("Found container managed instance :%s",h);return d}}catch(g){this.logger.exception(g);throw new a.ContainerError(g)}return null}})})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.ContainerError=function(g,d){var f={name:"Claypool.AOP.ContainerError",message:"An error occured inside the aop container."};c.extend(this,new b.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.ConfigurationError=function(g,d){var f={name:"Claypool.AOP.ConfigurationError",message:"An error occured updating the aop container configuration."};c.extend(this,new b.ConfigurationError(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.FactoryError=function(g,d){var f={name:"Claypool.AOP.FactoryError",message:"An error occured creating the aspect from the configuration."};c.extend(this,new b.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.WeaveError=function(g,d){var f={name:"Claypool.AOP.WeaveError",message:"An error occured weaving or unweaving the aspect."};c.extend(this,new b.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,b,a){a.AspectError=function(g,d){var f={name:"Claypool.AOP.AspectError",message:"An error occured while applying an aspect."};c.extend(this,new b.Error(g,d?{name:(d.name?(d.name+" > "):"")+f.name,message:(d.message?(d.message+" \n "):"")+f.message}:f))}})(jQuery,Claypool,Claypool.AOP);(function(c,a,b){c.extend(c,{filters:function(){if(arguments.length===0){return c.config("aop")}else{return c.config("aop",arguments[0])}}})})(jQuery,Claypool,Claypool.AOP);Claypool.IoC={};(function(c,a,b){c.manage("Claypool.IoC.Container","claypool:IoC")})(jQuery,Claypool,Claypool.IoC);(function(c,a,b){b.Instance=function(e,d){c.extend(this,{_this:null,id:null,configuration:null,guid:c.uuid(),type:null,id:e,configuration:d||{},logger:c.logger("Claypool.IoC.Instance")});this.logger.category=this.logger.category+"."+this.id};c.extend(b.Instance.prototype,{precreate:function(){try{this._this={claypoolId:this.id};this.logger.debug("Precreating Instance");c(document).trigger("claypool:precreate",[this._this,this.id]);c(document).trigger("claypool:precreate:"+this.id,[this._this]);return this}catch(d){this.logger.error("An Error occured in the Pre-Create LifeCycle Phase");this.logger.exception(d);throw new b.LifeCycleError(d)}},create:function(){var j,q,f,g;var m,p,l,o;var d,k;try{this.logger.debug("Applying Selector to Instance");if(this.configuration.selector){this._this=c(this.configuration.selector);
this.logger.debug("Result for selector : ",this._this)}else{this.logger.debug("Using default empty object");this._this={}}if(this.configuration.factory){j={};if(this.configuration.factory.substring(6,0)=="ref://"){this.logger.debug("Retreiving Factory from Application Context");j=c.$(this.configuration.factory)}else{this.logger.info("Creating Instance from Factory");q=this.resolveConstructor(this.configuration.factory);retval=q.apply(j,this.configuration.options);j=retval||j}this.logger.debug("Applying factory creation method");f=this.configuration.factoryMethod||"create";m=j[f].apply(j,this.configuration.options);this._this=c.extend(true,m,this._this)}else{this.logger.info("Creating Instance simulating constructor: %s",this.configuration.clazz);l=this.resolveConstructor(this.configuration.clazz);o=this.configuration.options||[];m={};switch(o.length){case 0:m=new l();break;case 1:m=new l(o[0]);break;case 2:m=new l(o[0],o[1]);break;case 3:m=new l(o[0],o[1],o[2]);break;case 4:m=new l(o[0],o[1],o[2],o[3]);break;case 5:m=new l(o[0],o[1],o[2],o[3],o[4]);break;case 6:m=new l(o[0],o[1],o[2],o[3],o[4],o[5]);break;case 7:m=new l(o[0],o[1],o[2],o[3],o[4],o[5],o[6]);break;case 8:m=new l(o[0],o[1],o[2],o[3],o[4],o[5],o[6],o[7]);break;case 9:m=new l(o[0],o[1],o[2],o[3],o[4],o[5],o[6],o[7],o[8]);break;default:p=l.apply(m,o);m=p||m}m.$ns=this.configuration.clazz;m.$log=c.logger(m.$ns);m.$log.debug("Created new instance of %s",m.$ns);this._this=c.extend(true,m,this._this)}d=this.configuration.inject||{};for(var h in d){k=d[h];if(c.isFunction(k.substring)&&(k.substring(0,6)=="ref://")){d[h]=c.$(k.substring(6,k.length))}}c.extend(this._this,d);c(document).trigger("claypool:create",[this._this,this.id]);c(document).trigger("claypool:create:"+this.id,[this._this]);return this._this}catch(n){this.logger.error("An Error occured in the Create LifeCycle Phase");this.logger.exception(n);throw new b.LifeCycleError(n)}},postcreate:function(){try{this.logger.debug("PostCreate invoked");c(document).trigger("claypool:postcreate",[this._this,this.id]);c(document).trigger("claypool:postcreate:"+this.id,[this._this]);return this._this}catch(d){this.logger.error("An Error occured in the Post-Create LifeCycle Phase");this.logger.exception(d);throw new b.LifeCycleError(d)}},predestroy:function(){try{this.logger.debug("Predestory invoked");c(document).trigger("claypool:predestroy",[this._this,this.id]);c(document).trigger("claypool:predestroy:"+this.id,[this._this]);return this._this}catch(d){this.logger.exception(d);throw new b.LifeCycleError(d)}},destroy:function(){try{this.logger.info("Destroy invoked");c(document).trigger("claypool:destroy",[this._this,this.id]);c(document).trigger("claypool:destroy:"+this.id,[this._this]);return delete this._this}catch(d){this.logger.exception(d);throw new b.LifeCycleError(d)}},postdestroy:function(){try{this.logger.debug("Postdestory invoked");c(document).trigger("claypool:postdestroy",[this.id]);c(document).trigger("claypool:postdestroy:"+this.id);return this}catch(d){this.logger.exception(d);throw new b.LifeCycleError(d)}},resolveConstructor:function(d){var f;try{f=c.resolve(d);if(c.isFunction(f)){this.logger.debug(" Resolved "+d+" to a function");return f}else{throw new Error("Constructor is not a function: "+d)}}catch(g){this.logger.exception(g);throw new b.ConstructorResolutionError(g)}}})})(jQuery,Claypool,Claypool.IoC);(function(c,a,b){b.Factory=function(d){a.extend(this,a.BaseFactory);c.extend(true,this,d);this.configurationId="ioc";this.logger=c.logger("Claypool.IoC.Factory")};c.extend(b.Factory.prototype,a.BaseFactory.prototype,{createLifeCycle:function(d){try{d.precreate();d.create();d.postcreate()}catch(f){this.logger.error("An Error occured in the Creation Lifecycle.");this.logger.exception(f);throw new b.LifeCycleError(f)}},destroyLifeCycle:function(d){try{d.predestroy();d.destroy();d.postdestroy()}catch(f){this.logger.error("An Error occured in the Destory Lifecycle.");this.logger.exception(f);throw new b.LifeCycleError(f)}},create:function(d,k){var h,n,l=this,f,g,j;try{k=k||"";if(!this.find(k)){this.logger.debug("Adding cache for namespace %s",k);this.add(k,new a.SimpleCachingStrategy())}this.logger.debug("Looking for configuration for instance %s%s",k,d);h=this.find(k).find(d);if(h===null){this.logger.warn("No known configuration for instance %s%s",k,d);f=d.match(/#([a-z]+([A-Z]?[a-z]+)+)([A-Z][a-z]+)+/);if(f){}return null}else{this.logger.debug("Found configuration for instance %s%s",k,d);n=new b.Instance(h.id,h);if(h.active&&h.selector){this.logger.debug("Attaching contructor to an active selector");n.precreate();n._this["@claypool:activeobject"]=h.selector;n._this["@claypool:id"]=n.id;jQuery(h.selector).livequery(function(){l.logger.debug("Processing Creation Lifecycle.");l.createLifeCycle(n)},function(){l.logger.debug("Processing Destruction Lifecycle.");l.destroyLifeCycle(n)})}else{this.logger.debug("Processing Creation Lifecycle.");this.createLifeCycle(n)}return n}}catch(m){this.logger.exception(m);throw new b.FactoryError(m)}},updateConfig:function(){var h;var d;var f;try{this.logger.debug("Configuring Claypool IoC Factory");h=this.getConfig()||[];this.logger.debug("IoC Configurations: %d",h.length);for(f=0;f<h.length;f++){try{d=h[f];if(d.scan&&d.factory){this.logger.debug("Scanning %s with %s",d.scan,d.factory);h=h.concat(d.factory.scan(d.scan,d.namespace))}else{this.logger.debug("IoC Configuration for Id: %s%s",d.namespace||"",d.id);if(d.namespace){if(!this.find(d.namespace)){this.add(d.namespace,new a.SimpleCachingStrategy())}this.find(d.namespace).add(d.id,d)}else{if(!this.find("")){this.add("",new a.SimpleCachingStrategy())}this.find("").add(d.id,d)}}}catch(g){this.logger.exception(g);return false}}}catch(g){this.logger.exception(g);throw new b.ConfigurationError(g)}return true}})})(jQuery,Claypool,Claypool.IoC);(function(c,a,b){b.Container=function(d){a.extend(this,a.Application.ContextContributor);c.extend(true,this,d);this.factory=null;this.logger=c.logger("Claypool.IoC.Container");this.logger.debug("Configuring Claypool IoC Container");this.factory=new b.Factory();this.factory.updateConfig()};c.extend(b.Container.prototype,a.Application.ContextContributor.prototype,{get:function(j){var d,f,h=this;try{f=typeof(j)=="string"&&j.indexOf("#")>-1?[j.split("#")[0],"#"+j.split("#")[1]]:["",j];if(!this.find(f[0])){this.add(f[0],new a.SimpleCachingStrategy())}this.logger.debug("Searching for a container managed instance :%s",j);d=this.find(f[0]).find(f[1]);if(!d){this.logger.debug("Can't find a container managed instance :%s",j);d=this.factory.create(f[1],f[0]);if(d){this.logger.debug("Storing managed instance %s in container",j);this.find(f[0]).add(f[1],d);if(d._this["@claypool:activeobject"]){c(document).bind("claypool:postcreate:"+d.id,function(k,e,l){h.logger.info("Reattached Active Object Inside IoC Container");d._this=e});c(document).bind("claypool:postdestroy:"+d.id,function(){h.logger.info("Removed Active Object Inside IoC Container");h.find(f[0]).remove(f[1])})}else{c(document).trigger("claypool:ioc",[j,this]);c(document).trigger("claypool:ioc:"+j,[j,this])}return this.find(f[0]).find(f[1])._this}}else{this.logger.debug("Found container managed instance :%s",j);return d._this}}catch(g){this.logger.exception(g);throw new b.ContainerError(g)}return null}})})(jQuery,Claypool,Claypool.IoC);(function(c,a,b){b.ContainerError=function(d){c.extend(this,new a.Error(d,{name:"Claypool.IoC.ContainerError",message:"An error occured in the ioc instance factory."}))}})(jQuery,Claypool,Claypool.IoC);(function(c,a,b){b.FactoryError=function(d){c.extend(this,new a.Error(d,{name:"Claypool.IoC.FactoryError",message:"An error occured in the ioc factory."}))}})(jQuery,Claypool,Claypool.IoC);(function(c,a,b){b.ConfigurationError=function(d){c.extend(this,new a.ConfigurationError(d,{name:"Claypool.IoC.ConfigurationError",message:"An error occured updating the ioc container configuration."}))}})(jQuery,Claypool,Claypool.IoC);(function(c,a,b){b.LifeCycleError=function(d){c.extend(this,new a.Error(d,{name:"Claypool.IoC.LifeCycleError",message:"An error occured during the lifecycle process."}))
}})(jQuery,Claypool,Claypool.IoC);(function(c,a,b){b.ConstructorResolutionError=function(d){c.extend(this,new a.NameResolutionError(d,{name:"Claypool.IoC.ConstructorResolutionError",message:"An error occured trying to resolve the constructor."}))}})(jQuery,Claypool,Claypool.IoC);(function(c,a,b){c.extend(c,{scan:function(){var e,f;if(arguments.length===0){return c.config("ioc")}else{e=[];if(c.isPlainObject(arguments[0])){for(f in arguments[0]){d(arguments[0][f],f)}}else{if(c.isArray(arguments[0])){d(arguments[0])}else{if(typeof arguments[0]=="string"){d(arguments[0])}}}return c.config("ioc",e)}function d(j,h){var g;if(c.isArray(j)){for(g=0;g<j.length;g++){e.push({scan:j[g],factory:a.MVC.Factory.prototype,namespace:h?h:null})}}else{e.push({scan:j,factory:a.MVC.Factory.prototype,namespace:h?h:null})}}},invert:function(){if(arguments.length===0){return c.config("ioc")}else{return c.config("ioc",arguments[0])}}})})(jQuery,Claypool,Claypool.IoC);Claypool.MVC={};(function(a){a.manage("Claypool.MVC.Container","claypool:MVC",function(b){var e,g,c,d=b.factory.getConfig(),f;for(f in d){b.logger.debug("eagerly loading mvc routers: %s",f);for(e=0;e<d[f].length;e++){g=d[f][e].id;controller=b.get(g);b.logger.debug("attaching mvc core controller: %s",g);if(controller&&!controller.attached){controller.attach();controller.attached=true}}}})})(jQuery);(function(c,a,b){b.View$Interface={update:function(d){throw new a.MethodNotImplementedError()},think:function(){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Controller=function(d){a.extend(this,a.SimpleCachingStrategy);c.extend(true,this,d);this.logger=c.logger("Claypool.MVC.Controller")};c.extend(b.Controller.prototype,a.SimpleCachingStrategy.prototype,{handle:function(d){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.HijaxController=function(d){a.extend(this,b.Controller);c.extend(true,this,{forwardingList:[],selector:"",filter:"",active:true,preventDefault:true,stopPropagation:true,hijaxMap:[],resolveQueue:[],strategy:null},d);this.router=new a.Router();this.bindCache=new a.SimpleCachingStrategy();this.logger=c.logger("Claypool.MVC.HijaxController")};c.extend(b.HijaxController.prototype,b.Controller.prototype,{handle:function(e){this.logger.debug("Handling pattern: %s",e.pattern);this.forwardingList=this.router[this.strategy||"all"](e.pattern);this.logger.debug("Resolving matched paterns");var f=this,d={};if(this.forwardingList.length>0){this.logger.debug("normalizing event state params");if(c.isFunction(this.normalize)){d=this.normalize(e.args[0])}}return jQuery(this.forwardingList).each(function(){var k,h,g;try{f.logger.info("Forwaring to registered controller %s",this.payload.controller);k=c.$(this.payload.controller);g=this.payload.controller.match("Controller")?this.payload.controller.replace("Controller","View"):null;g=this.payload.controller.match("Service")?this.payload.controller.replace("Service","View"):g;this.map=c.extend(d,this.map);(function(s){var o=e.args[0],n=[],l={flash:[],length:0},p=g,u=k;for(var r=1;r<e.args.length;r++){n[r-1]=e.args[r]}var q=c.extend({},o,{m:function(){if(arguments.length===0){return l}else{if(arguments.length===1){if(typeof(arguments[0])=="string"){return l[arguments[0]]}else{if(arguments[0] instanceof Array){l.length+=arguments[0].length;Array.prototype.push.apply(l,arguments[0])}else{if(arguments[0] instanceof Object){c.extend(true,l,arguments[0])}}}}else{if(arguments.length===2){if(arguments[1] instanceof Array){if(typeof(arguments[0])=="string"&&!(arguments[0] in l)){l[arguments[0]]=[]}c.merge(l[arguments[0]],arguments[1])}else{if(arguments[1] instanceof XML||arguments[1] instanceof XMLList){l[arguments[0]]=arguments[1]}else{if(arguments[1] instanceof Object){if(typeof(arguments[0])=="string"&&!(arguments[0] in l)){l[arguments[0]]={}}c.extend(true,l[arguments[0]],arguments[1])}}}}}}return this},v:function(m){if(!m){return p}if(m&&typeof(m)=="string"){m=m.split(".");if(m.length===1){p=m}else{if(m.length===2){if(m[0]!==""){p=m.join(".")}else{p=p.split(".")[0]+"."+m[1]}}}}return this},c:function(){var v,t,m;if(arguments.length===0){return u}else{if(arguments.length>0&&typeof(arguments[0])=="string"){if(arguments.length>1&&c.isPlainObject(arguments[1])){s.map=c.extend(true,s.map||{},arguments[1])}v=arguments[0].split(".");u=v[0];p=u.match("Controller")?u.replace("Controller","View"):null;p=u.match("Service")?u.replace("Service","View"):p;t=(v.length>1&&v[1].length>0)?v[1]:"handle";m=f.find(v[0]);if(m===null){m=c.$(v[0]);f.add(v[0],m)}m[t||"handle"].apply(m,[this].concat(n))}}return this},render:f.renderer(),reset:function(){l={flash:[],length:0};p=g;u=k;return this},params:function(m){if(arguments.length===0){return s.map?s.map:{}}else{return(s.map&&(m in s.map))?s.map[m]:null}}});k[s.payload.action||"handle"].apply(k,[q].concat(n))})(this)}catch(j){j=j?j:new Error();if(j.name&&j.name.indexOf("Claypool.Application.ContextError")>-1){f.logger.warn("No controller with id: %s",this.payload.controller)}else{f.logger.exception(j);throw j}}})},attach:function(){this.router.compile(this.hijaxMap,this.routerKeys);var d=this;if(this.active&&(this.selector!==""||this.filter!=="")){this.logger.debug("Actively Hijaxing %s's %s%s",this.hijaxKey,this.selector,this.filter);c(this.selector+this.filter).livequery(function(){d.hijax(this)})}else{if(this.selector!==""||this.filter!==""){this.logger.debug("Hijaxing Current %s's.",this.hijaxKey);c(this.selector+this.filter).each(function(){d.hijax(this)})}else{if(document!==undefined){this.logger.debug("Hijaxing Document For %s's.",this.hijaxKey);d.hijax(document)}else{this.logger.warn("Unable to attach controller: %s",options.id)}}}},hijax:function(e){this.logger.debug("Hijaxing %s: %s",this.hijaxKey,e);var f=this;var d=function(g){var h=true;f.logger.info("Hijaxing %s: ",f.hijaxKey);if(f.stopPropagation){f.logger.debug("Stopping propogation of event");g.stopPropagation()}if(f.preventDefault){f.logger.debug("Preventing default event behaviour");g.preventDefault();h=false}f.handle({pattern:f.target.apply(f,arguments),args:arguments,normalize:f.normalize?f.normalize:function(){return{}}});return h};if(this.event){c(this.event.split("|")).each(function(){c(e).bind(this+"."+f.eventNamespace,d);f.logger.debug("Binding event %s to hijax controller on target",this,e)})}else{c(this.hijaxMap).each(function(){if(this.event&&!f.bindCache.find(this.event)){f.bindCache.add(this.event,f);f.logger.debug("Binding event %s to controller %s on target %s",this.event,this.controller,e);c(e).bind(this.event+"."+f.eventNamespace,d)}})}return true},renderer:function(){var e=this;var d=[];return function(n){var m,g,k,f,h,j;if(n&&c.isFunction(n)){d.push(n)}e.logger.debug(" - Resolving Control - %s)",this.c());try{f=this.v();h=c.isFunction(this.write)?(c.isFunction(c.render)?"write":"render"):"update";if(f.indexOf(".")>-1){h=f.split(".");f=h[0];h=h[h.length-1]}e.logger.debug("Calling View %s.%s",f,h);f=c.$(f);if(f){if(c.isFunction(f[h])){switch(h){case"write":case"writeln":this[h](f[h](this.m(),this));break;case"render":f.write=this.write;f.writeln=this.writeln;f[h](this.m(),this);break;default:f[h](this.m(),this)}e.logger.debug("Cascading callbacks");while(d.length>0){(d.pop())()}}else{if(f["@claypool:activeobject"]){j="claypool:postcreate:"+f["@claypool:id"]+"."+c.uuid();c(document).bind(j,function(o,p){e.logger.warn("The view is reattached to the dom.");c(document).unbind(j);p.update(this.m());e.logger.debug("Cascading callbacks");while(d.length>0){(d.pop())()}})}else{e.logger.debug("View method cannot be resolve",h)}}}else{e.logger.warn("Cant resolve view %s. ",this.v())}}catch(l){e.logger.error("Error resolving flow %s => %s",this.c(),this.v()).exception(l);throw l}return this}},target:function(d){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Factory=function(d){a.extend(this,a.IoC.Factory);c.extend(true,this,d);this.configurationId="mvc";
this.logger=c.logger("Claypool.MVC.Factory");this.add("",new a.SimpleCachingStrategy())};c.extend(b.Factory.prototype,a.IoC.Factory.prototype,{updateConfig:function(){var h,d,g,k,f;try{this.logger.debug("Configuring Claypool MVC Controller Factory");h=this.getConfig()||{};c(document).trigger("claypool:hijax",[this,this.initializeHijaxController,h])}catch(j){this.logger.exception(j);throw new b.ConfigurationError(j)}},scan:function(g,j){var k=this.logger||c.logger("Claypool.MVC.Factory");var f,o,d=[],m,n=function(e,p){return("#"+e.substring(0,1).toLowerCase()+e.substring(1)+p.substring(0,p.length-1))},h=function(e){return("#"+e.substring(0,1).toLowerCase()+e.substring(1))};j=j||"";k.debug("Scanning %s%s",j,g);try{if(g.split(".").length==1){o=c.resolve(g);for(f in o){k.debug("Scan Checking %s.%s",g,f);if(c.isPlainObject(o[f])){k.debug("Scan Following %s.%s",g,f);d.push(this.scan(g+"."+f,j))}}}else{if(g.split(".").length==2){o=c.resolve(g);for(f in o){k.debug("Scan Checking %s.%s",g,f);if(c.isFunction(o[f])){k.debug("Configuring by Convention %s.%s",g,f);config={id:n(f,g.split(".")[1]),clazz:g+"."+f,namespace:j};if(g.match(".Views")){config.selector=h(f)}d.push(config)}}}else{if(g.split(".").length==3){o=c.resolve(g);if(c.isFunction(o)){k.debug("Appending to Configuration by Convention %s",g);config={id:n(f,g.split(".")[2]),clazz:g,namespace:j};if(g.match(".Views")){config.selector=h(f)}d.push(config)}}}}}catch(l){k.error("Error Scanning %s!!",g).exception(l)}return d},initializeHijaxController:function(h,g,e,d){var j,f;if(h[g]){for(f=0;f<h[g].length;f++){j={};j.id=h[g][f].id;j.clazz=e;j.options=[c.extend(true,{},d,h[g][f])];this.logger.debug("Adding MVC Configuration for Controller Id: %s",j.id);this.find("").add(j.id,j)}}}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Container=function(d){a.extend(this,a.Application.ContextContributor);c.extend(true,this,d);this.factory=null;this.logger=c.logger("Claypool.MVC.Container").debug("Configuring Claypool MVC Container");this.factory=new b.Factory();this.factory.updateConfig()};c.extend(b.Container.prototype,a.Application.ContextContributor.prototype,{get:function(h){var d,f;try{this.logger.debug("Search for a container managed controller : %s",h);f=typeof(h)=="string"&&h.indexOf("#")>-1?[h.split("#")[0],"#"+h.split("#")[1]]:["",h];if(!this.find(f[0])){this.add(f[0],new a.SimpleCachingStrategy())}d=this.find(f[0]).find(f[1]);if(d===undefined||d===null){this.logger.debug("Can't find a container managed controller : %s",h);d=this.factory.create(f[1],f[0]);if(d!==null){this.find(f[0]).add(f[1],d);return d._this}else{return null}}else{this.logger.debug("Found container managed controller : %s",h);return d._this}}catch(g){this.logger.exception(g);throw new b.ContainerError()}throw new b.FactoryError(h)}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.ContainerError=function(d){c.extend(this,new a.Error(d,{name:"Claypool.MVC.ContainerError",message:"An error occurred trying to retreive a container managed object."}))}})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.FactoryError=function(d){c.extend(this,new a.Error(d,{name:"Claypool.MVC.FactoryError",message:"An error occured trying to create the factory object."}))}})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.ConfigurationError=function(d){c.extend(this,new a.ConfigurationError(d,{name:"Claypool.MVC.ConfigurationError",message:"An error occured during the configuration."}))}})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){var c;d.extend(d,{router:function(f,e){d(document).bind("claypool:hijax",function(g,k,h,j){c=c||d.logger("Claypool.MVC.Plugins");c.debug("registering router plugin: %s",f);h.apply(k,[j,f,"Claypool.MVC.HijaxController",e])});return this},mvc:function(){var f,e;if(arguments.length===0){return d.config("mvc")}else{e=d.config("mvc");for(f in arguments[0]){if(f in e){d.merge(e[f],arguments[0][f])}else{e[f]=arguments[0][f]}}return this}}});d.routes=d.mvc;d.router("hijax:a",{selector:"a",event:"click",strategy:"first",routerKeys:"urls",hijaxKey:"link",eventNamespace:"Claypool:MVC:HijaxLinkController",target:function(f){var e=f.target||f.currentTarget;while(e.tagName.toUpperCase()!="A"){e=d(e).parent()[0]}return d(e).attr("href")},normalize:function(g){var f=g.target||g.currentTarget,h={};while(f.tagName.toUpperCase()!="A"){f=d(f).parent()[0]}var e=d(f).attr("href");var j=e.split("?");j=j&&j.length>1?j[1]:"";d(j.split("&")).each(function(m,p){var n=p.split("="),k=n[0],o=n[1],l;if(k in h){if(!d.isArray(h[k])){l=h[k];h[k]=[l]}h[k].push(o)}else{h[k]=o}});return h}}).router("hijax:button",{selector:":button",event:"click",strategy:"all",routerKeys:"ids",hijaxKey:"button",eventNamespace:"Claypool:MVC:HijaxButtonController",target:function(e){return e.target.id},normalize:function(e){return{}}}).router("hijax:input",{selector:"input",event:"blur|focus",strategy:"all",routerKeys:"ids",hijaxKey:"input",eventNamespace:"Claypool:MVC:HijaxInputController",target:function(e){return e.target.id},normalize:function(e){var f={};f[e.target.name]=e.target.value;return f}}).router("hijax:form",{selector:"form",event:"submit",strategy:"first",routerKeys:"urls",hijaxKey:"form",eventNamespace:"Claypool:MVC:HijaxFormController",target:function(e){return e.target.action},normalize:function(e){var g={},f=d(e.target).serializeArray();d(f).each(function(k,h){var j;if(h.name in g){if(!d.isArray(g[h.name])){j=g[h.name];g[h.name]=[]}g[h.name].push(h.value)}else{g[h.name]=h.value}});return g}}).router("hijax:event",{strategy:"all",routerKeys:"event",hijaxKey:"event",eventNamespace:"Claypool:MVC:HijaxEventController",target:function(e){return e.type},normalize:function(e){return{}}});d.mvc_scanner=b.Factory.prototype})(jQuery,Claypool,Claypool.MVC);Claypool.Models={};Claypool.Configuration.index=[];(function(c,a,b){b.Model=function(f,d,e){c.extend(true,this,b.Factory(e));c.extend(this,{name:f,fields:d})};c.extend(b.Model.prototype,{validate:function(h){var g=[],f=h.data,k,e,d,m;if(h.batch){d=[];for(k=0;k<f.length;k++){m=f[k].$id;this.validate(c.extend({},h,{data:f[k],batch:false,success:function(j){j.$id=m;d.push(j)},error:function(j,n){g.push(n)}}))}if(g.length===0){f=d}}else{for(var l in this.fields){if(f[l]===undefined&&this.fields[l].generate){f[l]=this.fields[l].generate()}if(this.fields[l].not){for(k=0;k<this.fields[l].not.length;k++){if(f[l] instanceof Array){for(e=0;e<f[l].length;e++){if(f[l][e]===this.fields[l].not[k]){g[g.length]={index:e,field:l,value:f[l][e],msg:this.fields[l].msg}}}}else{if(f[l]===this.fields[l].not[k]){g[g.length]={value:f[l],field:l,msg:this.fields[l].msg}}}}}if(this.fields[l].pattern&&(f[l]!==undefined)){if(f[l] instanceof Array){for(e=0;e<f[l].length;e++){if(!this.fields[l].pattern.test(f[l][e])){g[g.length]={index:e,field:l,value:f[l][e],msg:this.fields[l].msg}}}}else{if(!this.fields[l].pattern.test(f[l])){g[g.length]={value:f[l],field:l,msg:this.fields[l].msg}}}}}}if(g.length>0&&h.error&&c.isFunction(h.error)){h.error(f,g)}else{if(h.success&&c.isFunction(h.success)){if(h.serialize){f=this.serialize(f)}h.success(f)}}return this},serialize:function(d){var h={},g,e;for(var f in d){if((this.fields[f]!==undefined||"__anything__" in this.fields||f=="$id")&&!c.isFunction(d[f])){if(this.fields[f]&&this.fields[f].type){if(this.fields[f].type=="json"){h[f]=jsPath.js2json(d[f])}else{if(this.fields[f].type=="html"){h[f]=c("<div/>").append(c(d[f]).clone()).html()}else{if(this.fields[f].type=="xmllist"){h[f]=d[f].toString()}}}}else{h[f]=d[f]}}}return h},deserialize:function(d){var f={};for(var e in this.fields){if((d[e]!==undefined||"__anything__" in this.fields)&&!c.isFunction(d[e])){if(this.fields[e].type){if(this.fields[e].type=="json"){f[e]=c.json2js(d[e])}else{if(this.fields[e].type=="html"){f[e]=c(d[e])}else{if(this.fields[e].type=="xmllist"){f[e]=new XMLList(d[e])}}}}else{serialized[e]=d[e]}}}return f}});c.each(["create","destroy","metadata","save","add","remove","get","find","js2query","next","previous"],function(d,e){b.Model.prototype[e]=function(f){throw new a.MethodNotImplementedError()
}})})(jQuery,Claypool,Claypool.Models);(function(g,k,c){var e;c.Query=function(n){if(typeof(n)=="string"){n={context:n}}g.extend(true,this,{context:"",selectors:[],expressions:[],orderby:{direction:"forward"},limit:0,startPage:0,resultsPerPage:20},n);e=g.logger("Claypool.Models.Query")};var l=c.Query;g.extend(l.prototype,{items:function(n){if(n&&(typeof n=="string")){this.selectors.push(n)}else{if(n&&n.length&&(n instanceof Array)){g.merge(this.selectors,n)}else{this.selectors.push("*")}}return this},names:function(){return this.items("itemName()")},count:function(){return this.items("count()")},is:function(n){a(this,"=");m(this,n);return this},isnot:function(n){a(this,"!=");m(this,n);return this},islike:function(n){a(this,"~");m(this,n);return this},isnotlike:function(n){a(this,"!~");m(this,n);return this},isgt:function(n){a(this,">");m(this,n);return this},isgte:function(n){a(this,">=");m(this,n);return this},isbetween:function(n){a(this,"><");m(this,n);return this},islte:function(n){a(this,"<=");m(this,n);return this},islt:function(n){a(this,"<");m(this,n);return this},isin:function(n){a(this,"@");m(this,n);return this},isnotin:function(n){a(this,"!@");m(this,n);return this},orderby:function(n){f(this,n);return this},reverseorderby:function(n){f(this,n,"reverse");return this},limit:function(n){this.limit=n},page:function(o,n){if(n){this.count=n}this.startPage=o;return this},next:function(n){this.startPage++;return this},previous:function(n){this.startPage--;return this}});var d=["","like","gt","gte","between","lte","lt"];for(var h=0;h<d.length;h++){l.prototype["where"+d[h]]=function(n){b(this,n,"where","");return this};l.prototype["wherenot"+d[h]]=function(n){b(this,n,"where","not");return this};l.prototype["whereeither"+d[h]]=function(n){b(this,n,"either","");return this};l.prototype["whereneither"+d[h]]=function(n){b(this,n,"either","not");return this};l.prototype["and"+d[h]]=function(n){b(this,n,"and","");return this};l.prototype["andnot"+d[h]]=function(n){b(this,n,"and","not");return this};l.prototype["or"+d[h]]=function(n){b(this,n,"or","");return this};l.prototype["ornot"+d[h]]=function(n){b(this,n,"or","not");return this}}var b=function(p,s,o,n,q){var r=null;n=n?n:"is";if(p&&s&&o&&g.isFunction(p[o])){if(o=="where"){p.expressions=[];o="and"}else{if(o=="whereeither"||o=="whereneither"){p.expressions=[];o="or"}}if(typeof s=="string"){p.expressions.push({name:s,type:o})}else{if(s&&typeof(s)=="object"&&!(s instanceof Array)){for(r in s){if(typeof(s[r])=="string"){if(q){p[o](r)["isnot"+n](s[r])}else{p[o](r)["isnot"+n](s[r])}}else{if(n===""&&s[r]&&s[r].length&&s[r] instanceof Array){if(q){p[o](r).isnotin(s[r])}else{p[o](r).isin(s[r])}}}}}}}};var a=function(o,n){o.expressions[o.expressions.length-1].operator=n};var m=function(o,n){o.expressions[o.expressions.length-1].value=n};var j=function(o,n){o.expressions[o.expressions.length-1].name=n};var f=function(o,n,p){o.orderby={name:n,direction:(p||"forward")}}})(jQuery,Claypool,Claypool.Models);(function(c,a,b){b.Client=function(d){c.extend(true,this,d)};c.each(["create","destroy","metadata","save","update","remove","get","find","js2query","next","previous"],function(d,e){b.Client.prototype[e]=function(f){this.db[e](c.extend(f,{domain:this.name}));return this}})})(jQuery,Claypool,Claypool.Models);(function(e,a,c){var b;c.RestClient=function(g){this.js2json=e&&e.js2json&&e.isFunction(e.js2json)?e.js2json:g.js2json;this.json2js=e&&e.json2js&&e.isFunction(e.json2js)?e.json2js:g.json2js;e.extend(true,this,g);this.resturl=e.env("resturl")?e.env("resturl"):"/rest/";b=e.logger("Claypool.Models.RestClient")};e.extend(c.RestClient.prototype,{create:function(g){e.ajax(e.extend({},g,{type:"PUT",url:this.resturl+this.name+"/",dataType:"json",success:function(h){d("created data domain (%s)",g.success,h)},error:function(k,h,j){f("failed to create data domain",g.error,k,h,j)}}));return this},destroy:function(g){e.ajax(e.extend({},g,{type:"DELETE",url:this.resturl+this.name+"/",dataType:"json",success:function(h){d("destroyed data domain",g.success,h)},error:function(k,h,j){f("failed to destroy data domain",g.error,k,h,j)}}));return this},save:function(g){var j,h;if(!g.batch&&g.id){if(g.serialize){g.data=this.serialize(g.data)}e.ajax(e.extend({},g,{type:g.update?"POST":"PUT",url:(this.resturl+this.name+"/"+g.id),data:this.js2json(g.data),contentType:"application/json",dataType:"json",processData:false,success:function(k){d("saved data to domain",g.success,k)},error:function(m,k,l){f("failed to save data to domain",g.error,m,k,l)}}))}else{if(g.batch){if(g.serialize){for(h=0;h<g.data.length;h++){g.data[h]=this.serialize(g.data[h])}}e.ajax(e.extend({},g,{type:g.update?"POST":"PUT",url:(this.resturl+this.name+"/"),data:this.js2json(g.data),contentType:"application/json",processData:false,dataType:"json",success:function(k){d("saved batch data to domain",g.success,k)},error:function(m,k,l){f("failed to save batch data to domain",g.error,m,k,l)}}))}}return this},update:function(g){this.save(e.extend({},g,{update:true}));return this},remove:function(g){if(g.id){e.ajax(e.extend({},g,{type:"DELETE",url:this.resturl+this.name+"/"+g.id,data:(g.data instanceof Array)?{data:g.data.join(",")}:(g.data instanceof Object)?g.data:null,dataType:"json",success:function(h){d("removed item or item data from domain",g.success,h)},error:function(k,h,j){f("failed to delete item or item data from domain",g.error,k,h,j)}}))}return this},get:function(g){var h,j={limit:g.limit?Number(g.limit):1000,start:g.start?Number(g.start):1,offset:g.offset?Number(g.offset):0,from:g.from?g.from:""};if(g.id&&typeof g.id=="string"){e.ajax(e.extend({},g,{type:"GET",url:this.resturl+this.name+"/"+g.id,dataType:"json",data:j,success:function(k){d("retrieved data by id from domain",g.success,k)},error:function(m,k,l){f("failed to retrieved data by id from domain",g.error,m,k,l)}}))}else{if(g.id&&g.id.length){h=g.id.join(",");e.ajax(e.extend({},g,{type:h.length>1024?"POST":"GET",url:this.resturl+this.name+"/",data:e.extend(j,{id:h}),dataType:"json",success:function(k){d("successfully for data by ids from domain",g.success,k)},error:function(m,k,l){f("failed to get data by ids from domain",g.error,m,k,l)}}))}else{e.ajax(e.extend({},g,{type:"GET",url:this.resturl+this.name+"/",dataType:"json",data:j,success:function(k){d("loaded list of ids from domain",g.success,k)},error:function(m,k,l){f("failed to list ids from domain ",g.error,m,k,l)}}))}}return this},find:function(g){if(g.select){if(typeof g.select=="object"){if(!(g.select instanceof c.Query)){g.select=new c.Query(g.select)}g.select.context=this.name}e.ajax(e.extend({},g,{type:"POST",url:this.resturl,data:(typeof g.select=="string")?g.select:this.js2json(e.extend(g.data||{},g.select)),contentType:(typeof g.select=="string")?"text/plain":"application/json",processData:false,dataType:"json",success:function(h){d("saved item to domain",g.success,h)},error:function(k,h,j){f("failed to save item to domain",g.error,k,h,j)}}))}else{b.debug("performing simple parameter search");e.ajax(e.extend({},g,{type:"GET",url:this.resturl,dataType:"json",success:function(h){d("performed search",g.success,h)},error:function(k,h,j){f("error performing search",g.error,k,h,j)}}))}return this},next:function(g){this.find(query.next(),callback);return this},previous:function(g){this.find(query.previous(),callback);return this}});var d=function(j,k,g,h){b.debug("loaded list of items from domain: %s",g);if(k&&e.isFunction(k)){k(g,h)}};var f=function(k,l,j,g,h){b.error(k+" %s-%s",j.status,g).exception(h);if(l&&e.isFunction(l)){l([{msg:k}],true)}}})(jQuery,Claypool,Claypool.Models);(function(d,a,c){var b;c.Factory=function(h){h=h||{};b=b||d.logger("Claypool.Models.Factory");var g,f;var k=h&&h.dbclient?h.dbclient:d.env("dbclient");if(!k){k="rest"}b.debug("loading database client connection %s",k);if(k=="rest"){k=new c.RestClient(h)}else{try{g=h&&h.db?h.db:d.env("db");f=h&&h.dbconnection?h.dbconnection:d.env("dbconnection");b.debug("loading database implementation %s",g);
if(typeof(g)=="string"){b.debug("resolving database implementation %s",g);g=d.resolve(g)}k=new c.Client(d.extend({db:new g(f)},h))}catch(j){b.error("direct connection not available",j).exception(j);k=new c.RestClient(h)}}return k}})(jQuery,Claypool,Claypool.Models);(function(c,a,b){c.extend(c,{db:function(d){return new b.Factory(d)},model:function(f,d,e){return new b.Model(f,d,e)},query:function(d){return new b.Query(d)},index:function(){if(arguments.length===0){return c.config("index")}else{return c.config("index",arguments[0])}}})})(jQuery,Claypool,Claypool.Models);Claypool.Server={};(function(d,a,c){var b;d.router("hijax:server",{event:"claypool:serve",strategy:"first",routerKeys:"urls",hijaxKey:"request",eventNamespace:"Claypool:Server:HijaxServerController",target:function(g,f,e){b=b||d.logger("Claypool.Server");b.debug("targeting request event");g.request=f;g.response=e;g.write=function(h){b.debug("writing response.body : %s",h);e.body=h+"";return this};g.writeln=function(h){b.debug("writing line to response.body : %s",h);e.body+=h+"";return this};return f.requestURL+""},normalize:function(e){return d.extend({},e.request.parameters,{parameters:e.request.parameters,method:e.request.method,body:e.request.body,headers:d.extend(e.response.headers,e.request.headers)})}});a.Services={}})(jQuery,Claypool,Claypool.Server);(function(c,a,b){b.Servlet=function(d){a.extend(this,a.MVC.Controller);c.extend(true,this,d);this.logger=c.logger("Claypool.Server.Servlet")};c.extend(b.Servlet.prototype,a.MVC.Controller.prototype,{handle:function(d){var e=d.params("method").toUpperCase();d.params("headers").status=200;this.logger.debug("Handling %s request",e);switch(e){case"GET":this.handleGet(d,d.response);break;case"POST":this.handlePost(d,d.response);break;case"PUT":this.handlePut(d,d.response);break;case"DELETE":this.handleDelete(d,d.response);break;case"HEAD":this.handleHead(d,d.response);break;case"OPTIONS":this.handleOptions(d,d.response);break;default:this.logger.debug("Unknown Method: %s, rendering error response.",e);this.handleError(d,"Unknown Method: "+e,new Error())}},handleGet:function(d){throw new a.MethodNotImplementedError()},handlePost:function(d){throw new a.MethodNotImplementedError()},handlePut:function(d){throw new a.MethodNotImplementedError()},handleDelete:function(d){throw new a.MethodNotImplementedError()},handleHead:function(d){throw new a.MethodNotImplementedError()},handleOptions:function(d){throw new a.MethodNotImplementedError()},handleError:function(d,g,f){this.logger.warn("The default error response should be overriden");d.headers.status=300;d.response.body=g?g:"Unknown internal error\n";d.response.body+=f&&f.msg?f.msg+"":(f?f+"":"\nUnpsecified Error.")}})})(jQuery,Claypool,Claypool.Server);(function(e,b,d,g){var c;g.RestServlet=function(h){b.extend(this,g.Servlet);e.extend(true,this,d.Factory(h));c=e.logger("Claypool.Server.RestServlet");this.js2json=e.js2json&&e.isFunction(e.js2json)?e.js2json:h.js2json;this.json2js=e.json2js&&e.isFunction(e.json2js)?e.json2js:h.json2js};e.extend(g.RestServlet.prototype,g.Servlet.prototype,{handleGet:function(k){var o=this,m=k.params("domain"),n=k.params("id"),l=k.params("q"),j=n?n.split(","):[],h;c.debug("Handling GET for %s %s",m,n);if(l){c.debug("finding results with url constructed query %o",k.params());this.db.find(e.extend({data:k.params("values"),async:false,success:function(p){a(k,p,o)},error:function(r,p,q){f(k,result,o)}},k.params()))}else{if(!m&&!n){this.db.get(e.extend({async:false,success:function(p){a(k,p,o)},error:function(p){f(k,p,o)}},k.params()))}else{if(m&&(j.length>1||!n)){c.debug("Handling GET for %s %s",m,j);if(j.length>1){this.db.get(e.extend(k.params(),{id:j,domain:m,async:false,success:function(p){a(k,p,o)},error:function(p){f(k,p,o)}}))}else{c.debug("getting list of item ids for domain %s",m,n);this.db.get(e.extend({domain:m,async:false,success:function(p){a(k,p,o)},error:function(p){f(k,p,o)}},k.params()))}}else{if(m&&n&&n!="metadata"){this.db.get({domain:m,id:n,async:false,dataType:"text",success:function(p){a(k,p,o)},error:function(p){f(k,p,o)}})}else{if(m&&n&&n=="metadata"){this.db.metadata({domain:m,id:n,async:false,dataType:"text",success:function(p){a(k,p,o)},error:function(p){f(k,p,o)}})}}}}}},handlePost:function(l){var p=this,n=l.params("domain"),o=l.params("id"),j,k,h,m;c.debug("Handling POST for %s %s",n,o).debug("Reading POST body %s",l.body);if(n&&o){if(!l.params("body")){j=o.split(",");this.db.get(e.extend(l.params(),{id:j,domain:n,async:false,success:function(q){a(l,q,p)},error:function(q){f(l,q,p)}}))}else{c.debug("updating single object",l.request.body);k=this.json2js(l.request.body);this.db.update({domain:n,id:o,data:k,async:false,success:function(q){a(l,q,p)},error:function(q){f(l,q,p)}})}}else{if(n&&!o){c.debug("updating array of objects (bulk save)");h=this.json2js(l.request.body);this.db.update({domain:n,data:h,async:false,batch:true,success:function(q){a(l,q,p)},error:function(q){f(l,q,p)}})}else{if(!n&&!o){m=l.request.body;if(l.request.contentType.match("application/json")){m=this.json2js(m)}c.debug("executing query \n%s",m);this.db.find(e.extend({select:m,async:false,success:function(q){a(l,q,p)},error:function(q){f(l,q,p)}},l.params()))}}}},handlePut:function(h){var k=this,j=h.params("id");domain=h.params("domain");c.debug("Handling PUT for %s %s",domain);if(domain&&j){c.debug("saving single object",h.request.body);item=this.json2js(h.request.body);this.db.save({domain:domain,id:j,data:item,async:false,success:function(l){a(h,l,k)},error:function(l){f(h,l,k)}})}else{if(domain&&h.request.body){c.debug("saving array of objects (bulk save)");items=this.json2js(h.request.body);this.db.save({domain:domain,data:items,async:false,batch:true,success:function(l){a(h,l,k)},error:function(l){f(h,l,k)}})}else{if(domain){this.db.create({domain:domain,async:false,success:function(l){a(h,l,k)},error:function(l){f(h,l,k)}})}}}},handleDelete:function(h){var l=this,j=h.params("domain"),k=h.params("id");c.debug("Handling DELETE for %s %s",j,k);if(j&&k){this.db.remove({domain:j,id:k,async:false,success:function(m){a(h,m,l)},error:function(m){f(h,m,l)}})}else{if(j&&!k){this.db.destroy({domain:j,async:false,success:function(m){a(h,m,l)},error:function(m){f(h,m,l)}})}}}});var a=function(k,j,l){var h=l.js2json(j,null,"   ");c.debug("succeeded. %s",h);k.response.headers={status:200,"Content-Type":"text/javascript; charset=utf-8"};k.response.body=h};var f=function(k,j,l){var h=l.js2json(j,null,"    ");c.error("failed. %s",h);k.response.headers={status:j.code?j.code:500,"Content-Type":"text/javascript; charset=utf-8"};k.response.body=h?h:"{'error':{'code'  : 500,'type'  : 'UnknownClaypoolRestError','msg'   : 'unknown error, check network'}}"}})(jQuery,Claypool,Claypool.Models,Claypool.Server);(function(d,a,c){var b;c.WebProxyServlet=function(f){a.extend(this,c.Servlet);this.rewriteMap=null;d.extend(true,this,f);b=d.logger("Claypool.Server.WebProxyServlet");this.router=new a.Router();this.strategy=this.strategy||"first";b.debug("Compiling url rewrites %s.",this.rewriteMap);this.router.compile(this.rewriteMap,"urls")};d.extend(c.WebProxyServlet.prototype,c.Servlet.prototype,{handleGet:function(j,g){var h=e.route(request,this);var f=h.proxyURL,k=h.params;if(f&&f.length&&f.length>0){b.debug("Proxying get request to: %s",f[0].payload.rewrite);d.ajax({type:"GET",dataType:"text",async:false,data:k,url:f[0].payload.rewrite+"",beforeSend:function(l){e.beforeSend(j.request,g,l)},success:function(l){e.success(g,l)},error:function(n,l,m){e.error(g,n,l,m)},complete:function(m,l){e.complete(g,f,m,l)}})}return g},handlePost:function(j,g){var h=e.route(j.request,this);var f=h.proxyURL,k=h.params;if(f&&f.length&&f.length>0){b.debug("Proxying post request to: %s",f[0].payload.rewrite);d.ajax({type:"POST",dataType:"text",async:false,data:k,url:f[0].payload.rewrite+"",beforeSend:function(l){e.beforeSend(j.request,g,l)},success:function(l){e.success(g,l)},error:function(n,l,m){e.error(g,n,l,m)
},complete:function(m,l){e.complete(g,f,m,l)}})}return g}});var e={route:function(j,h){b.debug("Handling proxy: %s",j.requestURI);var g=h.router[h.strategy||"all"](j.requestURI);j.headers["Claypool-Proxy"]=h.proxyHost||"127.0.0.1";var k={};for(var l in j.parameters){b.debug("request.parameters[%s]=%s",l,j.parameters[l]);k[l+""]=j.parameters[l]+""}var f=(j.body&&j.body.length)?j.body:"";return{proxyURL:g,params:k,body:f}},beforeSend:function(g,f,h){b.debug("Copying Request headers for Proxied Request");for(var j in g.headers){b.debug("Setting proxied request header %s: %s",j,g.headers[j]);h.setRequestHeader(j,g.headers[j])}f.headers={}},success:function(f,g){b.debug("Got response for proxy \n %s.",g);f.body=g+""},error:function(g,j,f,h){b.error("Error proxying request. STATUS: %s",f?f:"UNKNOWN");if(h){b.exception(h)}g.body=j.responseText+""},complete:function(h,l,o,j){b.debug("Proxy Request Complete, Copying response headers");var f=o.getAllResponseHeaders();var g;var m;b.debug("Complete Proxy response header: \n %s",f);f=f.split("\r\n");for(var k=0;k<f.length;k++){m=f[k].split(":");try{b.debug("setting response header %s %s",m[0],m.join(":"));h.headers[m.shift()]=m.join(":")}catch(n){b.warn("Unable to set a proxied response header");b.exception(n)}}b.debug("response status (%s)",o.status);h.headers.status=Number(o.status);h.headers["Claypool-Proxy"]=l[0].payload.rewrite+"";h.headers["Content-Encoding"]=l[0].payload.contentEncoding||"";h.headers["Transfer-Encoding"]=l[0].payload.transferEncoding||"";if(l[0].payload.contentType){h.headers["Content-Type"]=l[0].payload.contentType+""}}}})(jQuery,Claypool,Claypool.Server);(function(d,b,e){var c,a;e.Manage=function(f){d.extend(true,this,f);c=d.logger("Claypool.Services.Manage");a=b.Models.Factory()};d.extend(e.Manage.prototype,{handle:function(f){var h=f.params("command"),g=f.params("target");c.debug("handling command %s %s",h,g);b.Commands[h](g,f);if(("reset"==h)||("syncdb"==h)){c.debug("forwarding to rest service");f.response.headers={status:302,Location:"/rest/"}}}});d.extend(true,b.Commands,{reset:function(g){var f;a.get({async:false,success:function(h){f=h.domains;c.debug("loaded domains")},error:function(k,h,j){c.error("failed to get db domains")}});d(f).each(function(h,j){a.destroy({domain:j,async:false,success:function(k){c.info("destroyed domain %s",j)},error:function(m,k,l){c.error("failed to delete domain %s",j)}})})},syncdb:function(f){var j,g=d.env("initialdata")+"dump.json?"+d.uuid(),h;c.info("loading initial data from %s",g);d.ajax({type:"get",async:false,url:g,dataType:"text",success:function(k){j=d.json2js(k);c.info("loaded initial data")},error:function(m,k,l){c.error("failed [%s] to load initial data %s",k,l)}});for(h in j){a.create({domain:h,async:false,success:function(k){c.info("created domain %s",h)}});a.save({async:false,batch:true,domain:h,data:j[h],success:function(){c.info("batch save successful %s ",h)},error:function(){c.error("batch save failed %s",h)}})}},dumpdata:function(g,h){var j={};var f;a.get({async:false,success:function(k){f=k.domains;c.debug("loaded domains")},error:function(m,k,l){c.error("failed to get db domains")}});d(f).each(function(k,l){a.find({select:"new Query('"+l+"')",async:false,success:function(m){c.info("found %s entries in %s",m.data.length,l);j[l]=m.data},error:function(o,m,n){ok(false,"failed load entries from %s",l)}})});h.write(d.js2json(j,null,"    "));h.response.headers={status:200,"Content-Type":"application/json"}}})})(jQuery,Claypool,Claypool.Services);(function(c,a,b){})(jQuery,Claypool,Claypool.Server);(function(e,b,d){var c,a;e.extend(e,{serve:function(g,f){var j;c=c||e.logger("Claypool.Server");c.info("Handling global request routing for request: %s ",g.requestURL).debug("Dispatching request to Server Sevlet Container");f.headers={};e.extend(f.headers,{"Content-Type":"text/html; charset=utf-8",status:-1});f.body="";try{c.debug("serving request event");e(document).trigger("claypool:serve",[g,f]);c.debug("finished serving request event");if(f.headers.status===-1){f.headers.status=200;if(!f.body){f.headers.status=404;f.body="<html><head></head><body><h1>jQuery-Claypool Server Error</h1>";f.body+="<p>Not Found :\n\t"+g.requestURL+"</p></body></html>"}}}catch(h){c.error("Error Handling Request.").exception(h);f.headers["Content-Type"]="text/html; charset=utf-8";f.headers.status=500;f.body="<html><head></head><body><h1>jQuery-Claypool Server Error</h1>";f.body+="<h2>Error Details</h2>";for(j in h){f.body+="<strong>"+j+"</strong><br/><span>"+h[j]+"</span><br/>"}f.body+="<h2>General Request Details</h2>";for(j in g){f.body+="<strong>"+j+"</strong><br/><span>"+g[j]+"</span><br/>"}f.body+="<h2>Request Header Details</h2>";for(j in g.headers){f.body+="<strong>"+j+"</strong><br/><span>"+g.headers[j]+"</span><br/>"}f.body+="</body></html>"}},servlet:function(f){c=c||e.logger("Claypool.Server");c.debug("Applying servlet pattern to %s",f);b.extend(f,d.Servlet)},proxy:function(f){return e.invert([{id:f.id||"proxy_"+e.uuid(),clazz:"Claypool.Server.WebProxyServlet",options:[{rewriteMap:f.rewrites}]}])}});ClaypoolServerHandler=e.serve})(jQuery,Claypool,Claypool.Server);