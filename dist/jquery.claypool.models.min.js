Claypool.Models={};Claypool.Configuration.index=[];(function(c,a,b){b.Model=function(f,d,e){c.extend(true,this,b.Factory(e));c.extend(this,{name:f,fields:d})};c.extend(b.Model.prototype,{validate:function(h){var g=[],f=h.data,k,e,d,m;if(h.batch){d=[];for(k=0;k<f.length;k++){m=f[k].$id;this.validate(c.extend({},h,{data:f[k],batch:false,success:function(i){i.$id=m;d.push(i)},error:function(i,j){g.push(j)}}))}if(g.length===0){f=d}}else{for(var l in this.fields){if(f[l]===undefined&&this.fields[l].generate){f[l]=this.fields[l].generate()}if(this.fields[l].not){for(k=0;k<this.fields[l].not.length;k++){if(f[l] instanceof Array){for(e=0;e<f[l].length;e++){if(f[l][e]===this.fields[l].not[k]){g[g.length]={index:e,field:l,value:f[l][e],msg:this.fields[l].msg}}}}else{if(f[l]===this.fields[l].not[k]){g[g.length]={value:f[l],field:l,msg:this.fields[l].msg}}}}}if(this.fields[l].pattern&&(f[l]!==undefined)){if(f[l] instanceof Array){for(e=0;e<f[l].length;e++){if(!this.fields[l].pattern.test(f[l][e])){g[g.length]={index:e,field:l,value:f[l][e],msg:this.fields[l].msg}}}}else{if(!this.fields[l].pattern.test(f[l])){g[g.length]={value:f[l],field:l,msg:this.fields[l].msg}}}}}}if(g.length>0&&h.error&&c.isFunction(h.error)){h.error(f,g)}else{if(h.success&&c.isFunction(h.success)){if(h.serialize){f=this.serialize(f)}h.success(f)}}return this},serialize:function(d){var h={},g,e;for(var f in d){if((this.fields[f]!==undefined||"__anything__" in this.fields||f=="$id")&&!c.isFunction(d[f])){if(this.fields[f]&&this.fields[f].type){if(this.fields[f].type=="json"){h[f]=jsPath.js2json(d[f])}else{if(this.fields[f].type=="html"){h[f]=c("<div/>").append(c(d[f]).clone()).html()}else{if(this.fields[f].type=="xmllist"){h[f]=d[f].toString()}}}}else{h[f]=d[f]}}}return h},deserialize:function(d){var f={};for(var e in this.fields){if((d[e]!==undefined||"__anything__" in this.fields)&&!c.isFunction(d[e])){if(this.fields[e].type){if(this.fields[e].type=="json"){f[e]=c.json2js(d[e])}else{if(this.fields[e].type=="html"){f[e]=c(d[e])}else{if(this.fields[e].type=="xmllist"){f[e]=new XMLList(d[e])}}}}else{serialized[e]=d[e]}}}return f}});c.each(["create","destroy","metadata","save","add","remove","get","find","js2query","next","previous"],function(d,e){b.Model.prototype[e]=function(f){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.Models);(function(g,k,c){var e;c.Query=function(i){if(typeof(i)=="string"){i={context:i}}g.extend(true,this,{context:"",selectors:[],expressions:[],orderby:{direction:"forward"},limit:0,startPage:0,resultsPerPage:20},i);e=g.logger("Claypool.Models.Query")};var l=c.Query;g.extend(l.prototype,{items:function(i){if(i&&(typeof i=="string")){this.selectors.push(i)}else{if(i&&i.length&&(i instanceof Array)){g.merge(this.selectors,i)}else{this.selectors.push("*")}}return this},names:function(){return this.items("itemName()")},count:function(){return this.items("count()")},is:function(i){a(this,"=");m(this,i);return this},isnot:function(i){a(this,"!=");m(this,i);return this},islike:function(i){a(this,"~");m(this,i);return this},isnotlike:function(i){a(this,"!~");m(this,i);return this},isgt:function(i){a(this,">");m(this,i);return this},isgte:function(i){a(this,">=");m(this,i);return this},isbetween:function(i){a(this,"><");m(this,i);return this},islte:function(i){a(this,"<=");m(this,i);return this},islt:function(i){a(this,"<");m(this,i);return this},isin:function(i){a(this,"@");m(this,i);return this},isnotin:function(i){a(this,"!@");m(this,i);return this},orderby:function(i){f(this,i);return this},reverseorderby:function(i){f(this,i,"reverse");return this},limit:function(i){this.limit=i},page:function(o,n){if(n){this.count=n}this.startPage=o;return this},next:function(i){this.startPage++;return this},previous:function(i){this.startPage--;return this}});var d=["","like","gt","gte","between","lte","lt"];for(var h=0;h<d.length;h++){l.prototype["where"+d[h]]=function(i){b(this,i,"where","");return this};l.prototype["wherenot"+d[h]]=function(i){b(this,i,"where","not");return this};l.prototype["whereeither"+d[h]]=function(i){b(this,i,"either","");return this};l.prototype["whereneither"+d[h]]=function(i){b(this,i,"either","not");return this};l.prototype["and"+d[h]]=function(i){b(this,i,"and","");return this};l.prototype["andnot"+d[h]]=function(i){b(this,i,"and","not");return this};l.prototype["or"+d[h]]=function(i){b(this,i,"or","");return this};l.prototype["ornot"+d[h]]=function(i){b(this,i,"or","not");return this}}var b=function(o,r,n,i,p){var q=null;i=i?i:"is";if(o&&r&&n&&g.isFunction(o[n])){if(n=="where"){o.expressions=[];n="and"}else{if(n=="whereeither"||n=="whereneither"){o.expressions=[];n="or"}}if(typeof r=="string"){o.expressions.push({name:r,type:n})}else{if(r&&typeof(r)=="object"&&!(r instanceof Array)){for(q in r){if(typeof(r[q])=="string"){if(p){o[n](q)["isnot"+i](r[q])}else{o[n](q)["isnot"+i](r[q])}}else{if(i===""&&r[q]&&r[q].length&&r[q] instanceof Array){if(p){o[n](q).isnotin(r[q])}else{o[n](q).isin(r[q])}}}}}}}};var a=function(n,i){n.expressions[n.expressions.length-1].operator=i};var m=function(n,i){n.expressions[n.expressions.length-1].value=i};var j=function(n,i){n.expressions[n.expressions.length-1].name=i};var f=function(n,i,o){n.orderby={name:i,direction:(o||"forward")}}})(jQuery,Claypool,Claypool.Models);(function(c,a,b){b.Client=function(d){c.extend(true,this,d)};c.each(["create","destroy","metadata","save","update","remove","get","find","js2query","next","previous"],function(d,e){b.Client.prototype[e]=function(f){this.db[e](c.extend(f,{domain:this.name}));return this}})})(jQuery,Claypool,Claypool.Models);(function(e,a,c){var b;c.RestClient=function(g){this.js2json=e&&e.js2json&&e.isFunction(e.js2json)?e.js2json:g.js2json;this.json2js=e&&e.json2js&&e.isFunction(e.json2js)?e.json2js:g.json2js;e.extend(true,this,g);this.resturl=e.env("resturl")?e.env("resturl"):"/rest/";b=e.logger("Claypool.Models.RestClient")};e.extend(c.RestClient.prototype,{create:function(g){e.ajax(e.extend({},g,{type:"PUT",url:this.resturl+this.name+"/",dataType:"json",success:function(h){d("created data domain (%s)",g.success,h)},error:function(j,h,i){f("failed to create data domain",g.error,j,h,i)}}));return this},destroy:function(g){e.ajax(e.extend({},g,{type:"DELETE",url:this.resturl+this.name+"/",dataType:"json",success:function(h){d("destroyed data domain",g.success,h)},error:function(j,h,i){f("failed to destroy data domain",g.error,j,h,i)}}));return this},save:function(g){var j,h;if(!g.batch&&g.id){if(g.serialize){g.data=this.serialize(g.data)}e.ajax(e.extend({},g,{type:g.update?"POST":"PUT",url:(this.resturl+this.name+"/"+g.id),data:this.js2json(g.data),contentType:"application/json",dataType:"json",processData:false,success:function(i){d("saved data to domain",g.success,i)},error:function(l,i,k){f("failed to save data to domain",g.error,l,i,k)}}))}else{if(g.batch){if(g.serialize){for(h=0;h<g.data.length;h++){g.data[h]=this.serialize(g.data[h])}}e.ajax(e.extend({},g,{type:g.update?"POST":"PUT",url:(this.resturl+this.name+"/"),data:this.js2json(g.data),contentType:"application/json",processData:false,dataType:"json",success:function(i){d("saved batch data to domain",g.success,i)},error:function(l,i,k){f("failed to save batch data to domain",g.error,l,i,k)}}))}}return this},update:function(g){this.save(e.extend({},g,{update:true}));return this},remove:function(g){if(g.id){e.ajax(e.extend({},g,{type:"DELETE",url:this.resturl+this.name+"/"+g.id,data:(g.data instanceof Array)?{data:g.data.join(",")}:(g.data instanceof Object)?g.data:null,dataType:"json",success:function(h){d("removed item or item data from domain",g.success,h)},error:function(j,h,i){f("failed to delete item or item data from domain",g.error,j,h,i)}}))}return this},get:function(g){var h,i={limit:g.limit?Number(g.limit):1000,start:g.start?Number(g.start):1,offset:g.offset?Number(g.offset):0,from:g.from?g.from:""};if(g.id&&typeof g.id=="string"){e.ajax(e.extend({},g,{type:"GET",url:this.resturl+this.name+"/"+g.id,dataType:"json",data:i,success:function(j){d("retrieved data by id from domain",g.success,j)
},error:function(l,j,k){f("failed to retrieved data by id from domain",g.error,l,j,k)}}))}else{if(g.id&&g.id.length){h=g.id.join(",");e.ajax(e.extend({},g,{type:h.length>1024?"POST":"GET",url:this.resturl+this.name+"/",data:e.extend(i,{id:h}),dataType:"json",success:function(j){d("successfully for data by ids from domain",g.success,j)},error:function(l,j,k){f("failed to get data by ids from domain",g.error,l,j,k)}}))}else{e.ajax(e.extend({},g,{type:"GET",url:this.resturl+this.name+"/",dataType:"json",data:i,success:function(j){d("loaded list of ids from domain",g.success,j)},error:function(l,j,k){f("failed to list ids from domain ",g.error,l,j,k)}}))}}return this},find:function(g){if(g.select){if(typeof g.select=="object"){if(!(g.select instanceof c.Query)){g.select=new c.Query(g.select)}g.select.context=this.name}e.ajax(e.extend({},g,{type:"POST",url:this.resturl,data:(typeof g.select=="string")?g.select:this.js2json(e.extend(g.data||{},g.select)),contentType:(typeof g.select=="string")?"text/plain":"application/json",processData:false,dataType:"json",success:function(h){d("saved item to domain",g.success,h)},error:function(j,h,i){f("failed to save item to domain",g.error,j,h,i)}}))}else{b.debug("performing simple parameter search");e.ajax(e.extend({},g,{type:"GET",url:this.resturl,dataType:"json",success:function(h){d("performed search",g.success,h)},error:function(j,h,i){f("error performing search",g.error,j,h,i)}}))}return this},next:function(g){this.find(query.next(),callback);return this},previous:function(g){this.find(query.previous(),callback);return this}});var d=function(i,j,g,h){b.debug("loaded list of items from domain: %s",g);if(j&&e.isFunction(j)){j(g,h)}};var f=function(j,k,i,g,h){b.error(j+" %s-%s",i.status,g).exception(h);if(k&&e.isFunction(k)){k([{msg:j}],true)}}})(jQuery,Claypool,Claypool.Models);(function(d,a,c){var b;c.Factory=function(h){h=h||{};b=b||d.logger("Claypool.Models.Factory");var g,f;var j=h&&h.dbclient?h.dbclient:d.env("dbclient");if(!j){j="rest"}b.debug("loading database client connection %s",j);if(j=="rest"){j=new c.RestClient(h)}else{try{g=h&&h.db?h.db:d.env("db");f=h&&h.dbconnection?h.dbconnection:d.env("dbconnection");b.debug("loading database implementation %s",g);if(typeof(g)=="string"){b.debug("resolving database implementation %s",g);g=d.resolve(g)}j=new c.Client(d.extend({db:new g(f)},h))}catch(i){b.error("direct connection not available",i).exception(i);j=new c.RestClient(h)}}return j}})(jQuery,Claypool,Claypool.Models);(function(c,a,b){c.extend(c,{db:function(d){return new b.Factory(d)},model:function(f,d,e){return new b.Model(f,d,e)},query:function(d){return new b.Query(d)},index:function(){if(arguments.length===0){return c.config("index")}else{return c.config("index",arguments[0])}}})})(jQuery,Claypool,Claypool.Models);