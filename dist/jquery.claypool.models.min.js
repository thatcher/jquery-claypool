Claypool.Models={};(function(c,a,b){b.Model=function(f,d,e){c.extend(true,this,b.Factory(e));c.extend(this,{name:f,fields:d})};c.extend(b.Model.prototype,{validate:function(h){var g=[],f=h.data,k,e,d,m;if(h.batch){d={};for(m in f){this.validate(c.extend({},h,{data:f[m],batch:false,success:function(i){d[m]=i},error:function(i,j){g.push(j)}}))}if(g.length===0){f=d}}else{for(var l in this.fields){if(f[l]===undefined&&this.fields[l].generate){f[l]=this.fields[l].generate()}if(this.fields[l].not){for(k=0;k<this.fields[l].not.length;k++){if(f[l] instanceof Array){for(e=0;e<f[l].length;e++){if(f[l][e]===this.fields[l].not[k]){g[g.length]={index:e,value:f[l][e],msg:this.fields[l].msg}}}}else{if(f[l]===this.fields[l].not[k]){g[g.length]={value:f[l],msg:this.fields[l].msg}}}}}if(this.fields[l].pattern){if(f[l] instanceof Array){for(e=0;e<f[l].length;e++){if(!this.fields[l].pattern.test(f[l][e])){g[g.length]={index:e,value:f[l][e],msg:this.fields[l].msg}}}}else{if(!this.fields[l].pattern.test(f[l])){g[g.length]={value:f[l],msg:this.fields[l].msg}}}}}}if(g.length>0&&h.error&&c.isFunction(h.error)){h.error(f,g)}else{if(h.success&&c.isFunction(h.success)){if(h.serialize){f=this.serialize(f)}h.success(f)}}return this},serialize:function(d){var h={},g,e;for(var f in d){if((this.fields[f]!==undefined||"__anything__" in this.fields)&&!c.isFunction(d[f])){if(this.fields[f]&&this.fields[f].type){if(this.fields[f].type=="json"){h[f]=jsPath.js2json(d[f])}else{if(this.fields[f].type=="html"){h[f]=c("<div>").append(c(d[f]).clone()).html()}else{if(this.fields[f].type=="xmllist"){h[f]=d[f].toString()}else{if(this.fields[f].type=="jsam"){g=jsPath("..*",d[f],{resultType:"JSAM",pathStyle:"DOT"});h[f]=[];for(e=0;e<g.length;e++){h[f][e]=g[e]}}}}}}else{h[f]=d[f]}}}return h},deserialize:function(d){var e;return e}});c.each(["create","destroy","metadata","save","add","remove","get","find","js2query","next","previous"],function(d,e){b.Model.prototype[e]=function(f){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.Models);(function(g,k,c){var e;c.Query=function(i){g.extend(true,this,i,{context:"",selectors:[],expressions:[],orderby:{direction:"forward"},limit:0,startPage:0,resultsPerPage:20});e=g.logger("Claypool.Models.Query")};var l=c.Query;g.extend(l.prototype,{items:function(i){if(i&&(typeof i=="string")){this.selectors.push(i)}else{if(i&&i.length&&(i instanceof Array)){g.merge(this.selectors,i)}else{this.selectors.push("*")}}return this},names:function(){return this.items("itemName()")},count:function(){return this.items("count()")},is:function(i){a(this,"=");m(this,i);return this},isnot:function(i){a(this,"!=");m(this,i);return this},islike:function(i){a(this,"~");m(this,i);return this},isnotlike:function(i){a(this,"!~");m(this,i);return this},isgt:function(i){a(this,">");m(this,i);return this},isgte:function(i){a(this,">=");m(this,i);return this},isbetween:function(i){a(this,"><");m(this,i);return this},islte:function(i){a(this,"<=");m(this,i);return this},islt:function(i){a(this,"<");m(this,i);return this},isin:function(i){a(this,"@");m(this,value);return this},isnotin:function(i){a(this,"!@");m(this,value);return this},orderby:function(i){f(this,i);return this},reverseorderby:function(i){f(this,i,"reverse");return this},limit:function(i){this.limit=i},page:function(o,n){if(n){this.count=n}this.startPage=o;return this},next:function(i){this.startPage++;return this},previous:function(i){this.startPage--;return this}});var d=["","like","gt","gte","between","lte","lt"];for(var h=0;h<d.length;h++){l.prototype["where"+d[h]]=function(i){b(this,i,"where","");return this};l.prototype["wherenot"+d[h]]=function(i){b(this,i,"where","not");return this};l.prototype["whereeither"+d[h]]=function(i){b(this,i,"either","");return this};l.prototype["whereneither"+d[h]]=function(i){b(this,i,"either","not");return this};l.prototype["and"+d[h]]=function(i){b(this,i,"and","");return this};l.prototype["andnot"+d[h]]=function(i){b(this,i,"and","not");return this};l.prototype["or"+d[h]]=function(i){b(this,i,"or","");return this};l.prototype["ornot"+d[h]]=function(i){b(this,i,"or","not");return this}}var b=function(o,r,n,i,p){var q=null;i=i?i:"is";if(o&&r&&n&&g.isFunction(o[n])){if(n=="where"){o.expressions=[];n="and"}else{if(n=="whereeither"||n=="whereneither"){o.expressions=[];n="or"}}if(typeof r=="string"){o.expressions.push({name:r,type:n})}else{if(r&&typeof(r)=="object"&&!(r instanceof Array)){for(q in r){if(typeof(r[q])=="string"){if(p){o[n](q)["isnot"+i](r[q])}else{o[n](q)["isnot"+i](r[q])}}else{if(i===""&&r[q]&&r[q].length&&r[q] instanceof Array){if(p){o[n](q).isnotin(r[q])}else{o[n](q).isin(r[q])}}}}}}}};var a=function(n,i){n.expressions[n.expressions.length-1].operator=i};var m=function(n,i){n.expressions[n.expressions.length-1].value=i};var j=function(n,i){n.expressions[n.expressions.length-1].name=i};var f=function(n,i,o){n.orderby={name:i,direction:(o||"forward")}}})(jQuery,Claypool,Claypool.Models);(function(c,a,b){b.Client=function(d){c.extend(true,this,d)};c.each(["create","destroy","metadata","save","add","remove","get","find","js2query","next","previous"],function(d,e){b.Client.prototype[e]=function(f){this.db[e](c.extend(f,{domain:this.name}));return this}})})(jQuery,Claypool,Claypool.Models);(function(e,a,c){var b;c.RestClient=function(g){this.js2json=jsPath&&jsPath.js2json&&e.isFunction(jsPath.js2json)?jsPath.js2json:g.js2json;this.json2js=jsPath&&jsPath.json2js&&e.isFunction(jsPath.json2js)?jsPath.json2js:g.json2js;e.extend(true,this,g);this.resturl=e.env("resturl")?e.env("resturl"):"/rest/";b=e.logger("Claypool.Models.RestClient")};e.extend(c.RestClient.prototype,{create:function(g){e.ajax(e.extend({},g,{type:"PUT",url:this.resturl+this.name+"/",dataType:"json",success:function(h){d("created data domain (%s)",g.success,h)},error:function(j,h,i){f("failed to create data domain",g.error,j,h,i)}}));return this},destroy:function(g){e.ajax(e.extend({},g,{type:"DELETE",url:this.resturl+this.name+"/",dataType:"json",success:function(h){d("destroyed data domain",g.success,h)},error:function(j,h,i){f("failed to destroy data domain",g.error,j,h,i)}}));return this},save:function(g){var h;if(!g.batch&&g.id){if(g.serialize){g.data=this.serialize(g.data)}e.ajax(e.extend({},g,{type:"POST",url:(this.resturl+this.name+"/"+g.id)+(g.add?"?add":""),data:this.js2json(g.data),contentType:"application/json",dataType:"json",processData:false,success:function(i){d("saved data to domain",g.success,i)},error:function(k,i,j){f("failed to save data to domain",g.error,k,i,j)}}))}else{if(g.batch){if(g.serialize){for(h in g.data){g.data[h]=this.serialize(g.data[h])}}e.ajax(e.extend({},g,{type:"POST",url:(this.resturl+this.name+"/")+(g.add?"?add":""),data:this.js2json(g.data),contentType:"application/json",processData:false,dataType:"json",success:function(i){d("saved batch data to domain",g.success,i)},error:function(k,i,j){f("failed to save batch data to domain",g.error,k,i,j)}}))}}return this},add:function(g){this.save(e.extend({},g,{add:true}));return this},remove:function(g){if(g.id){e.ajax(e.extend({},g,{type:"DELETE",url:this.resturl+this.name+"/"+g.id,data:(g.data instanceof Array)?{data:g.data.join(",")}:(g.data instanceof Object)?g.data:null,dataType:"json",success:function(h){d("removed item or item data from domain",g.success,h)},error:function(j,h,i){f("failed to delete item or item data from domain",g.error,j,h,i)}}))}return this},get:function(g){if(g.id&&typeof g.id=="string"){e.ajax(e.extend({},g,{type:"GET",url:this.resturl+this.name+"/"+g.id,dataType:"json",success:function(h){d("retrieved data by id from domain",g.success,h)},error:function(j,h,i){f("failed to retrieved data by id from domain",g.error,j,h,i)}}))}else{if(g.id&&g.id.length){e.ajax(e.extend({},g,{type:"GET",url:this.resturl+this.name+"/",data:{id:g.id.join(",")},dataType:"json",success:function(h){d("successfully for data by ids from domain",g.success,h)},error:function(j,h,i){f("failed to get data by ids from domain",g.error,j,h,i)
}}))}else{e.ajax(e.extend({},g,{type:"GET",url:this.resturl+this.name+"/",dataType:"json",success:function(h){d("loaded list of ids from domain",g.success,h)},error:function(j,h,i){f("failed to list ids from domain ",g.error,j,h,i)}}))}}return this},find:function(g){if(g.select){if(typeof g.select=="object"){if(!(g.select instanceof Query)){g.select=new Query(g.select)}g.select.context=this.name}e.ajax(e.extend({},g,{type:"POST",url:this.resturl,data:(typeof g.select=="string")?g.select:this.js2json(g.select),contentType:(typeof g.select=="string")?"text/plain":"application/json",processData:false,dataType:"json",success:function(h){d("saved item to domain",g.success,h)},error:function(j,h,i){f("failed to save item to domain",g.error,j,h,i)}}))}return this},next:function(g){this.find(query.next(),callback);return this},previous:function(g){this.find(query.previous(),callback);return this}});var d=function(i,j,g,h){b.debug("loaded list of items from domain: %s",g);if(j&&e.isFunction(j)){j(g,h)}};var f=function(j,k,i,g,h){b.error(j+" %s-%s",i.status,g).exception(h);if(k&&e.isFunction(k)){k([{msg:j}],true)}}})(jQuery,Claypool,Claypool.Models);(function(d,a,c){var b;c.Factory=function(g){g=g||{};b=b||d.logger("Claypool.Models.Factory");var f,e;var h=g&&g.dbclient?g.dbclient:d.env("dbclient");if(!h){h="rest"}b.debug("loading database client connection %s",h);if(h=="rest"){h=new c.RestClient(g)}else{if(h=="direct"){f=g&&g.db?g.db:d.env("db");e=g&&g.dbconnection?g.dbconnection:d.env("dbconnection");b.debug("loading database implementation %s",f);if(typeof(f)=="string"){b.debug("resolving database implementation %s",f);f=d.resolve(f)}h=new c.Client(d.extend({db:new f(e)},g))}}return h}})(jQuery,Claypool,Claypool.Models);(function(c,a,b){c.extend(c,{model:function(f,d,e){return new b.Model(f,d,e)},query:function(d){return new b.Query(d)}})})(jQuery,Claypool,Claypool.Models);