Claypool.MVC={};(function(a){a.manage("Claypool.MVC.Container","claypool:MVC",function(b){var e,g,c,d=b.factory.getConfig(),f;for(f in d){b.logger.debug("eagerly loading mvc routers: %s",f);for(e=0;e<d[f].length;e++){g=d[f][e].id;controller=b.get(g);b.logger.debug("attaching mvc core controller: %s",g);if(controller&&!controller.attached){controller.attach();controller.attached=true}}}})})(jQuery);(function(c,a,b){b.View$Interface={update:function(d){throw new a.MethodNotImplementedError()},think:function(){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Controller=function(d){a.extend(this,a.SimpleCachingStrategy);c.extend(true,this,d);this.logger=c.logger("Claypool.MVC.Controller")};c.extend(b.Controller.prototype,a.SimpleCachingStrategy.prototype,{handle:function(d){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.HijaxController=function(d){a.extend(this,b.Controller);c.extend(true,this,{forwardingList:[],selector:"",filter:"",active:true,preventDefault:true,stopPropagation:true,hijaxMap:[],resolveQueue:[],strategy:null},d);this.router=new a.Router();this.bindCache=new a.SimpleCachingStrategy();this.logger=c.logger("Claypool.MVC.HijaxController")};c.extend(b.HijaxController.prototype,b.Controller.prototype,{handle:function(e){this.logger.debug("Handling pattern: %s",e.pattern);this.forwardingList=this.router[this.strategy||"all"](e.pattern);this.logger.debug("Resolving matched paterns");var f=this,d={};if(this.forwardingList.length>0){this.logger.debug("normalizing event state params");if(c.isFunction(this.normalize)){d=this.normalize(e.args[0])}}return jQuery(this.forwardingList).each(function(){var j,h,g;try{f.logger.info("Forwaring to registered controller %s",this.payload.controller);j=c.$(this.payload.controller);g=this.payload.controller.match("Controller")?this.payload.controller.replace("Controller","View"):null;g=this.payload.controller.match("Service")?this.payload.controller.replace("Service","View"):g;this.map=c.extend(d,this.map);(function(r){var n=e.args[0],l=[],k={flash:[],length:0},o=g,s=j;for(var q=1;q<e.args.length;q++){l[q-1]=e.args[q]}var p=c.extend({},n,{m:function(){if(arguments.length===0){return k}else{if(arguments.length===1){if(typeof(arguments[0])=="string"){return k[arguments[0]]}else{if(arguments[0] instanceof Array){k.length+=arguments[0].length;Array.prototype.push.apply(k,arguments[0])}else{if(arguments[0] instanceof Object){c.extend(true,k,arguments[0])}}}}else{if(arguments.length===2){if(arguments[1] instanceof Array){if(typeof(arguments[0])=="string"&&!(arguments[0] in k)){k[arguments[0]]=[]}c.merge(k[arguments[0]],arguments[1])}else{if(arguments[1] instanceof XML||arguments[1] instanceof XMLList){k[arguments[0]]=arguments[1]}else{if(arguments[1] instanceof Object){if(typeof(arguments[0])=="string"&&!(arguments[0] in k)){k[arguments[0]]={}}c.extend(true,k[arguments[0]],arguments[1])}}}}}}return this},v:function(m){if(!m){return o}if(m&&typeof(m)=="string"){m=m.split(".");if(m.length===1){o=m}else{if(m.length===2){if(m[0]!==""){o=m.join(".")}else{o=o.split(".")[0]+"."+m[1]}}}}return this},c:function(){var u,t,m;if(arguments.length===0){return s}else{if(arguments.length>0&&typeof(arguments[0])=="string"){if(arguments.length>1&&c.isPlainObject(arguments[1])){r.map=c.extend(true,r.map||{},arguments[1])}u=arguments[0].split(".");s=u[0];o=s.match("Controller")?s.replace("Controller","View"):null;o=s.match("Service")?s.replace("Service","View"):o;t=(u.length>1&&u[1].length>0)?u[1]:"handle";m=f.find(u[0]);if(m===null){m=c.$(u[0]);f.add(u[0],m)}m[t||"handle"].apply(m,[this].concat(l))}}return this},render:f.renderer(),reset:function(){k={flash:[],length:0};o=g;s=j;return this},params:function(m){if(arguments.length===0){return r.map?r.map:{}}else{return(r.map&&(m in r.map))?r.map[m]:null}}});j[r.payload.action||"handle"].apply(j,[p].concat(l))})(this)}catch(i){i=i?i:new Error();if(i.name&&i.name.indexOf("Claypool.Application.ContextError")>-1){f.logger.warn("No controller with id: %s",this.payload.controller)}else{f.logger.exception(i);throw i}}})},attach:function(){this.router.compile(this.hijaxMap,this.routerKeys);var d=this;if(this.active&&(this.selector!==""||this.filter!=="")){this.logger.debug("Actively Hijaxing %s's %s%s",this.hijaxKey,this.selector,this.filter);c(this.selector+this.filter).livequery(function(){d.hijax(this)})}else{if(this.selector!==""||this.filter!==""){this.logger.debug("Hijaxing Current %s's.",this.hijaxKey);c(this.selector+this.filter).each(function(){d.hijax(this)})}else{if(document!==undefined){this.logger.debug("Hijaxing Document For %s's.",this.hijaxKey);d.hijax(document)}else{this.logger.warn("Unable to attach controller: %s",options.id)}}}},hijax:function(e){this.logger.debug("Hijaxing %s: %s",this.hijaxKey,e);var f=this;var d=function(g){var h=true;f.logger.info("Hijaxing %s: ",f.hijaxKey);if(f.stopPropagation){f.logger.debug("Stopping propogation of event");g.stopPropagation()}if(f.preventDefault){f.logger.debug("Preventing default event behaviour");g.preventDefault();h=false}f.handle({pattern:f.target.apply(f,arguments),args:arguments,normalize:f.normalize?f.normalize:function(){return{}}});return h};if(this.event){c(this.event.split("|")).each(function(){c(e).bind(this+"."+f.eventNamespace,d);f.logger.debug("Binding event %s to hijax controller on target",this,e)})}else{c(this.hijaxMap).each(function(){if(this.event&&!f.bindCache.find(this.event)){f.bindCache.add(this.event,f);f.logger.debug("Binding event %s to controller %s on target %s",this.event,this.controller,e);c(e).bind(this.event+"."+f.eventNamespace,d)}})}return true},renderer:function(){var e=this;var d=[];return function(m){var l,g,j,f,h,i;if(m&&c.isFunction(m)){d.push(m)}e.logger.debug(" - Resolving Control - %s)",this.c());try{f=this.v();h=c.isFunction(this.write)?(c.isFunction(c.render)?"write":"render"):"update";if(f.indexOf(".")>-1){h=f.split(".");f=h[0];h=h[h.length-1]}e.logger.debug("Calling View %s.%s",f,h);f=c.$(f);if(f){if(c.isFunction(f[h])){switch(h){case"write":case"writeln":this[h](f[h](this.m(),this));break;case"render":f.write=this.write;f.writeln=this.writeln;f[h](this.m(),this);break;default:f[h](this.m(),this)}e.logger.debug("Cascading callbacks");while(d.length>0){(d.pop())()}}else{if(f["@claypool:activeobject"]){i="claypool:postcreate:"+f["@claypool:id"]+"."+c.uuid();c(document).bind(i,function(n,o){e.logger.warn("The view is reattached to the dom.");c(document).unbind(i);o.update(this.m());e.logger.debug("Cascading callbacks");while(d.length>0){(d.pop())()}})}else{e.logger.debug("View method cannot be resolve",h)}}}else{e.logger.warn("Cant resolve view %s. ",this.v())}}catch(k){e.logger.error("Error resolving flow %s => %s",this.c(),this.v()).exception(k);throw k}return this}},target:function(d){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Factory=function(d){a.extend(this,a.IoC.Factory);c.extend(true,this,d);this.configurationId="mvc";this.logger=c.logger("Claypool.MVC.Factory");this.add("",new a.SimpleCachingStrategy())};c.extend(b.Factory.prototype,a.IoC.Factory.prototype,{updateConfig:function(){var h,d,g,k,f;try{this.logger.debug("Configuring Claypool MVC Controller Factory");h=this.getConfig()||{};c(document).trigger("claypool:hijax",[this,this.initializeHijaxController,h])}catch(j){this.logger.exception(j);throw new b.ConfigurationError(j)}},scan:function(g,i){var j=this.logger||c.logger("Claypool.MVC.Factory");var f,n,d=[],l,m=function(e,o){return("#"+e.substring(0,1).toLowerCase()+e.substring(1)+o.substring(0,o.length-1))},h=function(e){return("#"+e.substring(0,1).toLowerCase()+e.substring(1))};i=i||"";j.debug("Scanning %s%s",i,g);try{if(g.split(".").length==1){n=c.resolve(g);for(f in n){j.debug("Scan Checking %s.%s",g,f);if(c.isPlainObject(n[f])){j.debug("Scan Following %s.%s",g,f);d.push(this.scan(g+"."+f,i))}}}else{if(g.split(".").length==2){n=c.resolve(g);
for(f in n){j.debug("Scan Checking %s.%s",g,f);if(c.isFunction(n[f])){j.debug("Configuring by Convention %s.%s",g,f);config={id:m(f,g.split(".")[1]),clazz:g+"."+f,namespace:i};if(g.match(".Views")){config.selector=h(f)}d.push(config)}}}else{if(g.split(".").length==3){n=c.resolve(g);if(c.isFunction(n)){j.debug("Appending to Configuration by Convention %s",g);config={id:m(f,g.split(".")[2]),clazz:g,namespace:i};if(g.match(".Views")){config.selector=h(f)}d.push(config)}}}}}catch(k){j.error("Error Scanning %s!!",g).exception(k)}return d},initializeHijaxController:function(h,g,e,d){var j,f;if(h[g]){for(f=0;f<h[g].length;f++){j={};j.id=h[g][f].id;j.clazz=e;j.options=[c.extend(true,{},d,h[g][f])];this.logger.debug("Adding MVC Configuration for Controller Id: %s",j.id);this.find("").add(j.id,j)}}}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Container=function(d){a.extend(this,a.Application.ContextContributor);c.extend(true,this,d);this.factory=null;this.logger=c.logger("Claypool.MVC.Container").debug("Configuring Claypool MVC Container");this.factory=new b.Factory();this.factory.updateConfig()};c.extend(b.Container.prototype,a.Application.ContextContributor.prototype,{get:function(h){var d,f;try{this.logger.debug("Search for a container managed controller : %s",h);f=typeof(h)=="string"&&h.indexOf("#")>-1?[h.split("#")[0],"#"+h.split("#")[1]]:["",h];if(!this.find(f[0])){this.add(f[0],new a.SimpleCachingStrategy())}d=this.find(f[0]).find(f[1]);if(d===undefined||d===null){this.logger.debug("Can't find a container managed controller : %s",h);d=this.factory.create(f[1],f[0]);if(d!==null){this.find(f[0]).add(f[1],d);return d._this}else{return null}}else{this.logger.debug("Found container managed controller : %s",h);return d._this}}catch(g){this.logger.exception(g);throw new b.ContainerError()}throw new b.FactoryError(h)}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.ContainerError=function(d){c.extend(this,new a.Error(d,{name:"Claypool.MVC.ContainerError",message:"An error occurred trying to retreive a container managed object."}))}})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.FactoryError=function(d){c.extend(this,new a.Error(d,{name:"Claypool.MVC.FactoryError",message:"An error occured trying to create the factory object."}))}})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.ConfigurationError=function(d){c.extend(this,new a.ConfigurationError(d,{name:"Claypool.MVC.ConfigurationError",message:"An error occured during the configuration."}))}})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){var c;d.extend(d,{router:function(f,e){d(document).bind("claypool:hijax",function(g,j,h,i){c=c||d.logger("Claypool.MVC.Plugins");c.debug("registering router plugin: %s",f);h.apply(j,[i,f,"Claypool.MVC.HijaxController",e])});return this},mvc:function(){var f,e;if(arguments.length===0){return d.config("mvc")}else{e=d.config("mvc");for(f in arguments[0]){if(f in e){d.merge(e[f],arguments[0][f])}else{e[f]=arguments[0][f]}}return this}}});d.routes=d.mvc;d.router("hijax:a",{selector:"a",event:"click",strategy:"first",routerKeys:"urls",hijaxKey:"link",eventNamespace:"Claypool:MVC:HijaxLinkController",target:function(f){var e=f.target||f.currentTarget;while(e.tagName.toUpperCase()!="A"){e=d(e).parent()[0]}return d(e).attr("href")},normalize:function(g){var f=g.target||g.currentTarget,h={};while(f.tagName.toUpperCase()!="A"){f=d(f).parent()[0]}var e=d(f).attr("href");var i=e.split("?");i=i&&i.length>1?i[1]:"";d(i.split("&")).each(function(l,o){var m=o.split("="),j=m[0],n=m[1],k;if(j in h){if(!d.isArray(h[j])){k=h[j];h[j]=[k]}h[j].push(n)}else{h[j]=n}});return h}}).router("hijax:button",{selector:":button",event:"click",strategy:"all",routerKeys:"ids",hijaxKey:"button",eventNamespace:"Claypool:MVC:HijaxButtonController",target:function(e){return e.target.id},normalize:function(e){return{}}}).router("hijax:input",{selector:"input",event:"blur|focus",strategy:"all",routerKeys:"ids",hijaxKey:"input",eventNamespace:"Claypool:MVC:HijaxInputController",target:function(e){return e.target.id},normalize:function(e){var f={};f[e.target.name]=e.target.value;return f}}).router("hijax:form",{selector:"form",event:"submit",strategy:"first",routerKeys:"urls",hijaxKey:"form",eventNamespace:"Claypool:MVC:HijaxFormController",target:function(e){return e.target.action},normalize:function(e){var g={},f=d(e.target).serializeArray();d(f).each(function(k,h){var j;if(h.name in g){if(!d.isArray(g[h.name])){j=g[h.name];g[h.name]=[]}g[h.name].push(h.value)}else{g[h.name]=h.value}});return g}}).router("hijax:event",{strategy:"all",routerKeys:"event",hijaxKey:"event",eventNamespace:"Claypool:MVC:HijaxEventController",target:function(e){return e.type},normalize:function(e){return{}}});d.mvc_scanner=b.Factory.prototype})(jQuery,Claypool,Claypool.MVC);