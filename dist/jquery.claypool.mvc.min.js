Claypool.MVC={};(function(a){a.manage("Claypool.MVC.Container","claypool:MVC",function(b){var e,g,c,d=b.factory.getConfig(),f;for(f in d){b.logger.debug("eagerly loading mvc routers: %s",f);for(e=0;e<d[f].length;e++){g=d[f][e].id;controller=b.get(g);b.logger.debug("attaching mvc core controller: %s",g);if(controller&&!controller.attached){controller.attach();controller.attached=true}}}})})(jQuery);(function(c,a,b){b.View$Interface={update:function(d){throw"MethodNotImplementedError"},think:function(){throw"MethodNotImplementedError"}}})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Controller=function(d){a.extend(this,a.SimpleCachingStrategy);c.extend(true,this,d);this.logger=c.logger("Claypool.MVC.Controller")};c.extend(b.Controller.prototype,a.SimpleCachingStrategy.prototype,{handle:function(d){throw"MethodNotImplementedError"}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.HijaxController=function(d){a.extend(this,b.Controller);c.extend(true,this,{forwardingList:[],selector:"",filter:"",active:true,preventDefault:true,stopPropagation:true,hijaxMap:[],resolveQueue:[],strategy:null},d);this.router=new a.Router();this.bindCache=new a.SimpleCachingStrategy();this.logger=c.logger("Claypool.MVC.HijaxController")};c.extend(b.HijaxController.prototype,b.Controller.prototype,{handle:function(h){this.logger.debug("Handling pattern: %s",h.pattern);this.forwardingList=this.router[this.strategy||"all"](h.pattern);this.logger.debug("Resolving matched paterns");var j=this,e=h.args[0],d=[],g={};for(var f=1;f<h.args.length;f++){d[f-1]=h.args[f]}if(this.forwardingList.length>0){this.logger.debug("normalizing event state params %s",e);if(c.isFunction(this.normalize)){g=this.normalize(e)}}return jQuery(this.forwardingList).each(function(){var m,l,k,i;j.logger.info("Forwaring to registered controller %s",this.payload.controller);m=c.$(this.payload.controller);i=this.payload.controller;k=this.payload.controller.match("Controller")?this.payload.controller.replace("Controller","View"):null;k=this.payload.controller.match("Service")?this.payload.controller.replace("Service","View"):k;this.map=c.extend(g,this.map);(function(q){var n,o,r,p=c.extend({},e,{m:function(){if(arguments.length===0){return n}else{if(arguments.length===1){if(typeof(arguments[0])=="string"){return n[arguments[0]]}else{if(arguments[0] instanceof Array){n.length+=arguments[0].length;Array.prototype.push.apply(n,arguments[0])}else{if(arguments[0] instanceof Object){c.extend(true,n,arguments[0])}}}}else{if(arguments.length===2){if(arguments[1] instanceof Array){if(typeof(arguments[0])=="string"&&!(arguments[0] in n)){n[arguments[0]]=[]}c.merge(n[arguments[0]],arguments[1])}else{if(arguments[1] instanceof XML||arguments[1] instanceof XMLList){n[arguments[0]]=arguments[1]}else{if(arguments[1] instanceof Object){if(typeof(arguments[0])=="string"&&!(arguments[0] in n)){n[arguments[0]]={}}c.extend(true,n[arguments[0]],arguments[1])}}}}}}return this},v:function(s){if(!s){return o}if(s&&typeof(s)=="string"){s=s.split(".");if(s.length===1){o=s}else{if(s.length===2){if(s[0]!==""){o=s.join(".")}else{o=o.split(".")[0]+"."+s[1]}}}}return this},c:function(){var u,t,s;if(arguments.length===0){return r}else{if(arguments.length>0&&typeof(arguments[0])=="string"){if(arguments.length>1&&c.isPlainObject(arguments[1])){q.map=c.extend(true,q.map||{},arguments[1])}u=arguments[0].split(".");o=u[0].match("Controller")?u[0].replace("Controller","View"):null;o=u[0].match("Service")?u[0].replace("Service","View"):o;t=(u.length>1&&u[1].length>0)?u[1]:"handle";s=j.find(u[0]);if(s===null){s=c.$(u[0]);j.add(u[0],s)}s[t||"handle"].apply(s,[this].concat(d))}}return this},render:j.renderer(),reset:function(){n={flash:[],length:0};o=k;r=i;n.reset=function u(){n={flash:[],length:0};n.reset=u;return p};o.reset=function s(){o=k;o.reset=s;return p};r.reset=function t(){r=i;r.reset=t;return p};return this},params:function(s){if(arguments.length===0){return q.map?q.map:{}}else{return(q.map&&(s in q.map))?q.map[s]:null}}});p.reset();m[q.payload.action||"handle"].apply(m,[p].concat(d))})(this)})},attach:function(){this.router.compile(this.hijaxMap,this.routerKeys);var d=this;if(this.active&&(this.selector!==""||this.filter!=="")){this.logger.debug("Actively Hijaxing %s's %s%s",this.hijaxKey,this.selector,this.filter);c(this.selector+this.filter).livequery(function(){d.hijax(this)})}else{if(this.selector!==""||this.filter!==""){this.logger.debug("Hijaxing Current %s's.",this.hijaxKey);c(this.selector+this.filter).each(function(){d.hijax(this)})}else{if(document!==undefined){this.logger.debug("Hijaxing Document For %s's.",this.hijaxKey);d.hijax(document)}else{this.logger.warn("Unable to attach controller: %s",options.id)}}}},hijax:function(e){this.logger.debug("Hijaxing %s: %s",this.hijaxKey,e);var f=this;var d=function(g){var h=true;f.logger.info("Hijaxing %s: ",f.hijaxKey);if(f.stopPropagation){f.logger.debug("Stopping propogation of event");g.stopPropagation()}if(f.preventDefault){f.logger.debug("Preventing default event behaviour");g.preventDefault();h=false}f.handle({pattern:f.target.apply(f,arguments),args:arguments,normalize:f.normalize?f.normalize:function(){return{}}});return h};if(this.event){c(this.event.split("|")).each(function(){c(e).bind(this+"."+f.eventNamespace,d);f.logger.debug("Binding event %s to hijax controller on target",this,e)})}else{c(this.hijaxMap).each(function(){if(this.event&&!f.bindCache.find(this.event)){f.bindCache.add(this.event,f);f.logger.debug("Binding event %s to controller %s on target %s",this.event,this.controller,e);c(e).bind(this.event+"."+f.eventNamespace,d)}})}return true},renderer:function(){var e=this;var d=[];return function(l){var k,g,j,f,h,i;if(l&&c.isFunction(l)){d.push(l)}e.logger.debug(" - Resolving Control - %s)",this.c());f=this.v();h=c.isFunction(this.write)?(c.isFunction(c.render)?"write":"render"):"update";if(f.indexOf(".")>-1){h=f.split(".");f=h[0];h=h[h.length-1]}e.logger.debug("Calling View %s.%s",f,h);f=c.$(f);if(f){if(c.isFunction(f[h])){switch(h){case"write":case"writeln":this[h](f[h](this.m(),this));break;case"render":f.write=this.write;f.writeln=this.writeln;f[h](this.m(),this);break;default:f[h](this.m(),this)}e.logger.debug("Cascading callbacks");while(d.length>0){(d.pop())()}}else{if(f["@claypool:activeobject"]){i="claypool:postcreate:"+f["@claypool:id"]+"."+a.uuid();c(document).bind(i,function(m,n){e.logger.warn("The view is reattached to the dom.");c(document).unbind(i);n.update(this.m());e.logger.debug("Cascading callbacks");while(d.length>0){(d.pop())()}})}else{e.logger.debug("View method cannot be resolve",h)}}}else{e.logger.warn("Cant resolve view %s. ",this.v())}return this}},target:function(d){throw"MethodNotImplementedError"}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Factory=function(d){a.extend(this,a.IoC.Factory);c.extend(true,this,d);this.configurationId="mvc";this.logger=c.logger("Claypool.MVC.Factory");this.add("",new a.SimpleCachingStrategy())};c.extend(b.Factory.prototype,a.IoC.Factory.prototype,{updateConfig:function(){var g,d,f,h,e;this.logger.debug("Configuring Claypool MVC Controller Factory");g=this.getConfig()||{};c(document).trigger("claypool:hijax",[this,this.initializeHijaxController,g])},scan:function(f,h){var i=this.logger||c.logger("Claypool.MVC.Factory");var e,l,d=[],j,k=function(m,n){return("#"+m.substring(0,1).toLowerCase()+m.substring(1)+n.substring(0,n.length-1))},g=function(m){return("#"+m.substring(0,1).toLowerCase()+m.substring(1))};h=h||"";i.debug("Scanning %s%s",h,f);if(f.split(".").length==1){l=c.resolve(f);for(e in l){i.debug("Scan Checking %s.%s",f,e);if(c.isPlainObject(l[e])){i.debug("Scan Following %s.%s",f,e);d.push(this.scan(f+"."+e,h))}}}else{if(f.split(".").length==2){l=c.resolve(f);for(e in l){i.debug("Scan Checking %s.%s",f,e);if(c.isFunction(l[e])){i.debug("Configuring by Convention %s.%s",f,e);config={id:k(e,f.split(".")[1]),clazz:f+"."+e,namespace:h};if(f.match(".Views")){config.selector=g(e)}d.push(config)}}}else{if(f.split(".").length==3){l=c.resolve(f);
if(c.isFunction(l)){i.debug("Appending to Configuration by Convention %s",f);config={id:k(e,f.split(".")[2]),clazz:f,namespace:h};if(f.match(".Views")){config.selector=g(e)}d.push(config)}}}}return d},initializeHijaxController:function(h,g,e,d){var j,f;if(h[g]){for(f=0;f<h[g].length;f++){j={};j.id=h[g][f].id;j.clazz=e;j.options=[c.extend(true,{},d,h[g][f])];this.logger.debug("Adding MVC Configuration for Controller Id: %s",j.id);this.find("").add(j.id,j)}}}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Container=function(d){a.extend(this,a.Application.ContextContributor);c.extend(true,this,d);this.factory=null;this.logger=c.logger("Claypool.MVC.Container").debug("Configuring Claypool MVC Container");this.factory=new b.Factory();this.factory.updateConfig()};c.extend(b.Container.prototype,a.Application.ContextContributor.prototype,{get:function(f){var d,e;this.logger.debug("Search for a container managed controller : %s",f);e=typeof(f)=="string"&&f.indexOf("#")>-1?[f.split("#")[0],"#"+f.split("#")[1]]:["",f];if(!this.find(e[0])){this.add(e[0],new a.SimpleCachingStrategy())}d=this.find(e[0]).find(e[1]);if(d===undefined||d===null){this.logger.debug("Can't find a container managed controller : %s",f);d=this.factory.create(e[1],e[0]);if(d!==null){this.find(e[0]).add(e[1],d);return d._this}else{return null}}else{this.logger.debug("Found container managed controller : %s",f);return d._this}throw ("UnknownID:"+f)}})})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){var c;d.extend(d,{router:function(f,e){d(document).bind("claypool:hijax",function(g,j,h,i){c=c||d.logger("Claypool.MVC.Plugins");c.debug("registering router plugin: %s",f);h.apply(j,[i,f,"Claypool.MVC.HijaxController",e])});return this},mvc:function(){var f,e;if(arguments.length===0){return d.config("mvc")}else{e=d.config("mvc");for(f in arguments[0]){if(f in e){d.merge(e[f],arguments[0][f])}else{e[f]=arguments[0][f]}}return this}}});d.routes=d.mvc;d.router("hijax:a",{selector:"a",event:"click",strategy:"first",routerKeys:"urls",hijaxKey:"link",eventNamespace:"Claypool:MVC:HijaxLinkController",target:function(f){var e=f.target||f.currentTarget;while(e.tagName.toUpperCase()!="A"){e=d(e).parent()[0]}return d(e).attr("href")},normalize:function(g){var f=g.target||g.currentTarget,h={};while(f.tagName.toUpperCase()!="A"){f=d(f).parent()[0]}var e=d(f).attr("href");var i=e.split("?");i=i&&i.length>1?i[1]:"";d(i.split("&")).each(function(l,o){var m=o.split("="),j=m[0],n=m[1],k;if(j in h){if(!d.isArray(h[j])){k=h[j];h[j]=[k]}h[j].push(n)}else{h[j]=n}});return h}}).router("hijax:button",{selector:":button",event:"click",strategy:"all",routerKeys:"ids",hijaxKey:"button",eventNamespace:"Claypool:MVC:HijaxButtonController",target:function(e){return e.target.id},normalize:function(e){return{}}}).router("hijax:input",{selector:"input",event:"blur|focus",strategy:"all",routerKeys:"ids",hijaxKey:"input",eventNamespace:"Claypool:MVC:HijaxInputController",target:function(e){return e.target.id},normalize:function(e){var f={};f[e.target.name]=e.target.value;return f}}).router("hijax:form",{selector:"form",event:"submit",strategy:"first",routerKeys:"urls",hijaxKey:"form",eventNamespace:"Claypool:MVC:HijaxFormController",target:function(e){return e.target.action},normalize:function(e){var g={},f=d(e.target).serializeArray();d(f).each(function(k,h){var j;if(h.name in g){if(!d.isArray(g[h.name])){j=g[h.name];g[h.name]=[]}g[h.name].push(h.value)}else{g[h.name]=h.value}});return g}}).router("hijax:event",{strategy:"all",routerKeys:"event",hijaxKey:"event",eventNamespace:"Claypool:MVC:HijaxEventController",target:function(e){return e.type},normalize:function(e){return{}}});d.mvc_scanner=b.Factory.prototype})(jQuery,Claypool,Claypool.MVC);