Claypool.MVC={};(function(a){a.manage("Claypool.MVC.Container","claypool:MVC",function(b){var e,g,c,d=b.factory.getConfig(),f;for(f in d){b.logger.debug("eagerly loading mvc routers: %s",f);for(e=0;e<d[f].length;e++){g=d[f][e].id;controller=b.get(g);b.logger.debug("attaching mvc core controller: %s",g);if(controller&&!controller.attached){controller.attach();controller.attached=true}}}})})(jQuery);(function(c,a,b){b.View$Interface={update:function(d){throw new a.MethodNotImplementedError()},think:function(){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Controller=function(d){a.extend(this,a.SimpleCachingStrategy);c.extend(true,this,d);this.logger=c.logger("Claypool.MVC.Controller")};c.extend(b.Controller.prototype,a.SimpleCachingStrategy.prototype,{handle:function(d){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.HijaxController=function(d){a.extend(this,b.Controller);c.extend(true,this,{forwardingList:[],selector:"",filter:"",active:true,preventDefault:true,stopPropagation:true,hijaxMap:[],resolveQueue:[],strategy:null},d);this.router=new a.Router();this.bindCache=new a.SimpleCachingStrategy();this.logger=c.logger("Claypool.MVC.HijaxController")};c.extend(b.HijaxController.prototype,b.Controller.prototype,{handle:function(h){this.logger.debug("Handling pattern: %s",h.pattern);this.forwardingList=this.router[this.strategy||"all"](h.pattern);this.logger.debug("Resolving matched paterns");var j=this,e=h.args[0],d=[],g={};for(var f=1;f<h.args.length;f++){d[f-1]=h.args[f]}if(this.forwardingList.length>0){this.logger.debug("normalizing event state params %s",e);if(c.isFunction(this.normalize)){g=this.normalize(e)}}return jQuery(this.forwardingList).each(function(){var n,l,k,i;try{j.logger.info("Forwaring to registered controller %s",this.payload.controller);n=c.$(this.payload.controller);i=this.payload.controller;k=this.payload.controller.match("Controller")?this.payload.controller.replace("Controller","View"):null;k=this.payload.controller.match("Service")?this.payload.controller.replace("Service","View"):k;this.map=c.extend(g,this.map);(function(r){var o,p,s,q=c.extend({},e,{m:function(){if(arguments.length===0){return o}else{if(arguments.length===1){if(typeof(arguments[0])=="string"){return o[arguments[0]]}else{if(arguments[0] instanceof Array){o.length+=arguments[0].length;Array.prototype.push.apply(o,arguments[0])}else{if(arguments[0] instanceof Object){c.extend(true,o,arguments[0])}}}}else{if(arguments.length===2){if(arguments[1] instanceof Array){if(typeof(arguments[0])=="string"&&!(arguments[0] in o)){o[arguments[0]]=[]}c.merge(o[arguments[0]],arguments[1])}else{if(arguments[1] instanceof XML||arguments[1] instanceof XMLList){o[arguments[0]]=arguments[1]}else{if(arguments[1] instanceof Object){if(typeof(arguments[0])=="string"&&!(arguments[0] in o)){o[arguments[0]]={}}c.extend(true,o[arguments[0]],arguments[1])}}}}}}return this},v:function(t){if(!t){return p}if(t&&typeof(t)=="string"){t=t.split(".");if(t.length===1){p=t}else{if(t.length===2){if(t[0]!==""){p=t.join(".")}else{p=p.split(".")[0]+"."+t[1]}}}}return this},c:function(){var v,u,t;if(arguments.length===0){return s}else{if(arguments.length>0&&typeof(arguments[0])=="string"){if(arguments.length>1&&c.isPlainObject(arguments[1])){r.map=c.extend(true,r.map||{},arguments[1])}v=arguments[0].split(".");p=v[0].match("Controller")?v[0].replace("Controller","View"):null;p=v[0].match("Service")?v[0].replace("Service","View"):p;u=(v.length>1&&v[1].length>0)?v[1]:"handle";t=j.find(v[0]);if(t===null){t=c.$(v[0]);j.add(v[0],t)}t[u||"handle"].apply(t,[this].concat(d))}}return this},render:j.renderer(),reset:function(){o={flash:[],length:0};p=k;s=i;o.reset=function v(){o={flash:[],length:0};o.reset=v;return q};p.reset=function t(){p=k;p.reset=t;return q};s.reset=function u(){s=i;s.reset=u;return q};return this},params:function(t){if(arguments.length===0){return r.map?r.map:{}}else{return(r.map&&(t in r.map))?r.map[t]:null}}});q.reset();n[r.payload.action||"handle"].apply(n,[q].concat(d))})(this)}catch(m){m=m?m:new Error();if(m.name&&m.name.indexOf("Claypool.Application.ContextError")>-1){j.logger.warn("No controller with id: %s",this.payload.controller)}else{j.logger.exception(m);throw m}}})},attach:function(){this.router.compile(this.hijaxMap,this.routerKeys);var d=this;if(this.active&&(this.selector!==""||this.filter!=="")){this.logger.debug("Actively Hijaxing %s's %s%s",this.hijaxKey,this.selector,this.filter);c(this.selector+this.filter).livequery(function(){d.hijax(this)})}else{if(this.selector!==""||this.filter!==""){this.logger.debug("Hijaxing Current %s's.",this.hijaxKey);c(this.selector+this.filter).each(function(){d.hijax(this)})}else{if(document!==undefined){this.logger.debug("Hijaxing Document For %s's.",this.hijaxKey);d.hijax(document)}else{this.logger.warn("Unable to attach controller: %s",options.id)}}}},hijax:function(e){this.logger.debug("Hijaxing %s: %s",this.hijaxKey,e);var f=this;var d=function(g){var h=true;f.logger.info("Hijaxing %s: ",f.hijaxKey);if(f.stopPropagation){f.logger.debug("Stopping propogation of event");g.stopPropagation()}if(f.preventDefault){f.logger.debug("Preventing default event behaviour");g.preventDefault();h=false}f.handle({pattern:f.target.apply(f,arguments),args:arguments,normalize:f.normalize?f.normalize:function(){return{}}});return h};if(this.event){c(this.event.split("|")).each(function(){c(e).bind(this+"."+f.eventNamespace,d);f.logger.debug("Binding event %s to hijax controller on target",this,e)})}else{c(this.hijaxMap).each(function(){if(this.event&&!f.bindCache.find(this.event)){f.bindCache.add(this.event,f);f.logger.debug("Binding event %s to controller %s on target %s",this.event,this.controller,e);c(e).bind(this.event+"."+f.eventNamespace,d)}})}return true},renderer:function(){var e=this;var d=[];return function(m){var l,g,j,f,h,i;if(m&&c.isFunction(m)){d.push(m)}e.logger.debug(" - Resolving Control - %s)",this.c());try{f=this.v();h=c.isFunction(this.write)?(c.isFunction(c.render)?"write":"render"):"update";if(f.indexOf(".")>-1){h=f.split(".");f=h[0];h=h[h.length-1]}e.logger.debug("Calling View %s.%s",f,h);f=c.$(f);if(f){if(c.isFunction(f[h])){switch(h){case"write":case"writeln":this[h](f[h](this.m(),this));break;case"render":f.write=this.write;f.writeln=this.writeln;f[h](this.m(),this);break;default:f[h](this.m(),this)}e.logger.debug("Cascading callbacks");while(d.length>0){(d.pop())()}}else{if(f["@claypool:activeobject"]){i="claypool:postcreate:"+f["@claypool:id"]+"."+c.uuid();c(document).bind(i,function(n,o){e.logger.warn("The view is reattached to the dom.");c(document).unbind(i);o.update(this.m());e.logger.debug("Cascading callbacks");while(d.length>0){(d.pop())()}})}else{e.logger.debug("View method cannot be resolve",h)}}}else{e.logger.warn("Cant resolve view %s. ",this.v())}}catch(k){e.logger.error("Error resolving flow %s => %s",this.c(),this.v()).exception(k);throw k}return this}},target:function(d){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Factory=function(d){a.extend(this,a.IoC.Factory);c.extend(true,this,d);this.configurationId="mvc";this.logger=c.logger("Claypool.MVC.Factory");this.add("",new a.SimpleCachingStrategy())};c.extend(b.Factory.prototype,a.IoC.Factory.prototype,{updateConfig:function(){var h,d,g,k,f;try{this.logger.debug("Configuring Claypool MVC Controller Factory");h=this.getConfig()||{};c(document).trigger("claypool:hijax",[this,this.initializeHijaxController,h])}catch(j){this.logger.exception(j);throw new b.ConfigurationError(j)}},scan:function(g,i){var j=this.logger||c.logger("Claypool.MVC.Factory");var f,n,d=[],l,m=function(e,o){return("#"+e.substring(0,1).toLowerCase()+e.substring(1)+o.substring(0,o.length-1))},h=function(e){return("#"+e.substring(0,1).toLowerCase()+e.substring(1))};i=i||"";j.debug("Scanning %s%s",i,g);try{if(g.split(".").length==1){n=c.resolve(g);for(f in n){j.debug("Scan Checking %s.%s",g,f);
if(c.isPlainObject(n[f])){j.debug("Scan Following %s.%s",g,f);d.push(this.scan(g+"."+f,i))}}}else{if(g.split(".").length==2){n=c.resolve(g);for(f in n){j.debug("Scan Checking %s.%s",g,f);if(c.isFunction(n[f])){j.debug("Configuring by Convention %s.%s",g,f);config={id:m(f,g.split(".")[1]),clazz:g+"."+f,namespace:i};if(g.match(".Views")){config.selector=h(f)}d.push(config)}}}else{if(g.split(".").length==3){n=c.resolve(g);if(c.isFunction(n)){j.debug("Appending to Configuration by Convention %s",g);config={id:m(f,g.split(".")[2]),clazz:g,namespace:i};if(g.match(".Views")){config.selector=h(f)}d.push(config)}}}}}catch(k){j.error("Error Scanning %s!!",g).exception(k)}return d},initializeHijaxController:function(h,g,e,d){var j,f;if(h[g]){for(f=0;f<h[g].length;f++){j={};j.id=h[g][f].id;j.clazz=e;j.options=[c.extend(true,{},d,h[g][f])];this.logger.debug("Adding MVC Configuration for Controller Id: %s",j.id);this.find("").add(j.id,j)}}}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Container=function(d){a.extend(this,a.Application.ContextContributor);c.extend(true,this,d);this.factory=null;this.logger=c.logger("Claypool.MVC.Container").debug("Configuring Claypool MVC Container");this.factory=new b.Factory();this.factory.updateConfig()};c.extend(b.Container.prototype,a.Application.ContextContributor.prototype,{get:function(h){var d,f;try{this.logger.debug("Search for a container managed controller : %s",h);f=typeof(h)=="string"&&h.indexOf("#")>-1?[h.split("#")[0],"#"+h.split("#")[1]]:["",h];if(!this.find(f[0])){this.add(f[0],new a.SimpleCachingStrategy())}d=this.find(f[0]).find(f[1]);if(d===undefined||d===null){this.logger.debug("Can't find a container managed controller : %s",h);d=this.factory.create(f[1],f[0]);if(d!==null){this.find(f[0]).add(f[1],d);return d._this}else{return null}}else{this.logger.debug("Found container managed controller : %s",h);return d._this}}catch(g){this.logger.exception(g);throw new b.ContainerError()}throw new b.FactoryError(h)}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.ContainerError=function(d){c.extend(this,new a.Error(d,{name:"Claypool.MVC.ContainerError",message:"An error occurred trying to retreive a container managed object."}))}})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.FactoryError=function(d){c.extend(this,new a.Error(d,{name:"Claypool.MVC.FactoryError",message:"An error occured trying to create the factory object."}))}})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.ConfigurationError=function(d){c.extend(this,new a.ConfigurationError(d,{name:"Claypool.MVC.ConfigurationError",message:"An error occured during the configuration."}))}})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){var c;d.extend(d,{router:function(f,e){d(document).bind("claypool:hijax",function(g,j,h,i){c=c||d.logger("Claypool.MVC.Plugins");c.debug("registering router plugin: %s",f);h.apply(j,[i,f,"Claypool.MVC.HijaxController",e])});return this},mvc:function(){var f,e;if(arguments.length===0){return d.config("mvc")}else{e=d.config("mvc");for(f in arguments[0]){if(f in e){d.merge(e[f],arguments[0][f])}else{e[f]=arguments[0][f]}}return this}}});d.routes=d.mvc;d.router("hijax:a",{selector:"a",event:"click",strategy:"first",routerKeys:"urls",hijaxKey:"link",eventNamespace:"Claypool:MVC:HijaxLinkController",target:function(f){var e=f.target||f.currentTarget;while(e.tagName.toUpperCase()!="A"){e=d(e).parent()[0]}return d(e).attr("href")},normalize:function(g){var f=g.target||g.currentTarget,h={};while(f.tagName.toUpperCase()!="A"){f=d(f).parent()[0]}var e=d(f).attr("href");var i=e.split("?");i=i&&i.length>1?i[1]:"";d(i.split("&")).each(function(l,o){var m=o.split("="),j=m[0],n=m[1],k;if(j in h){if(!d.isArray(h[j])){k=h[j];h[j]=[k]}h[j].push(n)}else{h[j]=n}});return h}}).router("hijax:button",{selector:":button",event:"click",strategy:"all",routerKeys:"ids",hijaxKey:"button",eventNamespace:"Claypool:MVC:HijaxButtonController",target:function(e){return e.target.id},normalize:function(e){return{}}}).router("hijax:input",{selector:"input",event:"blur|focus",strategy:"all",routerKeys:"ids",hijaxKey:"input",eventNamespace:"Claypool:MVC:HijaxInputController",target:function(e){return e.target.id},normalize:function(e){var f={};f[e.target.name]=e.target.value;return f}}).router("hijax:form",{selector:"form",event:"submit",strategy:"first",routerKeys:"urls",hijaxKey:"form",eventNamespace:"Claypool:MVC:HijaxFormController",target:function(e){return e.target.action},normalize:function(e){var g={},f=d(e.target).serializeArray();d(f).each(function(k,h){var j;if(h.name in g){if(!d.isArray(g[h.name])){j=g[h.name];g[h.name]=[]}g[h.name].push(h.value)}else{g[h.name]=h.value}});return g}}).router("hijax:event",{strategy:"all",routerKeys:"event",hijaxKey:"event",eventNamespace:"Claypool:MVC:HijaxEventController",target:function(e){return e.type},normalize:function(e){return{}}});d.mvc_scanner=b.Factory.prototype})(jQuery,Claypool,Claypool.MVC);