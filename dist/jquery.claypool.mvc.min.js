Claypool.MVC={};(function(a){a.manage("Claypool.MVC.Container","claypool:MVC",function(b){var e,g,c,d=b.factory.getConfig(),f;for(f in d){b.logger.debug("eagerly loading mvc routers: %s",f);for(e=0;e<d[f].length;e++){g=d[f][e].id;controller=b.get(g);b.logger.debug("attaching mvc core controller: %s",g);if(controller&&!controller.attached){controller.attach();controller.attached=true}}}})})(jQuery);(function(c,a,b){b.View$Interface={update:function(d){throw new a.MethodNotImplementedError()},think:function(){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Controller=function(d){this.model=null;this.view=null;a.extend(this,a.SimpleCachingStrategy);c.extend(true,this,d);this.logger=c.logger("Claypool.MVC.Controller")};c.extend(b.Controller.prototype,a.SimpleCachingStrategy.prototype,{handle:function(d){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.HijaxController=function(d){a.extend(this,b.Controller);c.extend(true,this,{forwardingList:[],selector:"",filter:"",active:true,preventDefault:true,stopPropagation:true,hijaxMap:[],resolveQueue:[],strategy:null},d);this.router=new a.Router();this.bindCache=new a.SimpleCachingStrategy();this.logger=c.logger("Claypool.MVC.HijaxController")};c.extend(b.HijaxController.prototype,b.Controller.prototype,{handle:function(d){this.logger.debug("Handling pattern: %s",d.pattern);this.forwardingList=this.router[this.strategy||"all"](d.pattern);this.logger.debug("Resolving matched paterns");var e=this;return jQuery(this.forwardingList).each(function(){var i,g,f;try{e.logger.info("Forwaring to registered controller %s",this.payload.controller);i=c.$(this.payload.controller);f=this.payload.controller.match("Controller")?this.payload.controller.replace("Controller","View"):null;f=this.payload.controller.match("Service")?this.payload.controller.replace("Service","View"):f;(function(q){var l=d.args[0],k=[],j={flash:[],length:0},n=f,r=i;for(var p=1;p<d.args.length;p++){k[p-1]=d.args[p]}var o=c.extend({},l,{m:function(){if(arguments.length===0){return j}else{if(arguments.length===1){if(typeof(arguments[0])=="string"){return j[arguments[0]]}else{if(arguments[0] instanceof Array){j.length+=arguments[0].length;Array.prototype.push.apply(j,arguments[0])}else{if(arguments[0] instanceof Object){c.extend(true,j,arguments[0])}}}}else{if(arguments.length===2){if(arguments[1] instanceof Array){if(typeof(arguments[0])=="string"&&!(arguments[0] in j)){j[arguments[0]]=[]}c.merge(j[arguments[0]],arguments[1])}else{if(arguments[1] instanceof XML||arguments[1] instanceof XMLList){j[arguments[0]]=arguments[1]}else{if(arguments[1] instanceof Object){if(typeof(arguments[0])=="string"&&!(arguments[0] in j)){j[arguments[0]]={}}c.extend(true,j[arguments[0]],arguments[1])}}}}}}return this},v:function(m){if(!m){return n}if(m&&typeof(m)=="string"){m=m.split(".");if(m.length===1){n=m}else{if(m.length===2){if(m[0]!==""){n=m.join(".")}else{n=n.split(".")[0]+"."+m[1]}}}}return this},c:function(){var t,s,m;if(arguments.length===0){return r}else{if(arguments.length>0&&typeof(arguments[0]=="string")){t=arguments[0].split(".");r=t[0];n=r.match("Controller")?r.replace("Controller","View"):null;n=r.match("Service")?r.replace("Service","View"):n;s=(t.length>1&&t[1].length>0)?t[1]:"handle";m=e.find(t[0]);if(m===null){m=c.$(t[0]);e.add(t[0],m)}m[s||"handle"].apply(m,[this].concat(k))}}return this},render:e.renderer(),reset:function(){j={flash:[],length:0};n=f;r=i;return this},params:function(m){if(arguments.length===0){return q.map?q.map:{}}else{return q.map&&q.map[m]?q.map[m]:null}}});i[q.payload.action||"handle"].apply(i,[o].concat(k))})(this)}catch(h){h=h?h:new Error();if(h.name&&h.name.indexOf("Claypool.Application.ContextError")>-1){e.logger.warn("No controller with id: %s",this.payload.controller)}else{e.logger.exception(h);throw h}}})},attach:function(){this.router.compile(this.hijaxMap,this.routerKeys);var d=this;if(this.active&&(this.selector!==""||this.filter!=="")){this.logger.debug("Actively Hijaxing %s's %s%s",this.hijaxKey,this.selector,this.filter);c(this.selector+this.filter).livequery(function(){d.hijax(this)})}else{if(this.selector!==""||this.filter!==""){this.logger.debug("Hijaxing Current %s's.",this.hijaxKey);c(this.selector+this.filter).each(function(){d.hijax(this)})}else{if(document!==undefined){this.logger.debug("Hijaxing Document For %s's.",this.hijaxKey);d.hijax(document)}else{this.logger.warn("Unable to attach controller: %s",options.id)}}}},hijax:function(e){this.logger.debug("Hijaxing %s: %s",this.hijaxKey,e);var f=this;var d=function(g){var h=true;f.logger.info("Hijaxing %s: ",f.hijaxKey);if(f.stopPropagation){f.logger.debug("Stopping propogation of event");g.stopPropagation()}if(f.preventDefault){f.logger.debug("Preventing default event behaviour");g.preventDefault();h=false}f.handle({pattern:f.target.apply(f,arguments),args:arguments});return h};if(this.event){c(this.event.split("|")).each(function(){c(e).bind(this+"."+f.eventNamespace,d);f.logger.debug("Binding event %s to hijax controller on target",this,e)})}else{c(this.hijaxMap).each(function(){if(this.event&&!f.bindCache.find(this.event)){f.bindCache.add(this.event,f);f.logger.debug("Binding event %s to controller %s on target %s",this.event,this.controller,e);c(e).bind(this.event+"."+f.eventNamespace,d)}})}return true},renderer:function(){var e=this;var d=[];return function(m){var l,g,j,f,h,i;if(m&&c.isFunction(m)){d.push(m)}e.logger.debug(" - Resolving Control - %s)",this.c());try{f=this.v();h=c.isFunction(this.write)?"render":"update";if(f.indexOf(".")>-1){h=f.split(".");f=h[0];h=h[h.length-1]}e.logger.debug("Calling View %s.%s",f,h);f=c.$(f);if(f){if(c.isFunction(f[h])){if(this.write){f.write=this.write;f.append=this.append;f[h](this.m())}else{f[h](this.m())}e.logger.debug("Cascading callbacks");while(d.length>0){(d.pop())()}}else{if(f["@claypool:activeobject"]){i="claypool:postcreate:"+f["@claypool:id"]+"."+c.guid();c(document).bind(i,function(n,o){e.logger.warn("The view is reattached to the dom.");c(document).unbind(i);o.update(this.m());e.logger.debug("Cascading callbacks");while(d.length>0){(d.pop())()}})}else{e.logger.debug("View method cannot be resolve",h)}}}else{e.logger.warn("Cant resolve view %s. ",this.v())}}catch(k){e.logger.error("Error resolving flow %s => %s",this.c(),this.v()).exception(k);throw k}return this}},target:function(d){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Factory=function(d){a.extend(this,a.IoC.Factory);c.extend(true,this,d);this.configurationId="mvc";this.logger=c.logger("Claypool.MVC.Factory")};c.extend(b.Factory.prototype,a.IoC.Factory.prototype,{updateConfig:function(){var h,d,g,k,f;try{this.logger.debug("Configuring Claypool MVC Controller Factory");h=this.getConfig()||{};c(document).trigger("claypool:hijax",[this,this.initializeHijaxController,h])}catch(j){this.logger.exception(j);throw new b.ConfigurationError(j)}},scan:function(h){var j=this.logger||c.logger("Claypool.MVC.Factory");j.debug("Scanning %s",h);var l,g,i=[],f=function(e,m){return("#"+e.substring(0,1).toLowerCase()+e.substring(1)+m)},d=function(e){return("#"+e.substring(0,1).toLowerCase()+e.substring(1))};try{g=c.resolve(h);for(l in g){j.debug("Scan Checking %s.%s",h,l);if(c.isFunction(g[l])){j.debug("Found Function Definition on %s.%s",h,l);if(h.match(".Models")){j.debug("Configuring by Convention %s.%s",h,l);i.push({id:f(l,"Model"),clazz:h+"."+l})}else{if(h.match(".Views")){j.debug("Configuring by Convention %s.%s",h,l);i.push({id:f(l,"View"),clazz:h+"."+l,selector:d(l)})}else{if(h.match(".Controllers")){j.debug("Configuring by Convention %s.%s",h,l);i.push({id:f(l,"Controller"),clazz:h+"."+l})}else{if(h.match(".Services")){j.debug("Configuring by Convention %s.%s",h,l);i.push({id:f(l,"Service"),clazz:h+"."+l})}}}}}}}catch(k){j.error("Error Scanning %s!!",h).exception(k)}return i},initializeHijaxController:function(h,g,e,d){var j,f;
if(h[g]){for(f=0;f<h[g].length;f++){j={};j.id=h[g][f].id;j.clazz=e;j.options=[c.extend(true,{},d,h[g][f])];this.logger.debug("Adding MVC Configuration for Controller Id: %s",j.id);this.add(j.id,j)}}}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.Container=function(d){a.extend(this,a.Application.ContextContributor);c.extend(true,this,d);this.factory=null;this.logger=c.logger("Claypool.MVC.Container").debug("Configuring Claypool MVC Container");this.factory=new b.Factory();this.factory.updateConfig()};c.extend(b.Container.prototype,a.Application.ContextContributor.prototype,{get:function(g){var d;try{this.logger.debug("Search for a container managed controller : %s",g);d=this.find(g);if(d===undefined||d===null){this.logger.debug("Can't find a container managed controller : %s",g);d=this.factory.create(g);if(d!==null){this.add(g,d);return d._this}else{return null}}else{this.logger.debug("Found container managed controller : %s",g);return d._this}}catch(f){this.logger.exception(f);throw new b.ContainerError()}throw new b.FactoryError(g)}})})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.ContainerError=function(d){c.extend(this,new a.Error(d,{name:"Claypool.MVC.ContainerError",message:"An error occurred trying to retreive a container managed object."}))}})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.FactoryError=function(d){c.extend(this,new a.Error(d,{name:"Claypool.MVC.FactoryError",message:"An error occured trying to create the factory object."}))}})(jQuery,Claypool,Claypool.MVC);(function(c,a,b){b.ConfigurationError=function(d){c.extend(this,new a.ConfigurationError(d,{name:"Claypool.MVC.ConfigurationError",message:"An error occured during the configuration."}))}})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){var c;d.extend(d,{router:function(f,e){d(document).bind("claypool:hijax",function(g,j,h,i){c=c||d.logger("Claypool.MVC.Plugins");c.debug("registering router plugin: %s",f);h.apply(j,[i,f,"Claypool.MVC.HijaxController",e])});return this},mvc:function(){var f,e;if(arguments.length===0){return d.config("mvc")}else{e=d.config("mvc");for(f in arguments[0]){if(f in e){d.merge(e[f],arguments[0][f])}else{e[f]=arguments[0][f]}}return this}}});d.routes=d.mvc;d.router("hijax:a",{selector:"a",event:"click",strategy:"first",routerKeys:"urls",hijaxKey:"link",eventNamespace:"Claypool:MVC:HijaxLinkController",target:function(f){var e=f.target||f.currentTarget;while(e.tagName.toUpperCase()!="A"){e=d(e).parent()[0]}return d(e).attr("href")}}).router("hijax:button",{selector:":button",event:"click",strategy:"all",routerKeys:"ids",hijaxKey:"button",eventNamespace:"Claypool:MVC:HijaxButtonController",target:function(e){return e.target.id}}).router("hijax:input",{selector:"input",event:"blur|focus",strategy:"all",routerKeys:"ids",hijaxKey:"input",eventNamespace:"Claypool:MVC:HijaxInputController",target:function(e){return e.target.id}}).router("hijax:form",{selector:"form",event:"submit",strategy:"first",routerKeys:"urls",hijaxKey:"form",eventNamespace:"Claypool:MVC:HijaxFormController",target:function(e){return e.target.action}}).router("hijax:event",{strategy:"all",routerKeys:"event",hijaxKey:"event",eventNamespace:"Claypool:MVC:HijaxEventController",target:function(e){return e.type}});d.mvc_scanner=b.Factory.prototype})(jQuery,Claypool,Claypool.MVC);