Claypool.MVC={};(function(a){a.manage("Claypool.MVC.Container","claypool:MVC",function(b){var f,h,d,e=b.factory.getConfig(),g;for(g in e){b.logger.debug("eagerly loading mvc routers: %s",g);for(f=0;f<e[g].length;f++){h=e[g][f].id;controller=b.get(h);b.logger.debug("attaching mvc core controller: %s",h);if(controller&&!controller.attached){controller.attach();controller.attached=true}}}})})(jQuery);(function(d,a,b){b.View$Interface={update:function(e){throw new a.MethodNotImplementedError()},think:function(){throw new a.MethodNotImplementedError()}}})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){b.Controller=function(e){a.extend(this,a.SimpleCachingStrategy);d.extend(true,this,e);this.logger=d.logger("Claypool.MVC.Controller")};d.extend(b.Controller.prototype,a.SimpleCachingStrategy.prototype,{handle:function(e){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){b.HijaxController=function(e){a.extend(this,b.Controller);d.extend(true,this,{forwardingList:[],selector:"",filter:"",active:true,preventDefault:true,stopPropagation:true,hijaxMap:[],resolveQueue:[],strategy:null},e);this.router=new a.Router();this.bindCache=new a.SimpleCachingStrategy();this.logger=d.logger("Claypool.MVC.HijaxController")};d.extend(b.HijaxController.prototype,b.Controller.prototype,{handle:function(f){this.logger.debug("Handling pattern: %s",f.pattern);this.forwardingList=this.router[this.strategy||"all"](f.pattern);this.logger.debug("Resolving matched paterns");var g=this,e={};if(this.forwardingList.length>0){this.logger.debug("normalizing event state params");if(d.isFunction(this.normalize)){e=this.normalize(f.args[0])}}return jQuery(this.forwardingList).each(function(){var l,j,i,h;try{g.logger.info("Forwaring to registered controller %s",this.payload.controller);l=d.$(this.payload.controller);h=this.payload.controller;i=this.payload.controller.match("Controller")?this.payload.controller.replace("Controller","View"):null;i=this.payload.controller.match("Service")?this.payload.controller.replace("Service","View"):i;this.map=d.extend(e,this.map);(function(r){var o=f.args[0],n=[];for(var q=1;q<f.args.length;q++){n[q-1]=f.args[q]}var p=d.extend({},o,{m:function(){if(arguments.length===0){return m}else{if(arguments.length===1){if(typeof(arguments[0])=="string"){return m[arguments[0]]}else{if(arguments[0] instanceof Array){m.length+=arguments[0].length;Array.prototype.push.apply(m,arguments[0])}else{if(arguments[0] instanceof Object){d.extend(true,m,arguments[0])}}}}else{if(arguments.length===2){if(arguments[1] instanceof Array){if(typeof(arguments[0])=="string"&&!(arguments[0] in m)){m[arguments[0]]=[]}d.merge(m[arguments[0]],arguments[1])}else{if(arguments[1] instanceof XML||arguments[1] instanceof XMLList){m[arguments[0]]=arguments[1]}else{if(arguments[1] instanceof Object){if(typeof(arguments[0])=="string"&&!(arguments[0] in m)){m[arguments[0]]={}}d.extend(true,m[arguments[0]],arguments[1])}}}}}}return this},v:function(s){if(!s){return v}if(s&&typeof(s)=="string"){s=s.split(".");if(s.length===1){v=s}else{if(s.length===2){if(s[0]!==""){v=s.join(".")}else{v=v.split(".")[0]+"."+s[1]}}}}return this},c:function(){var u,t,s;if(arguments.length===0){return c}else{if(arguments.length>0&&typeof(arguments[0])=="string"){if(arguments.length>1&&d.isPlainObject(arguments[1])){r.map=d.extend(true,r.map||{},arguments[1])}u=arguments[0].split(".");v=u[0].match("Controller")?u[0].replace("Controller","View"):null;v=u[0].match("Service")?u[0].replace("Service","View"):v;t=(u.length>1&&u[1].length>0)?u[1]:"handle";s=g.find(u[0]);if(s===null){s=d.$(u[0]);g.add(u[0],s)}s[t||"handle"].apply(s,[this].concat(n))}}return this},render:g.renderer(),reset:function(){m={flash:[],length:0};v=i;c=h;m.reset=function u(){m={flash:[],length:0};m.reset=u;return p};v.reset=function s(){v=i;v.reset=s;return p};c.reset=function t(){c=h;c.reset=t;return p};return this},params:function(s){if(arguments.length===0){return r.map?r.map:{}}else{return(r.map&&(s in r.map))?r.map[s]:null}}});p.reset();l[r.payload.action||"handle"].apply(l,[p].concat(n))})(this)}catch(k){k=k?k:new Error();if(k.name&&k.name.indexOf("Claypool.Application.ContextError")>-1){g.logger.warn("No controller with id: %s",this.payload.controller)}else{g.logger.exception(k);throw k}}})},attach:function(){this.router.compile(this.hijaxMap,this.routerKeys);var e=this;if(this.active&&(this.selector!==""||this.filter!=="")){this.logger.debug("Actively Hijaxing %s's %s%s",this.hijaxKey,this.selector,this.filter);d(this.selector+this.filter).livequery(function(){e.hijax(this)})}else{if(this.selector!==""||this.filter!==""){this.logger.debug("Hijaxing Current %s's.",this.hijaxKey);d(this.selector+this.filter).each(function(){e.hijax(this)})}else{if(document!==undefined){this.logger.debug("Hijaxing Document For %s's.",this.hijaxKey);e.hijax(document)}else{this.logger.warn("Unable to attach controller: %s",options.id)}}}},hijax:function(f){this.logger.debug("Hijaxing %s: %s",this.hijaxKey,f);var g=this;var e=function(h){var i=true;g.logger.info("Hijaxing %s: ",g.hijaxKey);if(g.stopPropagation){g.logger.debug("Stopping propogation of event");h.stopPropagation()}if(g.preventDefault){g.logger.debug("Preventing default event behaviour");h.preventDefault();i=false}g.handle({pattern:g.target.apply(g,arguments),args:arguments,normalize:g.normalize?g.normalize:function(){return{}}});return i};if(this.event){d(this.event.split("|")).each(function(){d(f).bind(this+"."+g.eventNamespace,e);g.logger.debug("Binding event %s to hijax controller on target",this,f)})}else{d(this.hijaxMap).each(function(){if(this.event&&!g.bindCache.find(this.event)){g.bindCache.add(this.event,g);g.logger.debug("Binding event %s to controller %s on target %s",this.event,this.controller,f);d(f).bind(this.event+"."+g.eventNamespace,e)}})}return true},renderer:function(){var f=this;var e=[];return function(o){var n,h,k,g,i,j;if(o&&d.isFunction(o)){e.push(o)}f.logger.debug(" - Resolving Control - %s)",this.c());try{g=this.v();i=d.isFunction(this.write)?(d.isFunction(d.render)?"write":"render"):"update";if(g.indexOf(".")>-1){i=g.split(".");g=i[0];i=i[i.length-1]}f.logger.debug("Calling View %s.%s",g,i);g=d.$(g);if(g){if(d.isFunction(g[i])){switch(i){case"write":case"writeln":this[i](g[i](this.m(),this));break;case"render":g.write=this.write;g.writeln=this.writeln;g[i](this.m(),this);break;default:g[i](this.m(),this)}f.logger.debug("Cascading callbacks");while(e.length>0){(e.pop())()}}else{if(g["@claypool:activeobject"]){j="claypool:postcreate:"+g["@claypool:id"]+"."+d.uuid();d(document).bind(j,function(p,q){f.logger.warn("The view is reattached to the dom.");d(document).unbind(j);q.update(this.m());f.logger.debug("Cascading callbacks");while(e.length>0){(e.pop())()}})}else{f.logger.debug("View method cannot be resolve",i)}}}else{f.logger.warn("Cant resolve view %s. ",this.v())}}catch(l){f.logger.error("Error resolving flow %s => %s",this.c(),this.v()).exception(l);throw l}return this}},target:function(e){throw new a.MethodNotImplementedError()}})})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){b.Factory=function(e){a.extend(this,a.IoC.Factory);d.extend(true,this,e);this.configurationId="mvc";this.logger=d.logger("Claypool.MVC.Factory");this.add("",new a.SimpleCachingStrategy())};d.extend(b.Factory.prototype,a.IoC.Factory.prototype,{updateConfig:function(){var j,f,h,l,g;try{this.logger.debug("Configuring Claypool MVC Controller Factory");j=this.getConfig()||{};d(document).trigger("claypool:hijax",[this,this.initializeHijaxController,j])}catch(k){this.logger.exception(k);throw new b.ConfigurationError(k)}},scan:function(h,j){var k=this.logger||d.logger("Claypool.MVC.Factory");var g,p,f=[],n,o=function(e,q){return("#"+e.substring(0,1).toLowerCase()+e.substring(1)+q.substring(0,q.length-1))},i=function(e){return("#"+e.substring(0,1).toLowerCase()+e.substring(1))};j=j||"";k.debug("Scanning %s%s",j,h);try{if(h.split(".").length==1){p=d.resolve(h);for(g in p){k.debug("Scan Checking %s.%s",h,g);
if(d.isPlainObject(p[g])){k.debug("Scan Following %s.%s",h,g);f.push(this.scan(h+"."+g,j))}}}else{if(h.split(".").length==2){p=d.resolve(h);for(g in p){k.debug("Scan Checking %s.%s",h,g);if(d.isFunction(p[g])){k.debug("Configuring by Convention %s.%s",h,g);config={id:o(g,h.split(".")[1]),clazz:h+"."+g,namespace:j};if(h.match(".Views")){config.selector=i(g)}f.push(config)}}}else{if(h.split(".").length==3){p=d.resolve(h);if(d.isFunction(p)){k.debug("Appending to Configuration by Convention %s",h);config={id:o(g,h.split(".")[2]),clazz:h,namespace:j};if(h.match(".Views")){config.selector=i(g)}f.push(config)}}}}}catch(l){k.error("Error Scanning %s!!",h).exception(l)}return f},initializeHijaxController:function(j,h,f,e){var k,g;if(j[h]){for(g=0;g<j[h].length;g++){k={};k.id=j[h][g].id;k.clazz=f;k.options=[d.extend(true,{},e,j[h][g])];this.logger.debug("Adding MVC Configuration for Controller Id: %s",k.id);this.find("").add(k.id,k)}}}})})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){b.Container=function(e){a.extend(this,a.Application.ContextContributor);d.extend(true,this,e);this.factory=null;this.logger=d.logger("Claypool.MVC.Container").debug("Configuring Claypool MVC Container");this.factory=new b.Factory();this.factory.updateConfig()};d.extend(b.Container.prototype,a.Application.ContextContributor.prototype,{get:function(i){var f,g;try{this.logger.debug("Search for a container managed controller : %s",i);g=typeof(i)=="string"&&i.indexOf("#")>-1?[i.split("#")[0],"#"+i.split("#")[1]]:["",i];if(!this.find(g[0])){this.add(g[0],new a.SimpleCachingStrategy())}f=this.find(g[0]).find(g[1]);if(f===undefined||f===null){this.logger.debug("Can't find a container managed controller : %s",i);f=this.factory.create(g[1],g[0]);if(f!==null){this.find(g[0]).add(g[1],f);return f._this}else{return null}}else{this.logger.debug("Found container managed controller : %s",i);return f._this}}catch(h){this.logger.exception(h);throw new b.ContainerError()}throw new b.FactoryError(i)}})})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){b.ContainerError=function(f){d.extend(this,new a.Error(f,{name:"Claypool.MVC.ContainerError",message:"An error occurred trying to retreive a container managed object."}))}})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){b.FactoryError=function(f){d.extend(this,new a.Error(f,{name:"Claypool.MVC.FactoryError",message:"An error occured trying to create the factory object."}))}})(jQuery,Claypool,Claypool.MVC);(function(d,a,b){b.ConfigurationError=function(f){d.extend(this,new a.ConfigurationError(f,{name:"Claypool.MVC.ConfigurationError",message:"An error occured during the configuration."}))}})(jQuery,Claypool,Claypool.MVC);(function(e,a,b){var d;e.extend(e,{router:function(g,f){e(document).bind("claypool:hijax",function(h,k,i,j){d=d||e.logger("Claypool.MVC.Plugins");d.debug("registering router plugin: %s",g);i.apply(k,[j,g,"Claypool.MVC.HijaxController",f])});return this},mvc:function(){var g,f;if(arguments.length===0){return e.config("mvc")}else{f=e.config("mvc");for(g in arguments[0]){if(g in f){e.merge(f[g],arguments[0][g])}else{f[g]=arguments[0][g]}}return this}}});e.routes=e.mvc;e.router("hijax:a",{selector:"a",event:"click",strategy:"first",routerKeys:"urls",hijaxKey:"link",eventNamespace:"Claypool:MVC:HijaxLinkController",target:function(g){var f=g.target||g.currentTarget;while(f.tagName.toUpperCase()!="A"){f=e(f).parent()[0]}return e(f).attr("href")},normalize:function(h){var g=h.target||h.currentTarget,i={};while(g.tagName.toUpperCase()!="A"){g=e(g).parent()[0]}var f=e(g).attr("href");var j=f.split("?");j=j&&j.length>1?j[1]:"";e(j.split("&")).each(function(n,q){var o=q.split("="),k=o[0],p=o[1],l;if(k in i){if(!e.isArray(i[k])){l=i[k];i[k]=[l]}i[k].push(p)}else{i[k]=p}});return i}}).router("hijax:button",{selector:":button",event:"click",strategy:"all",routerKeys:"ids",hijaxKey:"button",eventNamespace:"Claypool:MVC:HijaxButtonController",target:function(f){return f.target.id},normalize:function(f){return{}}}).router("hijax:input",{selector:"input",event:"blur|focus",strategy:"all",routerKeys:"ids",hijaxKey:"input",eventNamespace:"Claypool:MVC:HijaxInputController",target:function(f){return f.target.id},normalize:function(f){var g={};g[f.target.name]=f.target.value;return g}}).router("hijax:form",{selector:"form",event:"submit",strategy:"first",routerKeys:"urls",hijaxKey:"form",eventNamespace:"Claypool:MVC:HijaxFormController",target:function(f){return f.target.action},normalize:function(f){var h={},g=e(f.target).serializeArray();e(g).each(function(l,j){var k;if(j.name in h){if(!e.isArray(h[j.name])){k=h[j.name];h[j.name]=[]}h[j.name].push(j.value)}else{h[j.name]=j.value}});return h}}).router("hijax:event",{strategy:"all",routerKeys:"event",hijaxKey:"event",eventNamespace:"Claypool:MVC:HijaxEventController",target:function(f){return f.type},normalize:function(f){return{}}});e.mvc_scanner=b.Factory.prototype})(jQuery,Claypool,Claypool.MVC);