Claypool.Server={};(function(d,a,c){var b;d.router("hijax:server",{event:"claypool:serve",strategy:"first",routerKeys:"urls",hijaxKey:"request",eventNamespace:"Claypool:Server:HijaxServerController",target:function(g,f,e){b=b||d.logger("Claypool.Server");b.debug("targeting request event");g.request=f;g.response=e;g.write=function(h){b.debug("writing response.body : %s",h);e.body=h+"";return this};g.writeln=function(h){b.debug("writing line to response.body : %s",h);e.body+=h+"";return this};return f.requestURL+""},normalize:function(e){return d.extend({},e.request.parameters,{parameters:e.request.parameters,method:e.request.method,headers:d.extend(e.response.headers,e.request.headers)})}});a.Services={}})(jQuery,Claypool,Claypool.Server);(function(c,a,b){b.Servlet=function(d){a.extend(this,a.MVC.Controller);c.extend(true,this,d);this.logger=c.logger("Claypool.Server.Servlet")};c.extend(b.Servlet.prototype,a.MVC.Controller.prototype,{handle:function(d){var e=d.params("method").toUpperCase();d.params("headers").status=200;this.logger.debug("Handling %s request",e);switch(e){case"GET":this.handleGet(d,d.response);break;case"POST":this.handlePost(d,d.response);break;case"PUT":this.handlePut(d,d.response);break;case"DELETE":this.handleDelete(d,d.response);break;case"HEAD":this.handleHead(d,d.response);break;case"OPTIONS":this.handleOptions(d,d.response);break;default:this.logger.debug("Unknown Method: %s, rendering error response.",e);this.handleError(d,"Unknown Method: "+e,new Error())}},handleGet:function(d){throw new a.MethodNotImplementedError()},handlePost:function(d){throw new a.MethodNotImplementedError()},handlePut:function(d){throw new a.MethodNotImplementedError()},handleDelete:function(d){throw new a.MethodNotImplementedError()},handleHead:function(d){throw new a.MethodNotImplementedError()},handleOptions:function(d){throw new a.MethodNotImplementedError()},handleError:function(d,g,f){this.logger.warn("The default error response should be overriden");d.headers.status=300;d.response.body=g?g:"Unknown internal error\n";d.response.body+=f&&f.msg?f.msg+"":(f?f+"":"\nUnpsecified Error.")}})})(jQuery,Claypool,Claypool.Server);(function(e,b,d,g){var c;g.RestServlet=function(h){b.extend(this,g.Servlet);e.extend(true,this,d.Factory(h));c=e.logger("Claypool.Server.RestServlet");this.js2json=e.js2json&&e.isFunction(e.js2json)?e.js2json:h.js2json;this.json2js=e.json2js&&e.isFunction(e.json2js)?e.json2js:h.json2js};e.extend(g.RestServlet.prototype,g.Servlet.prototype,{handleGet:function(j){var m=this,k=j.params("domain"),l=j.params("id"),i=l?l.split(","):[],h;c.debug("Handling GET for %s %s",k,l);if(!k&&!l){this.db.get({async:false,success:function(n){a(j,n,m)},error:function(n){f(j,n,m)}})}else{if(k&&(i.length>1||!l)){c.debug("Handling GET for %s %s",k,l);if(i.length>1){this.db.get({id:i,domain:k,async:false,success:function(n){a(j,n,m)},error:function(n){f(j,n,m)}})}else{c.debug("getting list of item ids for domain %s",k,l);c.error("GET IDS: %s",e.js2json(j.request.parameters,null,""));this.db.get(e.extend({domain:k,async:false,success:function(n){a(j,n,m)},error:function(n){f(j,n,m)}},j.request.parameters))}}else{if(k&&l&&l!="metadata"){this.db.get({domain:k,id:l,async:false,dataType:"text",success:function(n){a(j,n,m)},error:function(n){f(j,n,m)}})}else{if(k&&l&&l=="metadata"){this.db.metadata({domain:k,id:l,async:false,dataType:"text",success:function(n){a(j,n,m)},error:function(n){f(j,n,m)}})}}}}},handlePost:function(j){var n=this,l=j.params("domain"),m=j.params("id"),i,h,k;c.debug("Handling POST for %s %s",l,m).debug("Reading POST body %s",j.body);if(l&&m){c.debug("saving single object",j.request.body);i=this.json2js(j.request.body);this.db.save({domain:l,id:m,data:i,async:false,replace:("update" in j.request.parameters)?false:true,success:function(o){a(j,o,n)},error:function(o){f(j,o,n)}})}else{if(l&&!m){c.debug("saving array of objects (bulk save)");h=this.json2js(j.request.body);this.db.save({domain:l,data:h,async:false,batch:true,replace:("update" in j.request.parameters)?false:true,success:function(o){a(j,o,n)},error:function(o){f(j,o,n)}})}else{if(!l&&!m){k=j.request.body;if(j.request.contentType.match("application/json")){k=this.json2js(k)}c.debug("executing query \n%s",k);this.db.find({select:k,async:false,success:function(o){a(j,o,n)},error:function(o){f(j,o,n)}})}}}},handlePut:function(h){var j=this,i=h.params("domain");c.debug("Handling PUT for %s %s",i);if(i){this.db.create({domain:i,async:false,success:function(k){a(h,k,j)},error:function(k){f(h,k,j)}})}},handleDelete:function(h){var k=this,i=h.params("domain"),j=h.params("id");c.debug("Handling DELETE for %s %s",i,j);if(i&&j){this.db.remove({domain:i,id:j,async:false,success:function(l){a(h,l,k)},error:function(l){f(h,l,k)}})}else{if(i&&!j){this.db.destroy({domain:i,async:false,success:function(l){a(h,l,k)},error:function(l){f(h,l,k)}})}}}});var a=function(j,i,k){var h=k.js2json(i,null,"   ");c.debug("succeeded. %s",h);j.response.headers={status:200,"Content-Type":"text/javascript; charset=utf-8"};j.response.body=h};var f=function(j,i,k){var h=k.js2json(i,null,"    ");c.error("failed. %s",h);j.response.headers={status:i.code?i.code:500,"Content-Type":"text/javascript; charset=utf-8"};j.response.body=h?h:"{'error':{'code'  : 500,'type'  : 'UnknownClaypoolRestError','msg'   : 'unknown error, check network'}}"}})(jQuery,Claypool,Claypool.Models,Claypool.Server);(function(d,a,c){var b;c.WebProxyServlet=function(f){a.extend(this,c.Servlet);this.rewriteMap=null;d.extend(true,this,f);b=d.logger("Claypool.Server.WebProxyServlet");this.router=new a.Router();this.strategy=this.strategy||"first";b.debug("Compiling url rewrites %s.",this.rewriteMap);this.router.compile(this.rewriteMap,"urls")};d.extend(c.WebProxyServlet.prototype,c.Servlet.prototype,{handleGet:function(i,g){var h=e.route(request,this);var f=h.proxyURL,j=h.params;if(f&&f.length&&f.length>0){b.debug("Proxying get request to: %s",f[0].payload.rewrite);d.ajax({type:"GET",dataType:"text",async:false,data:j,url:f[0].payload.rewrite+"",beforeSend:function(k){e.beforeSend(i.request,g,k)},success:function(k){e.success(g,k)},error:function(m,k,l){e.error(g,m,k,l)},complete:function(l,k){e.complete(g,f,l,k)}})}return g},handlePost:function(i,g){var h=e.route(i.request,this);var f=h.proxyURL,j=h.params;if(f&&f.length&&f.length>0){b.debug("Proxying post request to: %s",f[0].payload.rewrite);d.ajax({type:"POST",dataType:"text",async:false,data:j,url:f[0].payload.rewrite+"",beforeSend:function(k){e.beforeSend(i.request,g,k)},success:function(k){e.success(g,k)},error:function(m,k,l){e.error(g,m,k,l)},complete:function(l,k){e.complete(g,f,l,k)}})}return g}});var e={route:function(i,h){b.debug("Handling proxy: %s",i.requestURI);var g=h.router[h.strategy||"all"](i.requestURI);i.headers["Claypool-Proxy"]=h.proxyHost||"127.0.0.1";var j={};for(var k in i.parameters){b.debug("request.parameters[%s]=%s",k,i.parameters[k]);j[k+""]=i.parameters[k]+""}var f=(i.body&&i.body.length)?i.body:"";return{proxyURL:g,params:j,body:f}},beforeSend:function(g,f,h){b.debug("Copying Request headers for Proxied Request");for(var i in g.headers){b.debug("Setting proxied request header %s: %s",i,g.headers[i]);h.setRequestHeader(i,g.headers[i])}f.headers={}},success:function(f,g){b.debug("Got response for proxy \n %s.",g);f.body=g+""},error:function(g,i,f,h){b.error("Error proxying request. STATUS: %s",f?f:"UNKNOWN");if(h){b.exception(h)}g.body=i.responseText+""},complete:function(h,l,o,j){b.debug("Proxy Request Complete, Copying response headers");var f=o.getAllResponseHeaders();var g;var m;b.debug("Complete Proxy response header: \n %s",f);f=f.split("\r\n");for(var k=0;k<f.length;k++){m=f[k].split(":");try{b.debug("setting response header %s %s",m[0],m.join(":"));h.headers[m.shift()]=m.join(":")}catch(n){b.warn("Unable to set a proxied response header");b.exception(n)}}b.debug("response status (%s)",o.status);h.headers.status=Number(o.status);h.headers["Claypool-Proxy"]=l[0].payload.rewrite+"";
h.headers["Content-Encoding"]=l[0].payload.contentEncoding||"";h.headers["Transfer-Encoding"]=l[0].payload.transferEncoding||"";if(l[0].payload.contentType){h.headers["Content-Type"]=l[0].payload.contentType+""}}}})(jQuery,Claypool,Claypool.Server);(function(d,b,e){var c,a;e.Manage=function(f){d.extend(true,this,f);c=d.logger("Claypool.Services.Manage");a=b.Models.Factory()};d.extend(e.Manage.prototype,{handle:function(f){var h=f.params("command"),g=f.params("target");c.debug("handling command %s %s",h,g);b.Commands[h](g,f);if(("reset"==h)||("syncdb"==h)){c.debug("forwarding to rest service");f.response.headers={status:302,Location:"/rest/"}}}});d.extend(true,b.Commands,{reset:function(g){var f;a.get({async:false,success:function(h){f=h.domains;c.debug("loaded domains")},error:function(j,h,i){c.error("failed to get db domains")}});d(f).each(function(h,i){a.destroy({domain:i,async:false,success:function(j){c.info("destroyed domain %s",i)},error:function(l,j,k){c.error("failed to delete domain %s",i)}})})},syncdb:function(f){var i,g=d.env("initialdata")+"dump.json?"+d.uuid(),h;c.info("loading initial data from %s",g);d.ajax({type:"get",async:false,url:g,dataType:"text",success:function(j){i=d.json2js(j);c.info("loaded initial data")},error:function(l,j,k){c.error("failed [%s] to load initial data %s",j,k)}});for(h in i){a.create({domain:h,async:false,success:function(j){c.info("created domain %s",h)}});a.save({async:false,batch:true,domain:h,data:i[h],success:function(){c.info("batch save successful %s ",h)},error:function(){c.error("batch save failed %s",h)}})}},dumpdata:function(g,h){var i={};var f;a.get({async:false,success:function(j){f=j.domains;c.debug("loaded domains")},error:function(l,j,k){c.error("failed to get db domains")}});d(f).each(function(j,k){a.find({select:"new Query('"+k+"')",async:false,success:function(l){c.info("found %s entries in %s",l.data.length,k);i[k]=l.data},error:function(n,l,m){ok(false,"failed load entries from %s",k)}})});h.write(d.js2json(i,null,"    "));h.response.headers={status:200,"Content-Type":"application/json"}}})})(jQuery,Claypool,Claypool.Services);(function(c,a,b){})(jQuery,Claypool,Claypool.Server);(function(e,b,d){var c,a;e.extend(e,{serve:function(g,f){var i;c=c||e.logger("Claypool.Server");c.info("Handling global request routing for request: %s ",g.requestURL).debug("Dispatching request to Server Sevlet Container");f.headers={};e.extend(f.headers,{"Content-Type":"text/html; charset=utf-8",status:-1});f.body="";try{c.debug("serving request event");e(document).trigger("claypool:serve",[g,f]);c.debug("finished serving request event");if(f.headers.status===-1){f.headers.status=200;if(!f.body){f.headers.status=404;f.body="<html><head></head><body><h1>jQuery-Claypool Server Error</h1>";f.body+="<p>Not Found :\n\t"+g.requestURL+"</p></body></html>"}}}catch(h){c.error("Error Handling Request.").exception(h);f.headers["Content-Type"]="text/html; charset=utf-8";f.headers.status=500;f.body="<html><head></head><body><h1>jQuery-Claypool Server Error</h1>";f.body+="<h2>Error Details</h2>";for(i in h){f.body+="<strong>"+i+"</strong><br/><span>"+h[i]+"</span><br/>"}f.body+="<h2>General Request Details</h2>";for(i in g){f.body+="<strong>"+i+"</strong><br/><span>"+g[i]+"</span><br/>"}f.body+="<h2>Request Header Details</h2>";for(i in g.headers){f.body+="<strong>"+i+"</strong><br/><span>"+g.headers[i]+"</span><br/>"}f.body+="</body></html>"}},servlet:function(f){c=c||e.logger("Claypool.Server");c.debug("Applying servlet pattern to %s",f);b.extend(f,d.Servlet)},proxy:function(f){return e.invert([{id:f.id||"proxy_"+e.uuid(),clazz:"Claypool.Server.WebProxyServlet",options:[{rewriteMap:f.rewrites}]}])}});ClaypoolServerHandler=e.serve})(jQuery,Claypool,Claypool.Server);